# N8N é…ç½®æ–‡ä»¶è¯¦è§£

## ğŸ“‹ ç›®å½•

- [Docker Compose é…ç½®](#docker-compose-é…ç½®)
- [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
- [éƒ¨ç½²è„šæœ¬é…ç½®](#éƒ¨ç½²è„šæœ¬é…ç½®)
- [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
- [æ€§èƒ½ä¼˜åŒ–é…ç½®](#æ€§èƒ½ä¼˜åŒ–é…ç½®)
- [ç›‘æ§é…ç½®](#ç›‘æ§é…ç½®)
- [å¤‡ä»½é…ç½®](#å¤‡ä»½é…ç½®)

---

## ğŸ³ Docker Compose é…ç½®

### ä¸»é…ç½®æ–‡ä»¶ï¼šdocker-compose.yml

#### æœåŠ¡æ¶æ„è¯´æ˜

```yaml
version: '3.8'  # Docker Compose ç‰ˆæœ¬

# ç½‘ç»œé…ç½®
networks:
  n8n-network:
    driver: bridge  # ä½¿ç”¨æ¡¥æ¥ç½‘ç»œæ¨¡å¼
    ipam:
      config:
        - subnet: 172.20.0.0/16  # è‡ªå®šä¹‰å­ç½‘ï¼Œé¿å…IPå†²çª

# æ•°æ®å·é…ç½®
volumes:
  n8n_data:        # N8N åº”ç”¨æ•°æ®
  postgres_data:   # PostgreSQL æ•°æ®åº“æ•°æ®
  redis_data:      # Redis ç¼“å­˜æ•°æ®
```

#### N8N ä¸»æœåŠ¡é…ç½®

```yaml
services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-main
    restart: unless-stopped  # å®¹å™¨å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
    
    # ç«¯å£æ˜ å°„
    ports:
      - "${N8N_PORT:-5678}:5678"  # ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤5678
    
    # ç¯å¢ƒå˜é‡
    environment:
      # åŸºç¡€é…ç½®
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - N8N_HOST=${DOMAIN_NAME:-localhost}
      - N8N_PORT=5678
      
      # æ•°æ®åº“é…ç½®
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      
      # æ‰§è¡Œé…ç½®
      - EXECUTIONS_MODE=queue  # ä½¿ç”¨é˜Ÿåˆ—æ¨¡å¼æé«˜æ€§èƒ½
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
    
    # æ•°æ®å·æŒ‚è½½
    volumes:
      - n8n_data:/home/node/.n8n  # N8N æ•°æ®ç›®å½•
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker socketï¼ˆå¯é€‰ï¼‰
    
    # æœåŠ¡ä¾èµ–
    depends_on:
      postgres:
        condition: service_healthy  # ç­‰å¾…æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡
      redis:
        condition: service_started
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    networks:
      - n8n-network
```

#### PostgreSQL æ•°æ®åº“é…ç½®

```yaml
  postgres:
    image: postgres:15-alpine  # ä½¿ç”¨è½»é‡çº§Alpineç‰ˆæœ¬
    container_name: n8n-postgres
    restart: unless-stopped
    
    # ç¯å¢ƒå˜é‡
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    
    # æ•°æ®å·
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    
    # ç«¯å£æ˜ å°„ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    ports:
      - "5432:5432"  # ç”Ÿäº§ç¯å¢ƒå»ºè®®ç§»é™¤
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # æ€§èƒ½ä¼˜åŒ–
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
    
    networks:
      - n8n-network
```

#### Redis ç¼“å­˜é…ç½®

```yaml
  redis:
    image: redis:7-alpine
    container_name: n8n-redis
    restart: unless-stopped
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    
    # æ•°æ®å·
    volumes:
      - redis_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    
    networks:
      - n8n-network
```

#### Nginx åå‘ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰

```yaml
  nginx:
    image: nginx:alpine
    container_name: n8n-nginx
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    
    depends_on:
      - n8n
    
    networks:
      - n8n-network
```

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### .env æ–‡ä»¶è¯¦è§£

#### åŸºç¡€ç½‘ç»œé…ç½®

```bash
# ===========================================
# åŸºç¡€ç½‘ç»œé…ç½®
# ===========================================

# ä¸»åŸŸåé…ç½®
DOMAIN_NAME=your-domain.com
# è¯´æ˜ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®é™…åŸŸåï¼Œå¼€å‘ç¯å¢ƒå¯ä½¿ç”¨ localhost

# å­åŸŸåé…ç½®
SUBDOMAIN=n8n
# è¯´æ˜ï¼šå®Œæ•´è®¿é—®åœ°å€ä¸º https://n8n.your-domain.com

# åè®®é…ç½®
N8N_PROTOCOL=https
# é€‰é¡¹ï¼šhttpï¼ˆå¼€å‘ç¯å¢ƒï¼‰/ httpsï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

# ç«¯å£é…ç½®
N8N_PORT=5678
# è¯´æ˜ï¼šN8N Webç•Œé¢è®¿é—®ç«¯å£ï¼Œé»˜è®¤5678

# ç¼–è¾‘å™¨åŸºç¡€URL
N8N_EDITOR_BASE_URL=https://${SUBDOMAIN}.${DOMAIN_NAME}
# è¯´æ˜ï¼šç”¨äºç”Ÿæˆå·¥ä½œæµåˆ†äº«é“¾æ¥å’ŒWebhook URL
```

#### ç”¨æˆ·è®¤è¯é…ç½®

```bash
# ===========================================
# ç”¨æˆ·è®¤è¯é…ç½®
# ===========================================

# åŸºç¡€è®¤è¯å¼€å…³
N8N_BASIC_AUTH_ACTIVE=true
# è¯´æ˜ï¼šå¯ç”¨åéœ€è¦ç”¨æˆ·åå¯†ç æ‰èƒ½è®¿é—®N8Nç•Œé¢

# åŸºç¡€è®¤è¯ç”¨æˆ·å
N8N_BASIC_AUTH_USER=admin
# è¯´æ˜ï¼šç®¡ç†å‘˜ç”¨æˆ·åï¼Œå»ºè®®ä½¿ç”¨å¤æ‚ç”¨æˆ·å

# åŸºç¡€è®¤è¯å¯†ç 
N8N_BASIC_AUTH_PASSWORD=your_secure_password_here
# å®‰å…¨è¦æ±‚ï¼šè‡³å°‘12ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦

# ç”¨æˆ·ç®¡ç†JWTå¯†é’¥
N8N_USER_MANAGEMENT_JWT_SECRET=your_jwt_secret_key_here
# å®‰å…¨è¦æ±‚ï¼šè‡³å°‘32ä½éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºJWTä»¤ç‰Œç­¾å

# JWTä»¤ç‰Œè¿‡æœŸæ—¶é—´
N8N_USER_MANAGEMENT_JWT_DURATION_HOURS=168
# è¯´æ˜ï¼šJWTä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œå•ä½å°æ—¶ï¼Œé»˜è®¤7å¤©ï¼ˆ168å°æ—¶ï¼‰

# ç”¨æˆ·ç®¡ç†åŠŸèƒ½å¼€å…³
N8N_USER_MANAGEMENT_DISABLED=false
# è¯´æ˜ï¼šæ˜¯å¦ç¦ç”¨ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼Œtrue=ç¦ç”¨ï¼Œfalse=å¯ç”¨
```

#### å®‰å…¨åŠ å¯†é…ç½®

```bash
# ===========================================
# å®‰å…¨åŠ å¯†é…ç½®
# ===========================================

# æ•°æ®åŠ å¯†å¯†é’¥
N8N_ENCRYPTION_KEY=your_encryption_key_here
# å®‰å…¨è¦æ±‚ï¼šè‡³å°‘32ä½éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºæ•æ„Ÿæ•°æ®åŠ å¯†
# é‡è¦ï¼šæ­¤å¯†é’¥ä¸¢å¤±å°†å¯¼è‡´å·²ä¿å­˜çš„å‡­æ®æ— æ³•è§£å¯†

# å·¥ä½œæµåŠ å¯†å¼€å…³
N8N_WORKFLOWS_ENCRYPTION_ENABLED=true
# è¯´æ˜ï¼šæ˜¯å¦åŠ å¯†å­˜å‚¨å·¥ä½œæµæ•°æ®

# å‡­æ®åŠ å¯†å¼€å…³
N8N_CREDENTIALS_ENCRYPTION_ENABLED=true
# è¯´æ˜ï¼šæ˜¯å¦åŠ å¯†å­˜å‚¨APIå¯†é’¥ç­‰æ•æ„Ÿå‡­æ®

# å®‰å…¨å¤´é…ç½®
N8N_SECURE_COOKIE=true
# è¯´æ˜ï¼šHTTPSç¯å¢ƒä¸‹å¯ç”¨å®‰å…¨Cookie

# CORSé…ç½®
N8N_CORS_ORIGIN=https://${SUBDOMAIN}.${DOMAIN_NAME}
# è¯´æ˜ï¼šè·¨åŸŸè¯·æ±‚å…è®¸çš„æºåœ°å€
```

#### æ•°æ®åº“é…ç½®

```bash
# ===========================================
# PostgreSQL æ•°æ®åº“é…ç½®
# ===========================================

# æ•°æ®åº“ç±»å‹
DB_TYPE=postgresdb
# é€‰é¡¹ï¼šsqliteï¼ˆå¼€å‘ï¼‰/ postgresdbï¼ˆç”Ÿäº§æ¨èï¼‰/ mysql

# æ•°æ®åº“ä¸»æœº
DB_POSTGRESDB_HOST=postgres
# è¯´æ˜ï¼šDockerç¯å¢ƒä½¿ç”¨æœåŠ¡åï¼Œç‹¬ç«‹éƒ¨ç½²ä½¿ç”¨IPåœ°å€

# æ•°æ®åº“ç«¯å£
DB_POSTGRESDB_PORT=5432
# è¯´æ˜ï¼šPostgreSQLé»˜è®¤ç«¯å£

# æ•°æ®åº“åç§°
DB_POSTGRESDB_DATABASE=n8n
# è¯´æ˜ï¼šN8Nä¸“ç”¨æ•°æ®åº“åç§°

# æ•°æ®åº“ç”¨æˆ·
DB_POSTGRESDB_USER=n8n
# è¯´æ˜ï¼šæ•°æ®åº“ç”¨æˆ·åï¼Œå»ºè®®ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·

# æ•°æ®åº“å¯†ç 
DB_POSTGRESDB_PASSWORD=your_db_password_here
# å®‰å…¨è¦æ±‚ï¼šè‡³å°‘16ä½å¼ºå¯†ç 

# è¿æ¥æ± é…ç½®
DB_POSTGRESDB_POOL_SIZE=10
# è¯´æ˜ï¼šæ•°æ®åº“è¿æ¥æ± å¤§å°ï¼Œæ ¹æ®å¹¶å‘éœ€æ±‚è°ƒæ•´

# è¿æ¥è¶…æ—¶é…ç½®
DB_POSTGRESDB_CONNECTION_TIMEOUT=30000
# è¯´æ˜ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’

# PostgreSQL ç³»ç»Ÿé…ç½®
POSTGRES_DB=${DB_POSTGRESDB_DATABASE}
POSTGRES_USER=${DB_POSTGRESDB_USER}
POSTGRES_PASSWORD=${DB_POSTGRESDB_PASSWORD}
```

#### Redis ç¼“å­˜é…ç½®

```bash
# ===========================================
# Redis ç¼“å­˜é…ç½®
# ===========================================

# Redisä¸»æœº
REDIS_HOST=redis
# è¯´æ˜ï¼šDockerç¯å¢ƒä½¿ç”¨æœåŠ¡å

# Redisç«¯å£
REDIS_PORT=6379
# è¯´æ˜ï¼šRedisé»˜è®¤ç«¯å£

# Rediså¯†ç 
REDIS_PASSWORD=your_redis_password_here
# å®‰å…¨è¦æ±‚ï¼šè‡³å°‘12ä½å¯†ç 

# Redisæ•°æ®åº“ç´¢å¼•
REDIS_DB=0
# è¯´æ˜ï¼šä½¿ç”¨çš„Redisæ•°æ®åº“ç´¢å¼•ï¼Œ0-15

# è¿æ¥è¶…æ—¶
REDIS_CONNECTION_TIMEOUT=5000
# è¯´æ˜ï¼šRedisè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’

# å‘½ä»¤è¶…æ—¶
REDIS_COMMAND_TIMEOUT=5000
# è¯´æ˜ï¼šRediså‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’
```

#### æ‰§è¡Œé…ç½®

```bash
# ===========================================
# å·¥ä½œæµæ‰§è¡Œé…ç½®
# ===========================================

# æ‰§è¡Œæ¨¡å¼
EXECUTIONS_MODE=queue
# é€‰é¡¹ï¼šmainï¼ˆä¸»è¿›ç¨‹æ‰§è¡Œï¼‰/ queueï¼ˆé˜Ÿåˆ—æ¨¡å¼ï¼Œæ¨èï¼‰

# é˜Ÿåˆ—é…ç½®
QUEUE_BULL_REDIS_HOST=${REDIS_HOST}
QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
QUEUE_BULL_REDIS_DB=1
# è¯´æ˜ï¼šä½¿ç”¨ç‹¬ç«‹çš„Redisæ•°æ®åº“ç´¢å¼•å­˜å‚¨é˜Ÿåˆ—æ•°æ®

# å¹¶å‘æ‰§è¡Œæ•°é‡
N8N_CONCURRENCY=10
# è¯´æ˜ï¼šåŒæ—¶æ‰§è¡Œçš„å·¥ä½œæµæ•°é‡ï¼Œæ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´

# æœ€å¤§è´Ÿè½½å¤§å°
N8N_PAYLOAD_SIZE_MAX=16
# è¯´æ˜ï¼šå•ä¸ªå·¥ä½œæµæœ€å¤§æ•°æ®è´Ÿè½½ï¼Œå•ä½MB

# æ‰§è¡Œè¶…æ—¶æ—¶é—´
N8N_EXECUTION_TIMEOUT=3600
# è¯´æ˜ï¼šå•ä¸ªå·¥ä½œæµæœ€å¤§æ‰§è¡Œæ—¶é—´ï¼Œå•ä½ç§’

# æ•°æ®ä¿å­˜ç­–ç•¥
EXECUTIONS_DATA_SAVE_ON_ERROR=all
# é€‰é¡¹ï¼šallï¼ˆä¿å­˜æ‰€æœ‰ï¼‰/ noneï¼ˆä¸ä¿å­˜ï¼‰

EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
# é€‰é¡¹ï¼šallï¼ˆä¿å­˜æ‰€æœ‰ï¼‰/ noneï¼ˆä¸ä¿å­˜ï¼‰

# æ‰§è¡Œæ•°æ®ä¿ç•™æ—¶é—´
EXECUTIONS_DATA_MAX_AGE=168
# è¯´æ˜ï¼šæ‰§è¡Œå†å²æ•°æ®ä¿ç•™æ—¶é—´ï¼Œå•ä½å°æ—¶
```

#### AIæ™ºèƒ½ä½“é…ç½®

```bash
# ===========================================
# AIæ™ºèƒ½ä½“é…ç½®
# ===========================================

# OpenAI APIé…ç½®
OPENAI_API_KEY=your_openai_api_key_here
# è¯´æ˜ï¼šOpenAI APIå¯†é’¥ï¼Œç”¨äºAIèŠ‚ç‚¹åŠŸèƒ½

# OpenAI APIåŸºç¡€URL
OPENAI_API_BASE_URL=https://api.openai.com/v1
# è¯´æ˜ï¼šOpenAI APIåŸºç¡€åœ°å€ï¼Œå¯é…ç½®ä»£ç†åœ°å€

# é»˜è®¤AIæ¨¡å‹
OPENAI_DEFAULT_MODEL=gpt-3.5-turbo
# é€‰é¡¹ï¼šgpt-3.5-turbo / gpt-4 / gpt-4-turbo

# AIè¯·æ±‚è¶…æ—¶æ—¶é—´
OPENAI_REQUEST_TIMEOUT=60000
# è¯´æ˜ï¼šAI APIè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’

# æœ€å¤§tokensæ•°é‡
OPENAI_MAX_TOKENS=2000
# è¯´æ˜ï¼šå•æ¬¡AIè¯·æ±‚æœ€å¤§tokenæ•°é‡

# AIåŠŸèƒ½å¼€å…³
N8N_AI_ENABLED=true
# è¯´æ˜ï¼šæ˜¯å¦å¯ç”¨AIç›¸å…³åŠŸèƒ½
```

#### æ—¥å¿—é…ç½®

```bash
# ===========================================
# æ—¥å¿—é…ç½®
# ===========================================

# æ—¥å¿—çº§åˆ«
N8N_LOG_LEVEL=info
# é€‰é¡¹ï¼šerror / warn / info / debug / trace

# æ—¥å¿—è¾“å‡ºæ–¹å¼
N8N_LOG_OUTPUT=console,file
# é€‰é¡¹ï¼šconsoleï¼ˆæ§åˆ¶å°ï¼‰/ fileï¼ˆæ–‡ä»¶ï¼‰/ console,fileï¼ˆåŒæ—¶è¾“å‡ºï¼‰

# æ—¥å¿—æ–‡ä»¶ä½ç½®
N8N_LOG_FILE_LOCATION=/var/log/n8n/
# è¯´æ˜ï¼šæ—¥å¿—æ–‡ä»¶å­˜å‚¨ç›®å½•

# æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶
N8N_LOG_FILE_SIZE_MAX=10
# è¯´æ˜ï¼šå•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼Œå•ä½MB

# æ—¥å¿—æ–‡ä»¶æ•°é‡é™åˆ¶
N8N_LOG_FILE_COUNT_MAX=10
# è¯´æ˜ï¼šä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡

# è®¿é—®æ—¥å¿—å¼€å…³
N8N_ACCESS_LOG_ENABLED=true
# è¯´æ˜ï¼šæ˜¯å¦è®°å½•HTTPè®¿é—®æ—¥å¿—
```

#### ç›‘æ§é…ç½®

```bash
# ===========================================
# ç›‘æ§é…ç½®
# ===========================================

# å¥åº·æ£€æŸ¥ç«¯ç‚¹
N8N_METRICS_ENABLED=true
# è¯´æ˜ï¼šå¯ç”¨PrometheusæŒ‡æ ‡æ”¶é›†

# æŒ‡æ ‡ç«¯å£
N8N_METRICS_PORT=9090
# è¯´æ˜ï¼šPrometheusæŒ‡æ ‡æš´éœ²ç«¯å£

# å¥åº·æ£€æŸ¥è·¯å¾„
N8N_HEALTH_CHECK_PATH=/healthz
# è¯´æ˜ï¼šå¥åº·æ£€æŸ¥APIè·¯å¾„

# æ€§èƒ½ç›‘æ§å¼€å…³
N8N_DIAGNOSTICS_ENABLED=true
# è¯´æ˜ï¼šå¯ç”¨æ€§èƒ½è¯Šæ–­æ•°æ®æ”¶é›†

# é”™è¯¯è¿½è¸ªé…ç½®
SENTRY_DSN=your_sentry_dsn_here
# è¯´æ˜ï¼šSentryé”™è¯¯è¿½è¸ªæœåŠ¡DSNï¼ˆå¯é€‰ï¼‰
```

#### å¤‡ä»½æ¢å¤é…ç½®

```bash
# ===========================================
# å¤‡ä»½æ¢å¤é…ç½®
# ===========================================

# è‡ªåŠ¨å¤‡ä»½å¼€å…³
N8N_AUTO_BACKUP_ENABLED=true
# è¯´æ˜ï¼šæ˜¯å¦å¯ç”¨è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½

# å¤‡ä»½é¢‘ç‡
N8N_BACKUP_SCHEDULE=0 2 * * *
# è¯´æ˜ï¼šCronè¡¨è¾¾å¼ï¼Œé»˜è®¤æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½

# å¤‡ä»½ä¿ç•™å¤©æ•°
N8N_BACKUP_RETENTION_DAYS=30
# è¯´æ˜ï¼šå¤‡ä»½æ–‡ä»¶ä¿ç•™å¤©æ•°

# å¤‡ä»½å­˜å‚¨è·¯å¾„
N8N_BACKUP_PATH=/var/backups/n8n/
# è¯´æ˜ï¼šå¤‡ä»½æ–‡ä»¶å­˜å‚¨ç›®å½•

# è¿œç¨‹å¤‡ä»½é…ç½®ï¼ˆå¯é€‰ï¼‰
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_S3_BUCKET=your-backup-bucket
AWS_S3_REGION=us-east-1
```

---

## ğŸš€ éƒ¨ç½²è„šæœ¬é…ç½®

### deploy_n8n.sh è„šæœ¬è¯¦è§£

#### è„šæœ¬åŠŸèƒ½è¯´æ˜

```bash
#!/bin/bash
# ===========================================
# N8N è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
# åŠŸèƒ½ï¼šä¸€é”®éƒ¨ç½²N8Nç³»ç»Ÿï¼ŒåŒ…å«ç¯å¢ƒæ£€æŸ¥ã€ä¾èµ–å®‰è£…ã€é…ç½®ç”Ÿæˆç­‰
# ä½œè€…ï¼šç³»ç»Ÿç®¡ç†å‘˜
# ç‰ˆæœ¬ï¼šv2.0
# æ›´æ–°æ—¶é—´ï¼š2024-01-01
# ===========================================

# è„šæœ¬å®‰å…¨è®¾ç½®
set -euo pipefail  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œæœªå®šä¹‰å˜é‡æŠ¥é”™ï¼Œç®¡é“é”™è¯¯ä¼ æ’­
IFS=$'\n\t'        # è®¾ç½®å†…éƒ¨å­—æ®µåˆ†éš”ç¬¦ï¼Œé˜²æ­¢ç©ºæ ¼é—®é¢˜

# é¢œè‰²å®šä¹‰ï¼ˆç”¨äºç¾åŒ–è¾“å‡ºï¼‰
readonly RED='\033[0;31m'      # çº¢è‰²ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
readonly GREEN='\033[0;32m'    # ç»¿è‰²ï¼ˆæˆåŠŸä¿¡æ¯ï¼‰
readonly YELLOW='\033[1;33m'   # é»„è‰²ï¼ˆè­¦å‘Šä¿¡æ¯ï¼‰
readonly BLUE='\033[0;34m'     # è“è‰²ï¼ˆä¿¡æ¯æç¤ºï¼‰
readonly PURPLE='\033[0;35m'   # ç´«è‰²ï¼ˆé‡è¦ä¿¡æ¯ï¼‰
readonly CYAN='\033[0;36m'     # é’è‰²ï¼ˆæ­¥éª¤æç¤ºï¼‰
readonly NC='\033[0m'          # æ— é¢œè‰²ï¼ˆé‡ç½®ï¼‰
```

#### å…¨å±€é…ç½®å˜é‡

```bash
# ===========================================
# å…¨å±€é…ç½®å˜é‡
# ===========================================

# é¡¹ç›®ä¿¡æ¯
readonly SCRIPT_NAME="N8Néƒ¨ç½²è„šæœ¬"
readonly SCRIPT_VERSION="2.0"
readonly PROJECT_NAME="N8N-è‡ªåŠ¨åŒ–"

# ç³»ç»Ÿè¦æ±‚
readonly MIN_DOCKER_VERSION="20.10.0"
readonly MIN_COMPOSE_VERSION="2.0.0"
readonly MIN_MEMORY_GB=4
readonly MIN_DISK_GB=20

# é»˜è®¤é…ç½®
readonly DEFAULT_N8N_PORT=5678
readonly DEFAULT_POSTGRES_PORT=5432
readonly DEFAULT_REDIS_PORT=6379

# æ–‡ä»¶è·¯å¾„
readonly ENV_FILE=".env"
readonly COMPOSE_FILE="docker-compose.yml"
readonly BACKUP_DIR="backups"
readonly LOG_DIR="logs"

# ç½‘ç»œé…ç½®
readonly DOCKER_NETWORK="n8n-network"
readonly SUBNET="172.20.0.0/16"
```

#### æ—¥å¿—è®°å½•å‡½æ•°

```bash
# ===========================================
# æ—¥å¿—è®°å½•å‡½æ•°
# ===========================================

# åˆ›å»ºæ—¥å¿—ç›®å½•
setup_logging() {
    local log_dir="${LOG_DIR}"
    local log_file="${log_dir}/deploy_$(date +%Y%m%d_%H%M%S).log"
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p "${log_dir}"
    
    # è®¾ç½®æ—¥å¿—æ–‡ä»¶
    exec 1> >(tee -a "${log_file}")
    exec 2> >(tee -a "${log_file}" >&2)
    
    log_info "æ—¥å¿—æ–‡ä»¶ï¼š${log_file}"
}

# ä¿¡æ¯æ—¥å¿—
log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# æˆåŠŸæ—¥å¿—
log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# è­¦å‘Šæ—¥å¿—
log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# é”™è¯¯æ—¥å¿—
log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
}

# æ­¥éª¤æ—¥å¿—
log_step() {
    echo -e "${CYAN}[STEP]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}
```

#### é”™è¯¯å¤„ç†å‡½æ•°

```bash
# ===========================================
# é”™è¯¯å¤„ç†å‡½æ•°
# ===========================================

# é”™è¯¯å¤„ç†å™¨
error_handler() {
    local line_number=$1
    local error_code=$2
    local command="$3"
    
    log_error "è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼"
    log_error "é”™è¯¯ä½ç½®ï¼šç¬¬ ${line_number} è¡Œ"
    log_error "é”™è¯¯ä»£ç ï¼š${error_code}"
    log_error "å¤±è´¥å‘½ä»¤ï¼š${command}"
    
    # æ˜¾ç¤ºè°ƒç”¨æ ˆ
    log_error "è°ƒç”¨æ ˆï¼š"
    local frame=0
    while caller $frame; do
        ((frame++))
    done
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_on_error
    
    exit "${error_code}"
}

# è®¾ç½®é”™è¯¯å¤„ç†å™¨
trap 'error_handler ${LINENO} $? "$BASH_COMMAND"' ERR

# æ¸…ç†å‡½æ•°
cleanup_on_error() {
    log_warning "æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    
    # åœæ­¢å¯èƒ½å¯åŠ¨çš„å®¹å™¨
    if docker-compose ps -q > /dev/null 2>&1; then
        docker-compose down --remove-orphans
    fi
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f .env.tmp docker-compose.yml.tmp
    
    log_info "æ¸…ç†å®Œæˆ"
}

# è„šæœ¬é€€å‡ºæ—¶æ¸…ç†
trap cleanup_on_error EXIT
```

#### ç³»ç»Ÿæ£€æµ‹å‡½æ•°

```bash
# ===========================================
# ç³»ç»Ÿæ£€æµ‹å‡½æ•°
# ===========================================

# æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
check_system_requirements() {
    log_step "æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
    
    # æ£€æŸ¥æ“ä½œç³»ç»Ÿ
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        log_info "æ“ä½œç³»ç»Ÿï¼šLinux"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        log_info "æ“ä½œç³»ç»Ÿï¼šmacOS"
    else
        log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼š$OSTYPE"
        return 1
    fi
    
    # æ£€æŸ¥å†…å­˜
    local memory_gb
    if command -v free >/dev/null 2>&1; then
        memory_gb=$(free -g | awk '/^Mem:/{print $2}')
    elif command -v vm_stat >/dev/null 2>&1; then
        local pages=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
        memory_gb=$((pages * 4096 / 1024 / 1024 / 1024))
    else
        log_warning "æ— æ³•æ£€æµ‹å†…å­˜å¤§å°"
        memory_gb=${MIN_MEMORY_GB}
    fi
    
    if [[ ${memory_gb} -lt ${MIN_MEMORY_GB} ]]; then
        log_warning "å†…å­˜ä¸è¶³ï¼š${memory_gb}GB < ${MIN_MEMORY_GB}GB"
    else
        log_success "å†…å­˜æ£€æŸ¥é€šè¿‡ï¼š${memory_gb}GB"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_gb=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
    if [[ ${disk_gb} -lt ${MIN_DISK_GB} ]]; then
        log_warning "ç£ç›˜ç©ºé—´ä¸è¶³ï¼š${disk_gb}GB < ${MIN_DISK_GB}GB"
    else
        log_success "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼š${disk_gb}GB"
    fi
}

# æ£€æŸ¥Dockerå®‰è£…
check_docker() {
    log_step "æ£€æŸ¥Dockerç¯å¢ƒ..."
    
    # æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
    if ! command -v docker >/dev/null 2>&1; then
        log_error "Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
        return 1
    fi
    
    # æ£€æŸ¥Dockerç‰ˆæœ¬
    local docker_version=$(docker --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    if ! version_compare "${docker_version}" "${MIN_DOCKER_VERSION}"; then
        log_error "Dockerç‰ˆæœ¬è¿‡ä½ï¼š${docker_version} < ${MIN_DOCKER_VERSION}"
        return 1
    fi
    log_success "Dockerç‰ˆæœ¬æ£€æŸ¥é€šè¿‡ï¼š${docker_version}"
    
    # æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
    if ! docker info >/dev/null 2>&1; then
        log_error "DockeræœåŠ¡æœªè¿è¡Œï¼Œè¯·å¯åŠ¨DockeræœåŠ¡"
        return 1
    fi
    log_success "DockeræœåŠ¡è¿è¡Œæ­£å¸¸"
    
    # æ£€æŸ¥Docker Compose
    if ! command -v docker-compose >/dev/null 2>&1; then
        log_error "Docker Composeæœªå®‰è£…"
        return 1
    fi
    
    local compose_version=$(docker-compose --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    if ! version_compare "${compose_version}" "${MIN_COMPOSE_VERSION}"; then
        log_error "Docker Composeç‰ˆæœ¬è¿‡ä½ï¼š${compose_version} < ${MIN_COMPOSE_VERSION}"
        return 1
    fi
    log_success "Docker Composeç‰ˆæœ¬æ£€æŸ¥é€šè¿‡ï¼š${compose_version}"
}

# ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
version_compare() {
    local version1=$1
    local version2=$2
    
    # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
    local v1_major=$(echo "$version1" | cut -d. -f1)
    local v1_minor=$(echo "$version1" | cut -d. -f2)
    local v1_patch=$(echo "$version1" | cut -d. -f3)
    
    local v2_major=$(echo "$version2" | cut -d. -f1)
    local v2_minor=$(echo "$version2" | cut -d. -f2)
    local v2_patch=$(echo "$version2" | cut -d. -f3)
    
    # æ¯”è¾ƒä¸»ç‰ˆæœ¬å·
    if [[ $v1_major -gt $v2_major ]]; then
        return 0
    elif [[ $v1_major -lt $v2_major ]]; then
        return 1
    fi
    
    # æ¯”è¾ƒæ¬¡ç‰ˆæœ¬å·
    if [[ $v1_minor -gt $v2_minor ]]; then
        return 0
    elif [[ $v1_minor -lt $v2_minor ]]; then
        return 1
    fi
    
    # æ¯”è¾ƒè¡¥ä¸ç‰ˆæœ¬å·
    if [[ $v1_patch -ge $v2_patch ]]; then
        return 0
    else
        return 1
    fi
}
```

#### é…ç½®ç”Ÿæˆå‡½æ•°

```bash
# ===========================================
# é…ç½®ç”Ÿæˆå‡½æ•°
# ===========================================

# ç”Ÿæˆéšæœºå¯†ç 
generate_password() {
    local length=${1:-32}
    openssl rand -base64 $((length * 3 / 4)) | tr -d "=+/" | cut -c1-${length}
}

# ç”Ÿæˆç¯å¢ƒå˜é‡æ–‡ä»¶
generate_env_file() {
    log_step "ç”Ÿæˆç¯å¢ƒå˜é‡é…ç½®..."
    
    # äº¤äº’å¼é…ç½®æ”¶é›†
    collect_user_config
    
    # ç”Ÿæˆå¯†ç 
    local encryption_key=$(generate_password 32)
    local jwt_secret=$(generate_password 64)
    local postgres_password=$(generate_password 16)
    local redis_password=$(generate_password 16)
    
    # åˆ›å»º.envæ–‡ä»¶
    cat > "${ENV_FILE}" << EOF
# ===========================================
# N8N ç¯å¢ƒé…ç½®æ–‡ä»¶
# ç”Ÿæˆæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
# ç”Ÿæˆè„šæœ¬ï¼š${SCRIPT_NAME} v${SCRIPT_VERSION}
# ===========================================

# åŸºç¡€ç½‘ç»œé…ç½®
DOMAIN_NAME=${DOMAIN_NAME}
SUBDOMAIN=${SUBDOMAIN}
N8N_PROTOCOL=${N8N_PROTOCOL}
N8N_PORT=${N8N_PORT}
N8N_EDITOR_BASE_URL=${N8N_PROTOCOL}://${SUBDOMAIN}.${DOMAIN_NAME}

# ç”¨æˆ·è®¤è¯é…ç½®
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=${ADMIN_USER}
N8N_BASIC_AUTH_PASSWORD=${ADMIN_PASSWORD}
N8N_USER_MANAGEMENT_JWT_SECRET=${jwt_secret}
N8N_USER_MANAGEMENT_JWT_DURATION_HOURS=168
N8N_USER_MANAGEMENT_DISABLED=false

# å®‰å…¨åŠ å¯†é…ç½®
N8N_ENCRYPTION_KEY=${encryption_key}
N8N_WORKFLOWS_ENCRYPTION_ENABLED=true
N8N_CREDENTIALS_ENCRYPTION_ENABLED=true
N8N_SECURE_COOKIE=true
N8N_CORS_ORIGIN=${N8N_PROTOCOL}://${SUBDOMAIN}.${DOMAIN_NAME}

# æ•°æ®åº“é…ç½®
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgres
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=${postgres_password}
DB_POSTGRESDB_POOL_SIZE=10
DB_POSTGRESDB_CONNECTION_TIMEOUT=30000

# PostgreSQLç³»ç»Ÿé…ç½®
POSTGRES_DB=n8n
POSTGRES_USER=n8n
POSTGRES_PASSWORD=${postgres_password}

# Redisé…ç½®
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=${redis_password}
REDIS_DB=0
REDIS_CONNECTION_TIMEOUT=5000
REDIS_COMMAND_TIMEOUT=5000

# æ‰§è¡Œé…ç½®
EXECUTIONS_MODE=queue
QUEUE_BULL_REDIS_HOST=redis
QUEUE_BULL_REDIS_PORT=6379
QUEUE_BULL_REDIS_PASSWORD=${redis_password}
QUEUE_BULL_REDIS_DB=1
N8N_CONCURRENCY=10
N8N_PAYLOAD_SIZE_MAX=16
N8N_EXECUTION_TIMEOUT=3600
EXECUTIONS_DATA_SAVE_ON_ERROR=all
EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
EXECUTIONS_DATA_MAX_AGE=168

# æ—¥å¿—é…ç½®
N8N_LOG_LEVEL=info
N8N_LOG_OUTPUT=console,file
N8N_LOG_FILE_LOCATION=/var/log/n8n/
N8N_LOG_FILE_SIZE_MAX=10
N8N_LOG_FILE_COUNT_MAX=10
N8N_ACCESS_LOG_ENABLED=true

# ç›‘æ§é…ç½®
N8N_METRICS_ENABLED=true
N8N_METRICS_PORT=9090
N8N_HEALTH_CHECK_PATH=/healthz
N8N_DIAGNOSTICS_ENABLED=true

# å¤‡ä»½é…ç½®
N8N_AUTO_BACKUP_ENABLED=true
N8N_BACKUP_SCHEDULE=0 2 * * *
N8N_BACKUP_RETENTION_DAYS=30
N8N_BACKUP_PATH=/var/backups/n8n/

EOF

    log_success "ç¯å¢ƒå˜é‡æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼š${ENV_FILE}"
}

# æ”¶é›†ç”¨æˆ·é…ç½®
collect_user_config() {
    log_info "è¯·è¾“å…¥é…ç½®ä¿¡æ¯ï¼ˆæŒ‰å›è½¦ä½¿ç”¨é»˜è®¤å€¼ï¼‰ï¼š"
    
    # åŸŸåé…ç½®
    read -p "åŸŸå [localhost]: " DOMAIN_NAME
    DOMAIN_NAME=${DOMAIN_NAME:-localhost}
    
    read -p "å­åŸŸå [n8n]: " SUBDOMAIN
    SUBDOMAIN=${SUBDOMAIN:-n8n}
    
    # åè®®é€‰æ‹©
    if [[ "${DOMAIN_NAME}" == "localhost" ]]; then
        N8N_PROTOCOL="http"
    else
        read -p "åè®® (http/https) [https]: " N8N_PROTOCOL
        N8N_PROTOCOL=${N8N_PROTOCOL:-https}
    fi
    
    # ç«¯å£é…ç½®
    read -p "N8Nç«¯å£ [${DEFAULT_N8N_PORT}]: " N8N_PORT
    N8N_PORT=${N8N_PORT:-${DEFAULT_N8N_PORT}}
    
    # ç®¡ç†å‘˜è´¦æˆ·
    read -p "ç®¡ç†å‘˜ç”¨æˆ·å [admin]: " ADMIN_USER
    ADMIN_USER=${ADMIN_USER:-admin}
    
    while true; do
        read -s -p "ç®¡ç†å‘˜å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰: " ADMIN_PASSWORD
        echo
        if [[ ${#ADMIN_PASSWORD} -ge 8 ]]; then
            break
        else
            log_warning "å¯†ç é•¿åº¦ä¸è¶³ï¼Œè¯·è¾“å…¥è‡³å°‘8ä½å¯†ç "
        fi
    done
}
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### SSL/TLS é…ç½®

#### Nginx SSL é…ç½®

```nginx
# /config/nginx.conf
server {
    listen 80;
    server_name n8n.your-domain.com;
    
    # HTTPé‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name n8n.your-domain.com;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # åå‘ä»£ç†é…ç½®
    location / {
        proxy_pass http://n8n:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Webhookè·¯å¾„ä¼˜åŒ–
    location /webhook/ {
        proxy_pass http://n8n:5678;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

### é˜²ç«å¢™é…ç½®

#### UFW é˜²ç«å¢™è§„åˆ™

```bash
#!/bin/bash
# é˜²ç«å¢™é…ç½®è„šæœ¬

# é‡ç½®é˜²ç«å¢™è§„åˆ™
ufw --force reset

# é»˜è®¤ç­–ç•¥
ufw default deny incoming
ufw default allow outgoing

# SSHè®¿é—®
ufw allow ssh

# HTTP/HTTPSè®¿é—®
ufw allow 80/tcp
ufw allow 443/tcp

# N8Nç«¯å£ï¼ˆä»…æœ¬åœ°è®¿é—®ï¼‰
ufw allow from 127.0.0.1 to any port 5678

# æ•°æ®åº“ç«¯å£ï¼ˆä»…Dockerç½‘ç»œï¼‰
ufw allow from 172.20.0.0/16 to any port 5432
ufw allow from 172.20.0.0/16 to any port 6379

# å¯ç”¨é˜²ç«å¢™
ufw --force enable

# æ˜¾ç¤ºçŠ¶æ€
ufw status verbose
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

### PostgreSQL ä¼˜åŒ–

#### postgresql.conf ä¼˜åŒ–é…ç½®

```sql
-- /config/postgresql.conf

-- å†…å­˜é…ç½®
shared_buffers = 256MB                    -- å…±äº«ç¼“å†²åŒºï¼Œå»ºè®®ä¸ºå†…å­˜çš„25%
effective_cache_size = 1GB                -- æœ‰æ•ˆç¼“å­˜å¤§å°ï¼Œå»ºè®®ä¸ºå†…å­˜çš„75%
work_mem = 4MB                           -- å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB              -- ç»´æŠ¤å·¥ä½œå†…å­˜

-- è¿æ¥é…ç½®
max_connections = 200                     -- æœ€å¤§è¿æ¥æ•°
shared_preload_libraries = 'pg_stat_statements'  -- é¢„åŠ è½½ç»Ÿè®¡æ‰©å±•

-- æ£€æŸ¥ç‚¹é…ç½®
checkpoint_completion_target = 0.9        -- æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
wal_buffers = 16MB                       -- WALç¼“å†²åŒº
checkpoint_timeout = 10min               -- æ£€æŸ¥ç‚¹è¶…æ—¶

-- æ—¥å¿—é…ç½®
log_destination = 'stderr'               -- æ—¥å¿—è¾“å‡ºç›®æ ‡
logging_collector = on                   -- å¯ç”¨æ—¥å¿—æ”¶é›†å™¨
log_directory = 'pg_log'                -- æ—¥å¿—ç›®å½•
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  -- æ—¥å¿—æ–‡ä»¶å
log_min_duration_statement = 1000       -- è®°å½•æ…¢æŸ¥è¯¢ï¼ˆæ¯«ç§’ï¼‰
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

-- ç»Ÿè®¡é…ç½®
track_activities = on                    -- è·Ÿè¸ªæ´»åŠ¨
track_counts = on                       -- è·Ÿè¸ªè®¡æ•°
track_functions = all                   -- è·Ÿè¸ªå‡½æ•°
```

### Redis ä¼˜åŒ–

#### redis.conf ä¼˜åŒ–é…ç½®

```conf
# /config/redis.conf

# å†…å­˜é…ç½®
maxmemory 512mb                          # æœ€å¤§å†…å­˜ä½¿ç”¨
maxmemory-policy allkeys-lru             # å†…å­˜æ·˜æ±°ç­–ç•¥

# æŒä¹…åŒ–é…ç½®
save 900 1                              # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 300 10                             # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 60 10000                           # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜

# AOFé…ç½®
appendonly yes                          # å¯ç”¨AOFæŒä¹…åŒ–
appendfsync everysec                    # æ¯ç§’åŒæ­¥ä¸€æ¬¡
no-appendfsync-on-rewrite no           # é‡å†™æ—¶ä¸åœæ­¢åŒæ­¥

# ç½‘ç»œé…ç½®
tcp-keepalive 300                       # TCPä¿æ´»æ—¶é—´
timeout 0                               # å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´ï¼ˆ0=ä¸è¶…æ—¶ï¼‰

# å®‰å…¨é…ç½®
requirepass your_redis_password_here    # è®¾ç½®å¯†ç 
rename-command FLUSHDB ""               # ç¦ç”¨å±é™©å‘½ä»¤
rename-command FLUSHALL ""              # ç¦ç”¨å±é™©å‘½ä»¤
rename-command CONFIG ""                # ç¦ç”¨é…ç½®å‘½ä»¤

# æ€§èƒ½é…ç½®
tcp-backlog 511                         # TCPç›‘å¬é˜Ÿåˆ—é•¿åº¦
databases 16                            # æ•°æ®åº“æ•°é‡
```

---

## ğŸ“Š ç›‘æ§é…ç½®

### Prometheus é…ç½®

#### prometheus.yml é…ç½®

```yaml
# /config/prometheus.yml
global:
  scrape_interval: 15s                  # å…¨å±€æŠ“å–é—´éš”
  evaluation_interval: 15s              # è§„åˆ™è¯„ä¼°é—´éš”

rule_files:
  - "alert_rules.yml"                   # å‘Šè­¦è§„åˆ™æ–‡ä»¶

scrape_configs:
  # N8NæŒ‡æ ‡æ”¶é›†
  - job_name: 'n8n'
    static_configs:
      - targets: ['n8n:9090']
    scrape_interval: 30s
    metrics_path: /metrics
    
  # PostgreSQLæŒ‡æ ‡æ”¶é›†
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
    
  # RedisæŒ‡æ ‡æ”¶é›†
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    
  # ç³»ç»ŸæŒ‡æ ‡æ”¶é›†
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### å‘Šè­¦è§„åˆ™

#### alert_rules.yml é…ç½®

```yaml
# /config/alert_rules.yml
groups:
  - name: n8n_alerts
    rules:
      # N8NæœåŠ¡çŠ¶æ€å‘Šè­¦
      - alert: N8NServiceDown
        expr: up{job="n8n"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "N8NæœåŠ¡ä¸å¯ç”¨"
          description: "N8NæœåŠ¡å·²åœæ­¢è¿è¡Œè¶…è¿‡1åˆ†é’Ÿ"
      
      # å·¥ä½œæµæ‰§è¡Œå¤±è´¥å‘Šè­¦
      - alert: WorkflowExecutionFailed
        expr: increase(n8n_workflow_executions_failed_total[5m]) > 5
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "å·¥ä½œæµæ‰§è¡Œå¤±è´¥ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…å·¥ä½œæµæ‰§è¡Œå¤±è´¥æ¬¡æ•°è¶…è¿‡5æ¬¡"
      
      # å†…å­˜ä½¿ç”¨å‘Šè­¦
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%"
      
      # ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: DiskSpaceLow
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes > 0.8
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡80%"
      
      # æ•°æ®åº“è¿æ¥å‘Šè­¦
      - alert: DatabaseConnectionHigh
        expr: pg_stat_activity_count > 150
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
          description: "PostgreSQLæ´»è·ƒè¿æ¥æ•°è¶…è¿‡150"

  - name: system_alerts
    rules:
      # CPUä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "CPUä½¿ç”¨ç‡è¶…è¿‡80%"
```

---

## ğŸ’¾ å¤‡ä»½é…ç½®

### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

#### backup.sh è„šæœ¬é…ç½®

```bash
#!/bin/bash
# ===========================================
# N8N è‡ªåŠ¨å¤‡ä»½è„šæœ¬
# åŠŸèƒ½ï¼šå¤‡ä»½æ•°æ®åº“ã€é…ç½®æ–‡ä»¶ã€å·¥ä½œæµæ•°æ®
# ===========================================

# é…ç½®å˜é‡
BACKUP_DIR="/var/backups/n8n"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "${BACKUP_DIR}"

# æ•°æ®åº“å¤‡ä»½
log_info "å¼€å§‹å¤‡ä»½PostgreSQLæ•°æ®åº“..."
docker-compose exec -T postgres pg_dump -U n8n n8n | gzip > "${BACKUP_DIR}/postgres_${DATE}.sql.gz"

# å·¥ä½œæµæ•°æ®å¤‡ä»½
log_info "å¼€å§‹å¤‡ä»½N8Næ•°æ®..."
docker-compose exec -T n8n tar -czf - /home/node/.n8n > "${BACKUP_DIR}/n8n_data_${DATE}.tar.gz"

# é…ç½®æ–‡ä»¶å¤‡ä»½
log_info "å¼€å§‹å¤‡ä»½é…ç½®æ–‡ä»¶..."
tar -czf "${BACKUP_DIR}/config_${DATE}.tar.gz" .env docker-compose.yml config/

# æ¸…ç†æ—§å¤‡ä»½
log_info "æ¸…ç†${RETENTION_DAYS}å¤©å‰çš„å¤‡ä»½æ–‡ä»¶..."
find "${BACKUP_DIR}" -name "*.gz" -mtime +${RETENTION_DAYS} -delete

# å¤‡ä»½åˆ°è¿œç¨‹å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
if [[ -n "${AWS_S3_BUCKET}" ]]; then
    log_info "ä¸Šä¼ å¤‡ä»½åˆ°S3..."
    aws s3 sync "${BACKUP_DIR}" "s3://${AWS_S3_BUCKET}/n8n-backups/"
fi

log_success "å¤‡ä»½å®Œæˆï¼š${BACKUP_DIR}"
```

### æ¢å¤è„šæœ¬

#### restore.sh è„šæœ¬é…ç½®

```bash
#!/bin/bash
# ===========================================
# N8N æ•°æ®æ¢å¤è„šæœ¬
# åŠŸèƒ½ï¼šä»å¤‡ä»½æ–‡ä»¶æ¢å¤ç³»ç»Ÿæ•°æ®
# ===========================================

# å‚æ•°æ£€æŸ¥
if [[ $# -ne 1 ]]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ—¥æœŸ>"
    echo "ç¤ºä¾‹: $0 20240101_120000"
    exit 1
fi

BACKUP_DATE=$1
BACKUP_DIR="/var/backups/n8n"

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
if [[ ! -f "${BACKUP_DIR}/postgres_${BACKUP_DATE}.sql.gz" ]]; then
    log_error "æ•°æ®åº“å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨ï¼š${BACKUP_DIR}/postgres_${BACKUP_DATE}.sql.gz"
    exit 1
fi

# åœæ­¢æœåŠ¡
log_info "åœæ­¢N8NæœåŠ¡..."
docker-compose down

# æ¢å¤æ•°æ®åº“
log_info "æ¢å¤PostgreSQLæ•°æ®åº“..."
docker-compose up -d postgres
sleep 10
zcat "${BACKUP_DIR}/postgres_${BACKUP_DATE}.sql.gz" | docker-compose exec -T postgres psql -U n8n -d n8n

# æ¢å¤N8Næ•°æ®
if [[ -f "${BACKUP_DIR}/n8n_data_${BACKUP_DATE}.tar.gz" ]]; then
    log_info "æ¢å¤N8Næ•°æ®..."
    docker-compose run --rm n8n tar -xzf - -C / < "${BACKUP_DIR}/n8n_data_${BACKUP_DATE}.tar.gz"
fi

# æ¢å¤é…ç½®æ–‡ä»¶
if [[ -f "${BACKUP_DIR}/config_${BACKUP_DATE}.tar.gz" ]]; then
    log_info "æ¢å¤é…ç½®æ–‡ä»¶..."
    tar -xzf "${BACKUP_DIR}/config_${BACKUP_DATE}.tar.gz"
fi

# å¯åŠ¨æœåŠ¡
log_info "å¯åŠ¨N8NæœåŠ¡..."
docker-compose up -d

log_success "æ•°æ®æ¢å¤å®Œæˆ"
```

---

## ğŸ“ æ€»ç»“

æœ¬é…ç½®æ–‡ä»¶è¯¦è§£æ¶µç›–äº†N8Nç³»ç»Ÿçš„æ‰€æœ‰é‡è¦é…ç½®æ–¹é¢ï¼š

1. **Docker Composeé…ç½®**ï¼šå®Œæ•´çš„å®¹å™¨ç¼–æ’é…ç½®
2. **ç¯å¢ƒå˜é‡é…ç½®**ï¼šè¯¦ç»†çš„å‚æ•°è¯´æ˜å’Œå®‰å…¨é…ç½®
3. **éƒ¨ç½²è„šæœ¬é…ç½®**ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²å’Œé…ç½®ç”Ÿæˆ
4. **å®‰å…¨é…ç½®**ï¼šSSL/TLSã€é˜²ç«å¢™ã€è®¿é—®æ§åˆ¶
5. **æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼šæ•°æ®åº“å’Œç¼“å­˜ä¼˜åŒ–
6. **ç›‘æ§é…ç½®**ï¼šPrometheusæŒ‡æ ‡æ”¶é›†å’Œå‘Šè­¦
7. **å¤‡ä»½é…ç½®**ï¼šè‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

é€šè¿‡è¿™äº›é…ç½®ï¼Œä½ å¯ä»¥ï¼š
- å¿«é€Ÿéƒ¨ç½²ç”Ÿäº§çº§N8Nç³»ç»Ÿ
- ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œç¨³å®šæ€§
- å®ç°é«˜æ€§èƒ½å’Œå¯æ‰©å±•æ€§
- å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå¤‡ä»½æœºåˆ¶

å»ºè®®æ ¹æ®å®é™…ç¯å¢ƒéœ€æ±‚è°ƒæ•´ç›¸å…³å‚æ•°ï¼Œå¹¶å®šæœŸæ›´æ–°é…ç½®ä»¥ä¿æŒæœ€ä½³æ€§èƒ½ã€‚

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2024å¹´1æœˆ*
*ç‰ˆæœ¬ï¼šv1.0*