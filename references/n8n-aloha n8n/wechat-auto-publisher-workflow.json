{
  "name": "ğŸš€ å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨å‘å¸ƒå™¨",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "cronExpression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "publish-trigger",
      "name": "å‘å¸ƒæ—¶é—´è§¦å‘å™¨",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "wechat_articles",
        "where": {
          "conditions": [
            {
              "column": "status",
              "operator": "equal",
              "value": "ready_for_review"
            },
            {
              "column": "publish_time",
              "operator": "smallerEqual",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "publish_time",
              "direction": "ASC"
            }
          ]
        },
        "limit": 1
      },
      "id": "get-pending-article",
      "name": "è·å–å¾…å‘å¸ƒæ–‡ç« ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-aloha",
          "name": "Aloha PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-article",
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-article-exists",
      "name": "æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ç« ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.weixin.qq.com/cgi-bin/token",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "client_credential"
            },
            {
              "name": "appid",
              "value": "={{ $vars.WECHAT_APP_ID }}"
            },
            {
              "name": "secret",
              "value": "={{ $vars.WECHAT_APP_SECRET }}"
            }
          ]
        }
      },
      "id": "get-access-token",
      "name": "è·å–è®¿é—®ä»¤ç‰Œ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.weixin.qq.com/cgi-bin/message/mass/sendall",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "access_token",
              "value": "={{ $('get-access-token').item.json.access_token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "filter",
              "value": "{\"is_to_all\": true}"
            },
            {
              "name": "mpnews",
              "value": "{\"media_id\": \"{{ $('get-pending-article').item.json.media_id }}\"}"
            },
            {
              "name": "msgtype",
              "value": "mpnews"
            }
          ]
        }
      },
      "id": "publish-article",
      "name": "å‘å¸ƒæ–‡ç« ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "publish-success",
              "leftValue": "={{ $json.errcode }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-publish-result",
      "name": "æ£€æŸ¥å‘å¸ƒç»“æœ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "update",
        "table": "wechat_articles",
        "updateKey": "id",
        "columns": "status, published_at, msg_id",
        "additionalFields": {}
      },
      "id": "update-article-status",
      "name": "æ›´æ–°æ–‡ç« çŠ¶æ€",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "chatId": "telegram-chat-id",
        "text": "ğŸ‰ **å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å‘å¸ƒæˆåŠŸï¼**\\n\\nğŸ“ **æ–‡ç« ä¿¡æ¯**:\\nâ€¢ æ ‡é¢˜: {{ $('get-pending-article').item.json.title }}\\nâ€¢ åˆ†ç±»: {{ $('get-pending-article').item.json.category }}\\nâ€¢ å‘å¸ƒæ—¶é—´: {{ new Date().toLocaleString('zh-CN') }}\\n\\nğŸ“Š **å‘å¸ƒç»“æœ**:\\nâ€¢ æ¶ˆæ¯ID: {{ $('publish-article').item.json.msg_id }}\\nâ€¢ å‘é€çŠ¶æ€: æˆåŠŸ\\nâ€¢ é¢„è®¡åˆ°è¾¾: å…¨éƒ¨å…³æ³¨ç”¨æˆ·\\n\\nğŸ”— **åç»­æ“ä½œ**:\\nâ€¢ 30åˆ†é’Ÿåå¼€å§‹æ•°æ®ç»Ÿè®¡\\nâ€¢ 24å°æ—¶åç”Ÿæˆæ•ˆæœæŠ¥å‘Š",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "success-notification",
      "name": "å‘å¸ƒæˆåŠŸé€šçŸ¥",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 400],
      "credentials": {
        "telegramApi": {
          "id": "telegram-aloha",
          "name": "Aloha Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "table": "wechat_articles",
        "updateKey": "id",
        "columns": "status, error_message",
        "additionalFields": {}
      },
      "id": "update-error-status",
      "name": "æ›´æ–°é”™è¯¯çŠ¶æ€",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 600]
    },
    {
      "parameters": {
        "chatId": "telegram-chat-id",
        "text": "âŒ **å¾®ä¿¡å…¬ä¼—å·å‘å¸ƒå¤±è´¥ï¼**\\n\\nğŸ“ **æ–‡ç« ä¿¡æ¯**:\\nâ€¢ æ ‡é¢˜: {{ $('get-pending-article').item.json.title }}\\nâ€¢ åˆ†ç±»: {{ $('get-pending-article').item.json.category }}\\n\\nğŸš¨ **é”™è¯¯ä¿¡æ¯**:\\nâ€¢ é”™è¯¯ä»£ç : {{ $('publish-article').item.json.errcode }}\\nâ€¢ é”™è¯¯æè¿°: {{ $('publish-article').item.json.errmsg }}\\n\\nğŸ”§ **å»ºè®®æ“ä½œ**:\\nâ€¢ æ£€æŸ¥access_tokenæ˜¯å¦æœ‰æ•ˆ\\nâ€¢ ç¡®è®¤ç´ æIDæ˜¯å¦æ­£ç¡®\\nâ€¢ æŸ¥çœ‹APIè°ƒç”¨é™é¢\\nâ€¢ æ‰‹åŠ¨é‡è¯•å‘å¸ƒ",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "error-notification",
      "name": "å‘å¸ƒå¤±è´¥é€šçŸ¥",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 800],
      "credentials": {
        "telegramApi": {
          "id": "telegram-aloha",
          "name": "Aloha Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "cronExpression": "0 */2 * * *"
            }
          ]
        }
      },
      "id": "stats-trigger",
      "name": "æ•°æ®ç»Ÿè®¡è§¦å‘å™¨",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 1000]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "wechat_articles",
        "where": {
          "conditions": [
            {
              "column": "status",
              "operator": "equal",
              "value": "published"
            },
            {
              "column": "published_at",
              "operator": "greaterEqual",
              "value": "={{ new Date(Date.now() - 24*60*60*1000).toISOString() }}"
            }
          ]
        }
      },
      "id": "get-published-articles",
      "name": "è·å–å·²å‘å¸ƒæ–‡ç« ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 1000],
      "credentials": {
        "postgres": {
          "id": "postgres-aloha",
          "name": "Aloha PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.weixin.qq.com/datacube/getarticletotal",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "access_token",
              "value": "={{ $vars.WECHAT_ACCESS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "begin_date",
              "value": "={{ new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0].replace(/-/g, '') }}"
            },
            {
              "name": "end_date",
              "value": "={{ new Date().toISOString().split('T')[0].replace(/-/g, '') }}"
            }
          ]
        }
      },
      "id": "get-article-stats",
      "name": "è·å–æ–‡ç« ç»Ÿè®¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 1000]
    },
    {
      "parameters": {
        "jsCode": "// å¤„ç†ç»Ÿè®¡æ•°æ®å¹¶æ›´æ–°æ•°æ®åº“\nconst articles = $('get-published-articles').all();\nconst stats = $input.first().json.list || [];\n\nconst updates = [];\n\nfor (const article of articles) {\n  // æŸ¥æ‰¾å¯¹åº”çš„ç»Ÿè®¡æ•°æ®\n  const stat = stats.find(s => s.msgid === article.json.msg_id);\n  \n  if (stat) {\n    updates.push({\n      id: article.json.id,\n      read_count: stat.int_page_read_count || 0,\n      like_count: stat.like_count || 0,\n      share_count: stat.share_count || 0,\n      comment_count: stat.comment_count || 0,\n      updated_at: new Date().toISOString()\n    });\n  }\n}\n\nreturn updates.map(update => ({ json: update }));"
      },
      "id": "process-stats",
      "name": "å¤„ç†ç»Ÿè®¡æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 1000]
    },
    {
      "parameters": {
        "operation": "update",
        "table": "wechat_articles",
        "updateKey": "id",
        "columns": "read_count, like_count, share_count, comment_count, updated_at"
      },
      "id": "update-stats",
      "name": "æ›´æ–°ç»Ÿè®¡æ•°æ®",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1120, 1000],
      "credentials": {
        "postgres": {
          "id": "postgres-aloha",
          "name": "Aloha PostgreSQL"
        }
      }
    }
  ],
  "connections": {
    "å‘å¸ƒæ—¶é—´è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "è·å–å¾…å‘å¸ƒæ–‡ç« ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–å¾…å‘å¸ƒæ–‡ç« ": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ç« ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ç« ": {
      "main": [
        [
          {
            "node": "è·å–è®¿é—®ä»¤ç‰Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–è®¿é—®ä»¤ç‰Œ": {
      "main": [
        [
          {
            "node": "å‘å¸ƒæ–‡ç« ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘å¸ƒæ–‡ç« ": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥å‘å¸ƒç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥å‘å¸ƒç»“æœ": {
      "main": [
        [
          {
            "node": "æ›´æ–°æ–‡ç« çŠ¶æ€",
            "type": "main",
            "index": 0
          },
          {
            "node": "å‘å¸ƒæˆåŠŸé€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ›´æ–°é”™è¯¯çŠ¶æ€",
            "type": "main",
            "index": 0
          },
          {
            "node": "å‘å¸ƒå¤±è´¥é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ•°æ®ç»Ÿè®¡è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "è·å–å·²å‘å¸ƒæ–‡ç« ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–å·²å‘å¸ƒæ–‡ç« ": {
      "main": [
        [
          {
            "node": "è·å–æ–‡ç« ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–æ–‡ç« ç»Ÿè®¡": {
      "main": [
        [
          {
            "node": "å¤„ç†ç»Ÿè®¡æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†ç»Ÿè®¡æ•°æ®": {
      "main": [
        [
          {
            "node": "æ›´æ–°ç»Ÿè®¡æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-01-04T14:30:00.000Z",
      "updatedAt": "2025-01-04T14:30:00.000Z",
      "id": "wechat-publisher",
      "name": "å¾®ä¿¡å‘å¸ƒå™¨"
    }
  ],
  "triggerCount": 2,
  "updatedAt": "2025-01-04T14:30:00.000Z",
  "versionId": "1"
}
