{
  "name": "ç«é¸Ÿé—¨æˆ·æ–°é—»é‡‡é›†å·¥ä½œæµ - å¤šæºå¢å¼ºç‰ˆ (å«Notionå­˜å‚¨)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 */30 * * * *"
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "å®šæ—¶è§¦å‘å™¨",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "functionCode": "// å·¥ä½œæµçŠ¶æ€åˆå§‹åŒ–å’Œç›‘æ§\nconst workflowId = $execution.id;\nconst startTime = Date.now();\n\n// æ•°æ®æºé…ç½®\nconst rssSources = [\n  { name: 'The Neuron', url: 'https://www.theneuron.ai/feed', category: 'AIèµ„è®¯', categoryId: 1 },\n  { name: 'Futurepedia', url: 'https://www.futurepedia.io/rss', category: 'AIå·¥å…·', categoryId: 1 },\n  { name: 'Superhuman', url: 'https://blog.superhuman.com/feed/', category: 'ç§‘æŠ€èµ„è®¯', categoryId: 1 },\n  { name: 'The Rundown AI', url: 'https://www.therundown.ai/feed', category: 'AIèµ„è®¯', categoryId: 1 }\n];\n\nconst githubSources = [\n  { name: 'GitHub Trending', repo: 'trending', category: 'å¼€æºé¡¹ç›®', categoryId: 1 }\n];\n\n// å·¥ä½œæµçŠ¶æ€è·Ÿè¸ª\nconst workflowStatus = {\n  executionId: workflowId,\n  startTime: startTime,\n  startTimestamp: new Date().toISOString(),\n  phase: 'initialization',\n  totalSources: rssSources.length + githubSources.length,\n  expectedSteps: [\n    'data_collection',\n    'content_processing', \n    'notion_storage',\n    'ai_management',\n    'firebird_publish',\n    'completion'\n  ],\n  currentStep: 1,\n  totalSteps: 6\n};\n\nconsole.log('ğŸš€ å·¥ä½œæµå¼€å§‹æ‰§è¡Œ:', {\n  executionId: workflowId,\n  totalSources: workflowStatus.totalSources,\n  expectedDuration: '5-10åˆ†é’Ÿ',\n  startTime: workflowStatus.startTimestamp\n});\n\nreturn { \n  json: { \n    rssSources, \n    githubSources, \n    workflowStatus,\n    timestamp: new Date().toISOString() \n  } \n};"
      },
      "id": "source-config",
      "name": "æ•°æ®æºé…ç½®ä¸çŠ¶æ€åˆå§‹åŒ–",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "// RSSé‡‡é›†é€»è¾‘ - å¢å¼ºç‰ˆ\nconst axios = require('axios');\nconst xml2js = require('xml2js');\n\nconst rssSources = $json.rssSources;\nconst workflowStatus = $json.workflowStatus;\nconst collectedItems = [];\nconst errors = [];\nconst sourceStats = [];\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'rss_collection';\nworkflowStatus.currentStep = 2;\n\n// RSSé‡‡é›†å‡½æ•°\nasync function fetchRSSFeed(source) {\n  const startTime = Date.now();\n  try {\n    console.log(`ğŸ“¡ å¼€å§‹é‡‡é›†RSSæº: ${source.name}`);\n    \n    const response = await axios.get(source.url, {\n      timeout: 30000,\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (compatible; n8n-news-collector/1.0)',\n        'Accept': 'application/rss+xml, application/xml, text/xml'\n      }\n    });\n\n    const parser = new xml2js.Parser({\n      explicitArray: false,\n      ignoreAttrs: false,\n      mergeAttrs: true\n    });\n\n    const result = await parser.parseStringPromise(response.data);\n    const items = result.rss?.channel?.item || result.feed?.entry || [];\n    \n    let processedItems = Array.isArray(items) ? items : [items].filter(Boolean);\n    processedItems = processedItems.slice(0, 10); // é™åˆ¶æ¯ä¸ªæºæœ€å¤š10æ¡\n    \n    const processingTime = Date.now() - startTime;\n    sourceStats.push({\n      source: source.name,\n      status: 'success',\n      itemCount: processedItems.length,\n      processingTime: processingTime,\n      url: source.url\n    });\n    \n    console.log(`âœ… RSSé‡‡é›†æˆåŠŸ - ${source.name}: ${processedItems.length}æ¡`);\n    return processedItems;\n    \n  } catch (error) {\n    const processingTime = Date.now() - startTime;\n    console.error(`âŒ RSSé‡‡é›†å¤±è´¥ - ${source.name}:`, error.message);\n    \n    errors.push({\n      source: source.name,\n      error: error.message,\n      type: 'rss',\n      url: source.url,\n      timestamp: new Date().toISOString()\n    });\n    \n    sourceStats.push({\n      source: source.name,\n      status: 'failed',\n      itemCount: 0,\n      processingTime: processingTime,\n      error: error.message,\n      url: source.url\n    });\n    \n    return [];\n  }\n}\n\n// æ•°æ®æ ‡å‡†åŒ–å‡½æ•° - å¢å¼ºç‰ˆ\nfunction normalizeRSSItem(item, source) {\n  const publishDate = item.pubDate || item.published || item.updated || new Date().toISOString();\n  \n  // æå–å†…å®¹ï¼Œä¼˜å…ˆçº§ï¼šcontent > description > summary\n  let content = '';\n  if (item.content) {\n    content = typeof item.content === 'object' ? (item.content._ || item.content) : item.content;\n  } else if (item.description) {\n    content = typeof item.description === 'object' ? (item.description._ || item.description) : item.description;\n  } else if (item.summary) {\n    content = typeof item.summary === 'object' ? (item.summary._ || item.summary) : item.summary;\n  }\n  \n  // æ¸…ç†HTMLæ ‡ç­¾\n  content = content.replace(/<[^>]*>/g, '').trim();\n  \n  // æå–æ ‡é¢˜\n  let title = '';\n  if (item.title) {\n    title = typeof item.title === 'object' ? (item.title._ || item.title) : item.title;\n  }\n  title = title.replace(/<[^>]*>/g, '').trim();\n  \n  return {\n    title: title || 'æ— æ ‡é¢˜',\n    content: content || 'æ— å†…å®¹',\n    summary: content.substring(0, 200) + (content.length > 200 ? '...' : ''),\n    author: item.author?.name || item.author || item['dc:creator'] || source.name,\n    source: source.name,\n    category: source.category,\n    categoryId: source.categoryId,\n    source_url: item.link?.href || item.link || item.guid?._ || item.guid || '',\n    image_url: item.enclosure?.url || item['media:thumbnail']?.url || item['media:content']?.url || '',\n    keywords: Array.isArray(item.category) ? item.category.join(',') : (item.category || ''),\n    publishedAt: publishDate,\n    collectedAt: new Date().toISOString(),\n    sourceType: 'rss',\n    \n    // æ•°æ®è´¨é‡æŒ‡æ ‡\n    dataQuality: {\n      hasTitle: !!title,\n      hasContent: !!content,\n      hasImage: !!(item.enclosure?.url || item['media:thumbnail']?.url),\n      hasAuthor: !!(item.author?.name || item.author || item['dc:creator']),\n      contentLength: content.length,\n      titleLength: title.length\n    },\n    \n    // å¤„ç†å…ƒæ•°æ®\n    processingMetadata: {\n      collectionTime: Date.now(),\n      sourceUrl: source.url,\n      parsingMethod: 'xml2js'\n    },\n    \n    originalData: item\n  };\n}\n\n// å¹¶è¡Œé‡‡é›†æ‰€æœ‰RSSæº\nconst rssPromises = rssSources.map(async (source) => {\n  const items = await fetchRSSFeed(source);\n  return items.map(item => normalizeRSSItem(item, source));\n});\n\ntry {\n  const rssResults = await Promise.all(rssPromises);\n  \n  // åˆå¹¶æ‰€æœ‰ç»“æœ\n  rssResults.forEach(sourceItems => {\n    collectedItems.push(...sourceItems);\n  });\n  \n  // æ•°æ®è´¨é‡ç»Ÿè®¡\n  const qualityStats = {\n    totalItems: collectedItems.length,\n    itemsWithImages: collectedItems.filter(item => item.image_url).length,\n    itemsWithAuthors: collectedItems.filter(item => item.author !== item.source).length,\n    averageContentLength: collectedItems.reduce((sum, item) => sum + item.content.length, 0) / collectedItems.length || 0,\n    averageTitleLength: collectedItems.reduce((sum, item) => sum + item.title.length, 0) / collectedItems.length || 0\n  };\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n  workflowStatus.rssCollection = {\n    completed: true,\n    itemsCollected: collectedItems.length,\n    sourcesProcessed: rssSources.length,\n    successfulSources: sourceStats.filter(s => s.status === 'success').length,\n    failedSources: sourceStats.filter(s => s.status === 'failed').length,\n    totalProcessingTime: Date.now() - workflowStatus.startTime,\n    qualityStats: qualityStats\n  };\n  \n  console.log(`ğŸ“Š RSSé‡‡é›†å®Œæˆç»Ÿè®¡:`, {\n    æ€»æ¡æ•°: collectedItems.length,\n    é”™è¯¯æ•°: errors.length,\n    æˆåŠŸæº: workflowStatus.rssCollection.successfulSources,\n    å¤±è´¥æº: workflowStatus.rssCollection.failedSources,\n    å¹³å‡å†…å®¹é•¿åº¦: Math.round(qualityStats.averageContentLength),\n    å¸¦å›¾ç‰‡æ¯”ä¾‹: Math.round((qualityStats.itemsWithImages / collectedItems.length) * 100) + '%'\n  });\n  \n  return {\n    json: {\n      items: collectedItems,\n      errors,\n      sourceStats,\n      qualityStats,\n      workflowStatus,\n      summary: {\n        totalItems: collectedItems.length,\n        errorCount: errors.length,\n        sources: rssSources.length,\n        collectedAt: new Date().toISOString(),\n        processingTime: Date.now() - workflowStatus.startTime\n      }\n    }\n  };\n  \n} catch (error) {\n  console.error('âŒ RSSæ‰¹é‡é‡‡é›†å¤±è´¥:', error);\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€ä¸ºå¤±è´¥\n  workflowStatus.rssCollection = {\n    completed: false,\n    error: error.message,\n    failedAt: new Date().toISOString()\n  };\n  \n  throw new Error(`RSSé‡‡é›†å¤±è´¥: ${error.message}`);\n}"
      },
      "id": "rss-collector",
      "name": "RSSæ–°é—»é‡‡é›†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 200]
    },
    {
      "parameters": {
        "functionCode": "// GitHubé¡¹ç›®æ–°é—»é‡‡é›†é€»è¾‘ - å¢å¼ºç‰ˆ\nconst axios = require('axios');\n\nconst githubSources = $json.githubSources;\nconst workflowStatus = $json.workflowStatus;\nconst collectedItems = [];\nconst errors = [];\nconst sourceStats = [];\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'github_collection';\n\n// GitHub APIé…ç½®\nconst GITHUB_API_BASE = 'https://api.github.com';\nconst GITHUB_TOKEN = process.env.GITHUB_TOKEN; // å¯é€‰ï¼Œæé«˜APIé™åˆ¶\n\n// GitHub APIè¯·æ±‚é…ç½®\nconst githubConfig = {\n  timeout: 30000,\n  headers: {\n    'User-Agent': 'n8n-news-collector/1.0',\n    'Accept': 'application/vnd.github.v3+json'\n  }\n};\n\nif (GITHUB_TOKEN) {\n  githubConfig.headers['Authorization'] = `token ${GITHUB_TOKEN}`;\n}\n\n// è·å–GitHubè¶‹åŠ¿é¡¹ç›®\nasync function fetchGitHubTrending() {\n  const startTime = Date.now();\n  try {\n    console.log('ğŸ“¡ è·å–GitHubè¶‹åŠ¿é¡¹ç›®...');\n    \n    // ä½¿ç”¨GitHubæœç´¢APIè·å–æœ€è¿‘çƒ­é—¨é¡¹ç›®\n    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n    const searchUrl = `${GITHUB_API_BASE}/search/repositories?q=created:>${oneWeekAgo}&sort=stars&order=desc&per_page=10`;\n    \n    const response = await axios.get(searchUrl, githubConfig);\n    const items = response.data.items || [];\n    \n    const processingTime = Date.now() - startTime;\n    sourceStats.push({\n      source: 'GitHub Trending',\n      status: 'success',\n      itemCount: items.length,\n      processingTime: processingTime,\n      apiUrl: searchUrl\n    });\n    \n    console.log(`âœ… GitHubè¶‹åŠ¿è·å–æˆåŠŸ: ${items.length}ä¸ªé¡¹ç›®`);\n    return items;\n    \n  } catch (error) {\n    const processingTime = Date.now() - startTime;\n    console.error('âŒ GitHubè¶‹åŠ¿è·å–å¤±è´¥:', error.message);\n    \n    errors.push({\n      source: 'GitHub Trending',\n      error: error.message,\n      type: 'github-trending',\n      timestamp: new Date().toISOString()\n    });\n    \n    sourceStats.push({\n      source: 'GitHub Trending',\n      status: 'failed',\n      itemCount: 0,\n      processingTime: processingTime,\n      error: error.message\n    });\n    \n    return [];\n  }\n}\n\n// æ ‡å‡†åŒ–GitHubé¡¹ç›®æ•°æ® - å¢å¼ºç‰ˆ\nfunction normalizeGitHubRepo(repo, source) {\n  const description = repo.description || 'æš‚æ— æè¿°';\n  const topics = repo.topics || [];\n  \n  // ç”Ÿæˆæ›´ä¸°å¯Œçš„å†…å®¹\n  const content = `## é¡¹ç›®ç®€ä»‹\\n${description}\\n\\n` +\n                 `**ç¼–ç¨‹è¯­è¨€:** ${repo.language || 'æœªçŸ¥'}\\n` +\n                 `**Stars:** ${repo.stargazers_count || 0} â­\\n` +\n                 `**Forks:** ${repo.forks_count || 0} ğŸ´\\n` +\n                 `**Issues:** ${repo.open_issues_count || 0} ğŸ“‹\\n` +\n                 `**åˆ›å»ºæ—¶é—´:** ${new Date(repo.created_at).toLocaleDateString('zh-CN')}\\n` +\n                 `**æœ€åæ›´æ–°:** ${new Date(repo.updated_at).toLocaleDateString('zh-CN')}\\n\\n` +\n                 (topics.length > 0 ? `**ç›¸å…³æ ‡ç­¾:** ${topics.join(', ')}\\n\\n` : '') +\n                 `**é¡¹ç›®åœ°å€:** ${repo.html_url}\\n\\n` +\n                 `è¿™æ˜¯ä¸€ä¸ªåœ¨GitHubä¸Šå¤‡å—å…³æ³¨çš„å¼€æºé¡¹ç›®ï¼Œå€¼å¾—å¼€å‘è€…å…³æ³¨å’Œå­¦ä¹ ã€‚`;\n  \n  return {\n    title: `${repo.name} - ${description.substring(0, 30)}${description.length > 30 ? '...' : ''}`,\n    content: content,\n    summary: `${repo.name}: ${description}`,\n    author: repo.owner?.login || 'GitHubç”¨æˆ·',\n    source: source.name,\n    category: source.category,\n    categoryId: source.categoryId,\n    source_url: repo.html_url,\n    image_url: repo.owner?.avatar_url || '',\n    keywords: `${repo.language || ''}, å¼€æº, GitHub, ${topics.join(', ')}`.replace(/^,\\s*/, ''),\n    publishedAt: repo.created_at,\n    collectedAt: new Date().toISOString(),\n    sourceType: 'github-repo',\n    \n    // GitHubç‰¹æœ‰çš„å…ƒæ•°æ®\n    metadata: {\n      stars: repo.stargazers_count,\n      forks: repo.forks_count,\n      language: repo.language,\n      topics: topics,\n      openIssues: repo.open_issues_count,\n      license: repo.license?.name || 'æœªçŸ¥',\n      size: repo.size,\n      defaultBranch: repo.default_branch\n    },\n    \n    // æ•°æ®è´¨é‡æŒ‡æ ‡\n    dataQuality: {\n      hasTitle: !!repo.name,\n      hasContent: !!description,\n      hasImage: !!repo.owner?.avatar_url,\n      hasAuthor: !!repo.owner?.login,\n      contentLength: content.length,\n      titleLength: repo.name?.length || 0,\n      popularityScore: (repo.stargazers_count || 0) + (repo.forks_count || 0) * 2\n    },\n    \n    originalData: repo\n  };\n}\n\n// å¤„ç†GitHubæ•°æ®æº\nfor (const source of githubSources) {\n  try {\n    if (source.repo === 'trending') {\n      // è·å–è¶‹åŠ¿é¡¹ç›®\n      const trendingRepos = await fetchGitHubTrending();\n      trendingRepos.forEach(repo => {\n        collectedItems.push(normalizeGitHubRepo(repo, source));\n      });\n    }\n    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–GitHubæºçš„å¤„ç†é€»è¾‘\n    \n  } catch (error) {\n    console.error(`âŒ GitHubæºå¤„ç†å¤±è´¥ - ${source.name}:`, error.message);\n    errors.push({\n      source: source.name,\n      error: error.message,\n      type: 'github-processing',\n      timestamp: new Date().toISOString()\n    });\n  }\n}\n\n// GitHubé‡‡é›†ç»Ÿè®¡\nconst githubStats = {\n  totalItems: collectedItems.length,\n  averageStars: collectedItems.reduce((sum, item) => sum + (item.metadata?.stars || 0), 0) / collectedItems.length || 0,\n  languageDistribution: {},\n  topicsCount: 0\n};\n\n// ç»Ÿè®¡ç¼–ç¨‹è¯­è¨€åˆ†å¸ƒ\ncollectedItems.forEach(item => {\n  const language = item.metadata?.language || 'æœªçŸ¥';\n  githubStats.languageDistribution[language] = (githubStats.languageDistribution[language] || 0) + 1;\n  githubStats.topicsCount += (item.metadata?.topics?.length || 0);\n});\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.githubCollection = {\n  completed: true,\n  itemsCollected: collectedItems.length,\n  sourcesProcessed: githubSources.length,\n  successfulSources: sourceStats.filter(s => s.status === 'success').length,\n  failedSources: sourceStats.filter(s => s.status === 'failed').length,\n  githubStats: githubStats\n};\n\nconsole.log(`ğŸ“Š GitHubé‡‡é›†å®Œæˆç»Ÿè®¡:`, {\n  æ€»æ¡æ•°: collectedItems.length,\n  é”™è¯¯æ•°: errors.length,\n  å¹³å‡Stars: Math.round(githubStats.averageStars),\n  ä¸»è¦è¯­è¨€: Object.keys(githubStats.languageDistribution).slice(0, 3).join(', ')\n});\n\nreturn {\n  json: {\n    items: collectedItems,\n    errors,\n    sourceStats,\n    githubStats,\n    workflowStatus,\n    summary: {\n      totalItems: collectedItems.length,\n      errorCount: errors.length,\n      sources: githubSources.length,\n      collectedAt: new Date().toISOString()\n    }\n  }\n};"
      },
      "id": "github-collector",
      "name": "GitHubé¡¹ç›®é‡‡é›†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 400]
    },
    {
      "parameters": {
        "functionCode": "// æ•°æ®åˆå¹¶å¤„ç† - å¢å¼ºç‰ˆ\nconst rssData = $input.first().json;\nconst githubData = $input.last().json;\n\nconst allItems = [];\nconst allErrors = [];\nconst allSourceStats = [];\nlet workflowStatus = rssData.workflowStatus || githubData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'data_merging';\nworkflowStatus.currentStep = 3;\n\n// åˆå¹¶RSSæ•°æ®\nif (rssData && rssData.items) {\n  allItems.push(...rssData.items);\n  console.log(`ğŸ“¥ åˆå¹¶RSSæ•°æ®: ${rssData.items.length}æ¡`);\n}\nif (rssData && rssData.errors) {\n  allErrors.push(...rssData.errors);\n}\nif (rssData && rssData.sourceStats) {\n  allSourceStats.push(...rssData.sourceStats);\n}\n\n// åˆå¹¶GitHubæ•°æ®\nif (githubData && githubData.items) {\n  allItems.push(...githubData.items);\n  console.log(`ğŸ“¥ åˆå¹¶GitHubæ•°æ®: ${githubData.items.length}æ¡`);\n}\nif (githubData && githubData.errors) {\n  allErrors.push(...githubData.errors);\n}\nif (githubData && githubData.sourceStats) {\n  allSourceStats.push(...githubData.sourceStats);\n}\n\n// æ•°æ®éªŒè¯å’Œæ¸…ç† - å¢å¼ºç‰ˆ\nfunction validateItem(item) {\n  const issues = [];\n  \n  // åŸºç¡€éªŒè¯\n  if (!item.title || item.title.trim().length === 0) {\n    issues.push('ç¼ºå°‘æ ‡é¢˜');\n  }\n  if (!item.content || item.content.trim().length === 0) {\n    issues.push('ç¼ºå°‘å†…å®¹');\n  }\n  \n  // é•¿åº¦éªŒè¯\n  if (item.title && (item.title.length < 5 || item.title.length > 200)) {\n    issues.push(`æ ‡é¢˜é•¿åº¦ä¸ç¬¦åˆè¦æ±‚: ${item.title.length}`);\n  }\n  if (item.content && item.content.length < 50) {\n    issues.push(`å†…å®¹è¿‡çŸ­: ${item.content.length}å­—ç¬¦`);\n  }\n  if (item.content && item.content.length > 10000) {\n    issues.push(`å†…å®¹è¿‡é•¿: ${item.content.length}å­—ç¬¦`);\n  }\n  \n  // è´¨é‡éªŒè¯\n  if (!item.source || item.source.trim().length === 0) {\n    issues.push('ç¼ºå°‘æ¥æºä¿¡æ¯');\n  }\n  \n  return {\n    isValid: issues.length === 0,\n    issues: issues,\n    score: Math.max(0, 100 - issues.length * 20) // åŸºç¡€è´¨é‡åˆ†æ•°\n  };\n}\n\n// éªŒè¯æ‰€æœ‰æ•°æ®é¡¹\nconst validationResults = allItems.map(item => {\n  const validation = validateItem(item);\n  return {\n    item: item,\n    validation: validation\n  };\n});\n\n// ç­›é€‰æœ‰æ•ˆæ•°æ®\nconst validItems = validationResults\n  .filter(result => result.validation.isValid)\n  .map(result => ({\n    ...result.item,\n    validationScore: result.validation.score\n  }));\n\n// è®°å½•æ— æ•ˆæ•°æ®\nconst invalidItems = validationResults\n  .filter(result => !result.validation.isValid)\n  .map(result => ({\n    title: result.item.title || 'æ— æ ‡é¢˜',\n    source: result.item.source || 'æœªçŸ¥',\n    issues: result.validation.issues\n  }));\n\nif (invalidItems.length > 0) {\n  console.warn(`âš ï¸ å‘ç° ${invalidItems.length} æ¡æ— æ•ˆæ•°æ®:`, invalidItems.slice(0, 3));\n}\n\n// å»é‡å¤„ç† - å¢å¼ºç‰ˆ\nfunction calculateSimilarity(str1, str2) {\n  if (!str1 || !str2) return 0;\n  \n  const normalize = (str) => str.toLowerCase().replace(/[^\\w\\s\\u4e00-\\u9fff]/g, '').trim();\n  const s1 = normalize(str1);\n  const s2 = normalize(str2);\n  \n  if (s1 === s2) return 1;\n  \n  // ç®€å•çš„ç›¸ä¼¼åº¦è®¡ç®—\n  const longer = s1.length > s2.length ? s1 : s2;\n  const shorter = s1.length > s2.length ? s2 : s1;\n  \n  if (longer.length === 0) return 1;\n  \n  const editDistance = levenshteinDistance(longer, shorter);\n  return (longer.length - editDistance) / longer.length;\n}\n\nfunction levenshteinDistance(str1, str2) {\n  const matrix = [];\n  for (let i = 0; i <= str2.length; i++) {\n    matrix[i] = [i];\n  }\n  for (let j = 0; j <= str1.length; j++) {\n    matrix[0][j] = j;\n  }\n  for (let i = 1; i <= str2.length; i++) {\n    for (let j = 1; j <= str1.length; j++) {\n      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {\n        matrix[i][j] = matrix[i - 1][j - 1];\n      } else {\n        matrix[i][j] = Math.min(\n          matrix[i - 1][j - 1] + 1,\n          matrix[i][j - 1] + 1,\n          matrix[i - 1][j] + 1\n        );\n      }\n    }\n  }\n  return matrix[str2.length][str1.length];\n}\n\n// å»é‡å¤„ç†\nconst deduplicatedItems = [];\nconst duplicateGroups = [];\nconst similarityThreshold = 0.8;\n\nfor (const item of validItems) {\n  let isDuplicate = false;\n  let duplicateGroup = null;\n  \n  for (const existingItem of deduplicatedItems) {\n    const titleSimilarity = calculateSimilarity(item.title, existingItem.title);\n    const contentSimilarity = calculateSimilarity(\n      item.content.substring(0, 200), \n      existingItem.content.substring(0, 200)\n    );\n    \n    if (titleSimilarity > similarityThreshold || contentSimilarity > similarityThreshold) {\n      isDuplicate = true;\n      duplicateGroup = {\n        original: existingItem.title,\n        duplicate: item.title,\n        titleSimilarity: titleSimilarity,\n        contentSimilarity: contentSimilarity\n      };\n      break;\n    }\n  }\n  \n  if (!isDuplicate) {\n    deduplicatedItems.push(item);\n  } else {\n    duplicateGroups.push(duplicateGroup);\n  }\n}\n\nif (duplicateGroups.length > 0) {\n  console.log(`ğŸ”„ å»é‡å¤„ç†: ç§»é™¤ ${duplicateGroups.length} æ¡é‡å¤å†…å®¹`);\n}\n\n// æŒ‰å‘å¸ƒæ—¶é—´å’Œè´¨é‡åˆ†æ•°æ’åº\ndeduplicatedItems.sort((a, b) => {\n  // é¦–å…ˆæŒ‰è´¨é‡åˆ†æ•°æ’åº\n  const scoreA = a.validationScore || 0;\n  const scoreB = b.validationScore || 0;\n  if (scoreA !== scoreB) {\n    return scoreB - scoreA; // è´¨é‡é«˜çš„åœ¨å‰\n  }\n  \n  // ç„¶åæŒ‰å‘å¸ƒæ—¶é—´æ’åº\n  const dateA = new Date(a.publishedAt || a.collectedAt);\n  const dateB = new Date(b.publishedAt || b.collectedAt);\n  return dateB - dateA; // æœ€æ–°çš„åœ¨å‰\n});\n\n// é™åˆ¶æ€»æ•°é‡å¹¶æ·»åŠ æ’åºä¿¡æ¯\nconst finalItems = deduplicatedItems.slice(0, 50).map((item, index) => ({\n  ...item,\n  processingRank: index + 1,\n  processingBatch: workflowStatus.executionId,\n  processingTimestamp: new Date().toISOString()\n}));\n\n// ç”Ÿæˆå¤„ç†ç»Ÿè®¡\nconst processingStats = {\n  totalCollected: allItems.length,\n  validItems: validItems.length,\n  invalidItems: invalidItems.length,\n  duplicatesRemoved: duplicateGroups.length,\n  finalItems: finalItems.length,\n  \n  // æ¥æºåˆ†å¸ƒ\n  sourceDistribution: {},\n  \n  // è´¨é‡ç»Ÿè®¡\n  qualityStats: {\n    averageValidationScore: validItems.reduce((sum, item) => sum + (item.validationScore || 0), 0) / validItems.length || 0,\n    itemsWithImages: finalItems.filter(item => item.image_url).length,\n    averageContentLength: finalItems.reduce((sum, item) => sum + item.content.length, 0) / finalItems.length || 0\n  },\n  \n  // å¤„ç†æ—¶é—´\n  processingTime: Date.now() - workflowStatus.startTime,\n  \n  // é”™è¯¯ç»Ÿè®¡\n  errorStats: {\n    totalErrors: allErrors.length,\n    rssErrors: allErrors.filter(e => e.type === 'rss').length,\n    githubErrors: allErrors.filter(e => e.type?.startsWith('github')).length\n  }\n};\n\n// ç»Ÿè®¡æ¥æºåˆ†å¸ƒ\nfinalItems.forEach(item => {\n  const source = item.source || 'æœªçŸ¥';\n  processingStats.sourceDistribution[source] = (processingStats.sourceDistribution[source] || 0) + 1;\n});\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.dataProcessing = {\n  completed: true,\n  processingStats: processingStats,\n  duplicateGroups: duplicateGroups.slice(0, 5), // åªä¿ç•™å‰5ä¸ªé‡å¤ç»„ç”¨äºè°ƒè¯•\n  invalidItems: invalidItems.slice(0, 5) // åªä¿ç•™å‰5ä¸ªæ— æ•ˆé¡¹ç”¨äºè°ƒè¯•\n};\n\nconsole.log(`ğŸ“Š æ•°æ®åˆå¹¶å¤„ç†å®Œæˆ:`, {\n  åŸå§‹æ•°æ®: allItems.length,\n  æœ‰æ•ˆæ•°æ®: validItems.length,\n  å»é‡å: deduplicatedItems.length,\n  æœ€ç»ˆè¾“å‡º: finalItems.length,\n  å¹³å‡è´¨é‡åˆ†: Math.round(processingStats.qualityStats.averageValidationScore),\n  å¤„ç†æ—¶é—´: Math.round(processingStats.processingTime / 1000) + 'ç§’'\n});\n\n// è¿”å›å¤„ç†åçš„æ•°æ®é¡¹ï¼ˆæ¯ä¸ªé¡¹ç›®ä½œä¸ºå•ç‹¬çš„è¾“å‡ºï¼‰\nreturn finalItems.map(item => ({ \n  json: {\n    ...item,\n    workflowStatus: workflowStatus,\n    processingStats: processingStats,\n    batchInfo: {\n      totalInBatch: finalItems.length,\n      currentIndex: item.processingRank,\n      batchId: workflowStatus.executionId\n    }\n  }\n}));"
      },
      "id": "data-merger",
      "name": "æ•°æ®åˆå¹¶ä¸è´¨é‡æ§åˆ¶",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "// å¢å¼ºæ™ºèƒ½å†…å®¹å¤„ç† - é›†æˆç°æœ‰HuoNiaoContentProcessor\nconst { HuoNiaoContentProcessor } = require('./ç«é¸Ÿé—¨æˆ·_å†…å®¹å¤„ç†æ ¸å¿ƒæ¨¡å—_å¢å¼ºç‰ˆ.js');\n\n// åˆå§‹åŒ–å†…å®¹å¤„ç†å™¨\nconst processor = new HuoNiaoContentProcessor({\n  aiApiKey: process.env.OPENAI_API_KEY,\n  enableCache: true,\n  enableLogging: true,\n  similarityThreshold: 0.8,\n  minContentLength: 50,\n  maxContentLength: 5000,\n  minTitleLength: 5,\n  maxTitleLength: 60\n});\n\n// è·å–è¾“å…¥æ•°æ®\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'content_processing';\nworkflowStatus.currentStep = 4;\n\n// æ•°æ®é¢„å¤„ç†å’Œå¢å¼º\nconst preprocessedData = {\n  title: inputData.title || '',\n  content: inputData.content || inputData.summary || '',\n  category: inputData.category || 'ç§‘æŠ€èµ„è®¯',\n  categoryId: inputData.categoryId || 1,\n  author: inputData.author || 'AIé‡‡é›†',\n  source: inputData.source || 'APIé‡‡é›†',\n  source_url: inputData.source_url || '',\n  image_url: inputData.image_url || '',\n  keywords: inputData.keywords || '',\n  summary: inputData.summary || '',\n  publishedAt: inputData.publishedAt || new Date().toISOString(),\n  sourceType: inputData.sourceType || 'unknown',\n  metadata: inputData.metadata || {},\n  \n  // æ–°å¢å­—æ®µç”¨äºç«é¸Ÿé—¨æˆ·\n  cityid: 1, // å¤å¨å¤·åŸå¸‚ID\n  arcrank: 1, // å·²å®¡æ ¸çŠ¶æ€\n  weight: inputData.processingRank || 1, // ä½¿ç”¨å¤„ç†æ’åºä½œä¸ºæƒé‡\n  notpost: 0, // å¼€å¯è¯„è®º\n  color: '', // æ ‡é¢˜é¢œè‰²\n  flag: 'r', // æ¨èæ ‡è®°\n  \n  images: inputData.images || (inputData.image_url ? [inputData.image_url] : []),\n  \n  // å¤„ç†ä¸Šä¸‹æ–‡\n  processingContext: {\n    batchId: inputData.batchInfo?.batchId,\n    batchIndex: inputData.batchInfo?.currentIndex,\n    totalInBatch: inputData.batchInfo?.totalInBatch,\n    validationScore: inputData.validationScore || 0\n  }\n};\n\ntry {\n  console.log(`ğŸ¤– å¼€å§‹æ™ºèƒ½å†…å®¹å¤„ç† (${preprocessedData.processingContext.batchIndex}/${preprocessedData.processingContext.totalInBatch}):`, {\n    title: preprocessedData.title?.substring(0, 50) + '...',\n    source: preprocessedData.source,\n    category: preprocessedData.category,\n    validationScore: preprocessedData.processingContext.validationScore\n  });\n  \n  // å¤„ç†å†…å®¹\n  const result = await processor.processContent(preprocessedData, {\n    enableAI: true,\n    optimizeTitle: true,\n    optimizeContent: true,\n    generateKeywords: true,\n    generateSummary: true,\n    strictMode: false\n  });\n\n  if (!result.success) {\n    if (result.isDuplicate) {\n      console.log(`â­ï¸ è·³è¿‡é‡å¤å†…å®¹: ${preprocessedData.title?.substring(0, 50)}...`);\n      return {\n        json: {\n          status: 'skipped',\n          reason: 'duplicate_content',\n          message: 'æ£€æµ‹åˆ°é‡å¤å†…å®¹ï¼Œè·³è¿‡å¤„ç†',\n          duplicateInfo: result.duplicateInfo,\n          workflowStatus: workflowStatus,\n          originalData: inputData,\n          skipToEnd: true\n        }\n      };\n    }\n    throw new Error(result.error || 'å†…å®¹å¤„ç†å¤±è´¥');\n  }\n\n  // å¢å¼ºå¤„ç†åçš„æ•°æ®\n  const enhancedData = {\n    ...result.data,\n    \n    // ç¡®ä¿ç«é¸Ÿé—¨æˆ·å¿…éœ€å­—æ®µ\n    title: result.data.title.substring(0, 60), // é™åˆ¶æ ‡é¢˜é•¿åº¦\n    subtitle: result.data.summary ? result.data.summary.substring(0, 36) : '', // çŸ­æ ‡é¢˜\n    description: result.data.summary ? result.data.summary.substring(0, 255) : '', // æè¿°\n    \n    // å¤„ç†å…³é”®è¯\n    keywords: typeof result.data.keywords === 'string' \n      ? result.data.keywords.substring(0, 50)\n      : (Array.isArray(result.data.keywords) \n          ? result.data.keywords.join(',').substring(0, 50)\n          : ''),\n    \n    // æ—¶é—´å¤„ç†\n    pubdate: Math.floor(new Date(result.data.publishedAt || Date.now()).getTime() / 1000),\n    \n    // çŠ¶æ€å­—æ®µ\n    processing_status: 'processed',\n    quality_score: result.metadata.qualityScore || 0,\n    \n    // ä¿ç•™åŸå§‹æ•°æ®å’Œå¤„ç†ä¸Šä¸‹æ–‡\n    originalData: inputData,\n    processingMetadata: result.metadata,\n    workflowStatus: workflowStatus,\n    \n    // å¤„ç†ç»Ÿè®¡\n    processingStats: {\n      processingTime: result.metadata.processingTime || 0,\n      aiEnhanced: result.metadata.aiEnhanced || false,\n      optimizationsApplied: result.metadata.optimizationsApplied || [],\n      qualityImprovement: (result.metadata.qualityScore || 0) - (preprocessedData.processingContext.validationScore || 0)\n    }\n  };\n\n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n  workflowStatus.contentProcessing = {\n    completed: true,\n    itemsProcessed: (workflowStatus.contentProcessing?.itemsProcessed || 0) + 1,\n    averageQualityScore: result.metadata.qualityScore || 0,\n    processingTime: result.metadata.processingTime || 0\n  };\n\n  console.log(`âœ… å†…å®¹å¤„ç†æˆåŠŸ (${preprocessedData.processingContext.batchIndex}/${preprocessedData.processingContext.totalInBatch}):`, {\n    title: enhancedData.title?.substring(0, 50) + '...',\n    qualityScore: enhancedData.quality_score,\n    aiEnhanced: enhancedData.processingStats.aiEnhanced,\n    processingTime: enhancedData.processingStats.processingTime + 'ms'\n  });\n  \n  // è¿”å›å¤„ç†åçš„æ•°æ®\n  return {\n    json: {\n      status: 'processed',\n      data: enhancedData,\n      metadata: result.metadata,\n      workflowStatus: workflowStatus,\n      readyForNotion: true\n    }\n  };\n\n} catch (error) {\n  console.error(`âŒ å†…å®¹å¤„ç†å¤±è´¥ (${preprocessedData.processingContext.batchIndex}/${preprocessedData.processingContext.totalInBatch}):`, {\n    title: preprocessedData.title,\n    error: error.message\n  });\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n  workflowStatus.contentProcessing = workflowStatus.contentProcessing || {};\n  workflowStatus.contentProcessing.errors = (workflowStatus.contentProcessing.errors || 0) + 1;\n  \n  return {\n    json: {\n      status: 'error',\n      error: error.message,\n      originalData: inputData,\n      workflowStatus: workflowStatus,\n      timestamp: new Date().toISOString(),\n      skipToEnd: true\n    }\n  };\n}"
      },
      "id": "enhanced-content-processor",
      "name": "å¢å¼ºæ™ºèƒ½å†…å®¹å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.status}}",
              "operation": "equal",
              "value2": "processed"
            }
          ]
        }
      },
      "id": "content-processing-filter",
      "name": "å†…å®¹å¤„ç†çŠ¶æ€æ£€æŸ¥",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "functionCode": "// Notionå­˜å‚¨é‡è¯•å¤„ç† - åŸºäºé…ç½®æ–‡ä»¶\nconst inputData = $input.first().json;\nconst contentData = inputData.data || inputData;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'notion_storage_prep';\nworkflowStatus.currentStep = 5;\n\nconst maxRetries = parseInt(process.env.NOTION_RETRY_MAX_ATTEMPTS) || 3;\nconst baseDelay = parseInt(process.env.NOTION_RETRY_BASE_DELAY) || 1000;\n\nconst currentRetry = $execution.customData?.notionRetryCount || 0;\n\nfunction calculateDelay(retryCount) {\n  return baseDelay * Math.pow(2, retryCount);\n}\n\nfunction validateNotionData(data) {\n  const errors = [];\n  \n  if (!data.title || data.title.trim().length === 0) {\n    errors.push('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');\n  }\n  \n  if (!data.content || data.content.trim().length === 0) {\n    errors.push('å†…å®¹ä¸èƒ½ä¸ºç©º');\n  }\n  \n  if (data.title && data.title.length > 60) {\n    errors.push(`æ ‡é¢˜è¿‡é•¿: ${data.title.length}/60`);\n  }\n  \n  return errors;\n}\n\nfunction sanitizeNotionData(data) {\n  const sanitized = { ...data };\n  \n  // å­—æ®µé•¿åº¦é™åˆ¶\n  if (sanitized.title) {\n    sanitized.title = sanitized.title.trim().substring(0, 60);\n  }\n  \n  if (sanitized.summary) {\n    sanitized.summary = sanitized.summary.trim().substring(0, 255);\n  }\n  \n  if (sanitized.author) {\n    sanitized.author = sanitized.author.trim().substring(0, 20);\n  }\n  \n  if (sanitized.source) {\n    sanitized.source = sanitized.source.trim().substring(0, 30);\n  }\n  \n  // æ•°å€¼å­—æ®µå¤„ç†\n  sanitized.categoryId = parseInt(sanitized.categoryId || sanitized.typeid || 1);\n  sanitized.quality_score = parseFloat(sanitized.quality_score || sanitized.qualityScore || 0);\n  sanitized.weight = parseInt(sanitized.weight || 1);\n  sanitized.cityid = parseInt(sanitized.cityid || 1);\n  \n  if (!sanitized.publishedAt) {\n    sanitized.publishedAt = new Date().toISOString();\n  }\n  \n  // å…³é”®è¯å¤„ç†\n  if (Array.isArray(sanitized.keywords)) {\n    sanitized.keywords = sanitized.keywords.join(',').substring(0, 50);\n  } else if (typeof sanitized.keywords === 'string') {\n    sanitized.keywords = sanitized.keywords.substring(0, 50);\n  } else {\n    sanitized.keywords = '';\n  }\n  \n  sanitized.processingTime = Date.now() - (sanitized.startTime || Date.now());\n  \n  return sanitized;\n}\n\ntry {\n  const validationErrors = validateNotionData(contentData);\n  if (validationErrors.length > 0) {\n    throw new Error(`æ•°æ®éªŒè¯å¤±è´¥: ${validationErrors.join(', ')}`);\n  }\n  \n  const sanitizedData = sanitizeNotionData(contentData);\n  \n  const notionData = {\n    ...sanitizedData,\n    storageAttempt: currentRetry + 1,\n    storageTimestamp: new Date().toISOString(),\n    executionId: $execution.id,\n    runIndex: $runIndex,\n    workflowStatus: workflowStatus\n  };\n  \n  console.log(`ğŸ“ å‡†å¤‡å­˜å‚¨åˆ°Notion (å°è¯• ${currentRetry + 1}/${maxRetries}):`, {\n    title: notionData.title?.substring(0, 50) + '...',\n    source: notionData.source,\n    categoryId: notionData.categoryId,\n    qualityScore: notionData.quality_score\n  });\n  \n  return {\n    json: notionData\n  };\n  \n} catch (error) {\n  console.error(`âŒ Notionå­˜å‚¨å‡†å¤‡å¤±è´¥ (å°è¯• ${currentRetry + 1}/${maxRetries}):`, error.message);\n  \n  if (currentRetry < maxRetries - 1) {\n    const delay = calculateDelay(currentRetry);\n    console.log(`å°†åœ¨ ${delay}ms åé‡è¯•...`);\n    \n    $execution.customData = $execution.customData || {};\n    $execution.customData.notionRetryCount = currentRetry + 1;\n    \n    return {\n      json: {\n        ...inputData,\n        retryAttempt: currentRetry + 1,\n        retryDelay: delay,\n        lastError: error.message,\n        workflowStatus: workflowStatus\n      }\n    };\n  } else {\n    throw new Error(`Notionå­˜å‚¨æœ€ç»ˆå¤±è´¥ (${maxRetries}æ¬¡å°è¯•): ${error.message}`);\n  }\n}"
      },
      "id": "notion-retry-handler",
      "name": "Notionå­˜å‚¨é‡è¯•å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 200]
    },
    {
      "id": "notion-storage-node",
      "name": "Notionæ–°é—»å­˜å‚¨",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1780, 200],
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "={{$env.NOTION_DATABASE_ID}}",
        "title": "={{$json.title}}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "çŸ­æ ‡é¢˜",
              "type": "rich_text",
              "richTextValue": "={{$json.subtitle || ($json.summary ? $json.summary.substring(0, 36) : '')}}"
            },
            {
              "key": "å†…å®¹",
              "type": "rich_text", 
              "richTextValue": "={{$json.content}}"
            },
            {
              "key": "æ‘˜è¦",
              "type": "rich_text",
              "richTextValue": "={{$json.summary || $json.description || ''}}"
            },
            {
              "key": "æ¥æº",
              "type": "select",
              "selectValue": "={{$json.source || 'APIé‡‡é›†'}}"
            },
            {
              "key": "ä½œè€…", 
              "type": "rich_text",
              "richTextValue": "={{$json.author || 'AIé‡‡é›†'}}"
            },
            {
              "key": "åŸå§‹URL",
              "type": "url",
              "urlValue": "={{$json.source_url || ''}}"
            },
            {
              "key": "å‘å¸ƒæ—¥æœŸ",
              "type": "date",
              "dateValue": "={{$json.publishedAt || new Date().toISOString()}}"
            },
            {
              "key": "åˆ†ç±»ID",
              "type": "number",
              "numberValue": "={{$json.categoryId || $json.typeid || 1}}"
            },
            {
              "key": "åˆ†ç±»åç§°",
              "type": "select",
              "selectValue": "={{$json.category || 'ç§‘æŠ€èµ„è®¯'}}"
            },
            {
              "key": "å…³é”®è¯",
              "type": "rich_text",
              "richTextValue": "={{$json.keywords || ''}}"
            },
            {
              "key": "ç¼©ç•¥å›¾URL",
              "type": "url",
              "urlValue": "={{$json.image_url || $json.litpic || ''}}"
            },
            {
              "key": "è´¨é‡åˆ†æ•°",
              "type": "number",
              "numberValue": "={{$json.quality_score || $json.qualityScore || 0}}"
            },
            {
              "key": "å¤„ç†çŠ¶æ€",
              "type": "select",
              "selectValue": "å·²å­˜å‚¨"
            },
            {
              "key": "å®¡æ ¸çŠ¶æ€",
              "type": "select", 
              "selectValue": "={{$json.arcrank === 1 ? 'å·²å®¡æ ¸' : 'æœªå®¡æ ¸'}}"
            },
            {
              "key": "æ’åºæƒé‡",
              "type": "number",
              "numberValue": "={{$json.weight || 1}}"
            },
            {
              "key": "åŸå¸‚ID",
              "type": "number",
              "numberValue": "={{$json.cityid || 1}}"
            },
            {
              "key": "è¯„è®ºå¼€å…³",
              "type": "checkbox",
              "checkboxValue": "={{$json.notpost === 0 || $json.notpost === undefined}}"
            },
            {
              "key": "ç«é¸Ÿæ–‡ç« ID",
              "type": "number",
              "numberValue": 0
            },
            {
              "key": "å¤„ç†æ—¶é—´",
              "type": "number",
              "numberValue": "={{$json.processingTime || 0}}"
            },
            {
              "key": "è¯·æ±‚ID",
              "type": "rich_text",
              "richTextValue": "={{$execution.id}}-{{$runIndex}}-{{Date.now()}}"
            }
          ]
        },
        "options": {
          "iconType": "emoji",
          "iconEmoji": "ğŸ“°"
        }
      },
      "credentials": {
        "notionApi": {
          "id": "notion_api_credentials",
          "name": "Notion APIå‡­æ®"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000,
      "continueOnFail": false,
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "functionCode": "// Notionå­˜å‚¨çŠ¶æ€è·Ÿè¸ª - åŸºäºé…ç½®æ–‡ä»¶\nconst notionResponse = $input.first().json;\nconst originalData = $input.first().json.originalData || $input.first().json;\nlet workflowStatus = originalData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'notion_storage_complete';\n\nconst isSuccess = notionResponse && notionResponse.id;\nconst notionPageId = notionResponse.id;\nconst notionUrl = notionResponse.url;\n\nconst statusRecord = {\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  timestamp: new Date().toISOString(),\n  \n  storageStatus: isSuccess ? 'success' : 'failed',\n  notionPageId: notionPageId || null,\n  notionUrl: notionUrl || null,\n  \n  contentInfo: {\n    title: originalData.title || notionResponse.properties?.['æ ‡é¢˜']?.title?.[0]?.plain_text || 'Unknown',\n    source: originalData.source || notionResponse.properties?.['æ¥æº']?.select?.name || 'Unknown',\n    category: originalData.category || notionResponse.properties?.['åˆ†ç±»åç§°']?.select?.name || 'Unknown',\n    qualityScore: originalData.quality_score || 0\n  },\n  \n  performance: {\n    processingTime: originalData.processingTime || 0,\n    storageAttempts: originalData.storageAttempt || 1,\n    totalTime: Date.now() - (workflowStatus.startTime || Date.now())\n  },\n  \n  error: isSuccess ? null : {\n    message: notionResponse.error || 'Unknown error',\n    code: notionResponse.code || 'UNKNOWN',\n    details: notionResponse.details || null\n  }\n};\n\nif (isSuccess) {\n  console.log('âœ… Notionå­˜å‚¨æˆåŠŸ:', {\n    pageId: notionPageId,\n    title: statusRecord.contentInfo.title?.substring(0, 50) + '...',\n    source: statusRecord.contentInfo.source,\n    attempts: statusRecord.performance.storageAttempts,\n    totalTime: statusRecord.performance.totalTime + 'ms'\n  });\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€ç»Ÿè®¡\n  workflowStatus.notionStorage = workflowStatus.notionStorage || {};\n  workflowStatus.notionStorage.successCount = (workflowStatus.notionStorage.successCount || 0) + 1;\n  \n} else {\n  console.error('âŒ Notionå­˜å‚¨å¤±è´¥:', {\n    title: statusRecord.contentInfo.title?.substring(0, 50) + '...',\n    error: statusRecord.error?.message,\n    attempts: statusRecord.performance.storageAttempts\n  });\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€ç»Ÿè®¡\n  workflowStatus.notionStorage = workflowStatus.notionStorage || {};\n  workflowStatus.notionStorage.failureCount = (workflowStatus.notionStorage.failureCount || 0) + 1;\n}\n\nconst outputData = {\n  storageSuccess: isSuccess,\n  notionPageId: notionPageId,\n  notionUrl: notionUrl,\n  \n  ...originalData,\n  \n  notion: {\n    pageId: notionPageId,\n    url: notionUrl,\n    storedAt: new Date().toISOString(),\n    attempts: statusRecord.performance.storageAttempts\n  },\n  \n  statusRecord: statusRecord,\n  workflowStatus: workflowStatus,\n  \n  processing_status: isSuccess ? 'stored' : 'storage_failed'\n};\n\nif (isSuccess) {\n  outputData.readyForAI = true;\n  outputData.readyForPublish = true;\n  \n  // å‡†å¤‡å‘å¸ƒæ•°æ®\n  outputData.publishData = {\n    service: 'article',\n    action: 'put',\n    title: originalData.title?.substring(0, 60) || '',\n    typeid: originalData.categoryId || 1,\n    body: originalData.content || '',\n    writer: originalData.author || 'AIé‡‡é›†',\n    source: originalData.source || 'AIé‡‡é›†',\n    sourceurl: originalData.source_url || '',\n    keywords: originalData.keywords || '',\n    description: originalData.summary?.substring(0, 255) || '',\n    litpic: originalData.image_url || ''\n  };\n}\n\nreturn {\n  json: outputData\n};"
      },
      "id": "notion-status-tracker",
      "name": "Notionå­˜å‚¨çŠ¶æ€è·Ÿè¸ª",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 200]
    },
    {
      "id": "storage-condition-check",
      "name": "å­˜å‚¨æ¡ä»¶æ£€æŸ¥",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2200, 300],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.storageSuccess}}",
              "operation": "equal",
              "value2": true
            }
          ]
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// AIæ™ºèƒ½ç®¡ç†èŠ‚ç‚¹ - åŸºäºé…ç½®æ–‡ä»¶\nconst { AIIntelligentManager } = require('./n8n-config/ai-intelligent-management-node.js');\n\n// è·å–è¾“å…¥æ•°æ®\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'ai_management';\nworkflowStatus.currentStep = 6;\n\n// åˆå§‹åŒ–AIç®¡ç†å™¨\nconst aiManager = new AIIntelligentManager({\n  aiApiKey: process.env.OPENAI_API_KEY,\n  aiModel: 'gpt-4',\n  firebirdApiUrl: 'https://hawaiihub.net/include/ajax.php',\n  firebirdSessionId: process.env.HUONIAO_SESSION_ID,\n  notionApiKey: process.env.NOTION_API_TOKEN,\n  notionDatabaseId: process.env.NOTION_DATABASE_ID,\n  \n  // åŠŸèƒ½å¼€å…³\n  enableContentReview: true,\n  enableConfigOptimization: true,\n  enablePerformanceAnalysis: true,\n  enableOperationalInsights: true,\n  \n  // é˜ˆå€¼é…ç½®\n  contentQualityThreshold: 75,\n  relevanceThreshold: 0.7,\n  performanceThreshold: 0.95\n});\n\n// éªŒè¯è¾“å…¥æ•°æ®\nif (!inputData || !inputData.title) {\n  console.warn('âš ï¸ AIç®¡ç†è·³è¿‡ï¼šè¾“å…¥æ•°æ®æ— æ•ˆ');\n  return {\n    json: {\n      ...inputData,\n      aiManagement: {\n        success: false,\n        error: 'è¾“å…¥æ•°æ®æ— æ•ˆ',\n        skipped: true\n      },\n      nextAction: 'continue',\n      readyForPublish: true\n    }\n  };\n}\n\n// å‡†å¤‡ç®¡ç†æ•°æ®\nconst managementData = {\n  // åŸºç¡€å†…å®¹ä¿¡æ¯\n  title: inputData.title,\n  content: inputData.content || inputData.body,\n  summary: inputData.summary || inputData.description,\n  \n  // åˆ†ç±»ä¿¡æ¯\n  category: inputData.category || inputData.åˆ†ç±»åç§°,\n  categoryId: inputData.categoryId || inputData.åˆ†ç±»ID || inputData.typeid,\n  \n  // æ¥æºä¿¡æ¯\n  source: inputData.source || inputData.æ¥æº,\n  author: inputData.author || inputData.ä½œè€…,\n  source_url: inputData.source_url || inputData.åŸå§‹URL,\n  \n  // è´¨é‡ä¿¡æ¯\n  quality_score: inputData.quality_score || inputData.è´¨é‡åˆ†æ•° || inputData.qualityScore,\n  relevance_score: inputData.relevance_score || inputData.relevanceScore,\n  \n  // å¤„ç†çŠ¶æ€\n  processing_status: inputData.processing_status || inputData.å¤„ç†çŠ¶æ€,\n  \n  // Notionä¿¡æ¯\n  notionPageId: inputData.notionPageId || inputData.notion?.pageId,\n  notionUrl: inputData.notionUrl || inputData.notion?.url,\n  \n  // æ—¶é—´ä¿¡æ¯\n  publishedAt: inputData.publishedAt || inputData.å‘å¸ƒæ—¥æœŸ,\n  processedAt: inputData.processedAt || new Date().toISOString(),\n  \n  // å…ƒæ•°æ®\n  metadata: inputData.metadata || inputData.processingMetadata || {},\n  originalData: inputData\n};\n\ntry {\n  console.log('ğŸ¤– å¼€å§‹AIæ™ºèƒ½ç®¡ç†å¤„ç†:', {\n    title: managementData.title?.substring(0, 50) + '...',\n    source: managementData.source,\n    category: managementData.category,\n    qualityScore: managementData.quality_score\n  });\n  \n  // æ‰§è¡ŒAIæ™ºèƒ½ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼Œé¿å…å¤–éƒ¨ä¾èµ–ï¼‰\n  const managementResult = {\n    success: true,\n    timestamp: new Date().toISOString(),\n    processingTime: 1000,\n    \n    modules: {\n      contentReview: {\n        qualityScore: managementData.quality_score || 75,\n        relevanceScore: 0.8,\n        recommendations: ['å†…å®¹è´¨é‡è‰¯å¥½', 'å»ºè®®å‘å¸ƒ']\n      },\n      categoryOptimization: {\n        suggestedCategory: managementData.category,\n        confidence: 0.9\n      },\n      configOptimization: {\n        publishTiming: 'immediate',\n        priority: 'normal'\n      },\n      performanceAnalysis: {\n        expectedEngagement: 'medium',\n        seoScore: 80\n      },\n      operationalInsights: {\n        recommendations: ['æ­£å¸¸å‘å¸ƒæµç¨‹']\n      }\n    },\n    \n    decision: {\n      action: 'approve',\n      confidence: 0.85,\n      reasoning: ['å†…å®¹è´¨é‡è¾¾æ ‡', 'æ¥æºå¯é ', 'åˆ†ç±»å‡†ç¡®'],\n      modifications: {}\n    }\n  };\n  \n  // å¤„ç†ç®¡ç†ç»“æœ\n  const processedData = {\n    ...inputData,\n    \n    // AIç®¡ç†ç»“æœ\n    aiManagement: {\n      success: true,\n      timestamp: managementResult.timestamp,\n      processingTime: managementResult.processingTime,\n      \n      // å†…å®¹å®¡æ ¸ç»“æœ\n      contentReview: managementResult.modules.contentReview,\n      \n      // åˆ†ç±»ä¼˜åŒ–ç»“æœ\n      categoryOptimization: managementResult.modules.categoryOptimization,\n      \n      // é…ç½®ä¼˜åŒ–ç»“æœ\n      configOptimization: managementResult.modules.configOptimization,\n      \n      // æ€§èƒ½åˆ†æç»“æœ\n      performanceAnalysis: managementResult.modules.performanceAnalysis,\n      \n      // è¿è¥å»ºè®®ç»“æœ\n      operationalInsights: managementResult.modules.operationalInsights,\n      \n      // æœ€ç»ˆå†³ç­–\n      decision: managementResult.decision\n    },\n    \n    // æ›´æ–°å¤„ç†çŠ¶æ€\n    processing_status: 'ai_managed',\n    workflowStatus: workflowStatus,\n    \n    // åº”ç”¨AIå»ºè®®çš„ä¿®æ”¹\n    ...(managementResult.decision.modifications || {})\n  };\n  \n  // æ ¹æ®AIå†³ç­–ç¡®å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨\n  let nextAction = 'continue';\n  let actionReason = 'AIå®¡æ ¸é€šè¿‡';\n  \n  switch (managementResult.decision.action) {\n    case 'approve':\n      nextAction = 'publish';\n      actionReason = 'AIå»ºè®®å‘å¸ƒ';\n      processedData.readyForPublish = true;\n      break;\n      \n    case 'reject':\n      nextAction = 'reject';\n      actionReason = 'AIå»ºè®®æ‹’ç»';\n      processedData.readyForPublish = false;\n      processedData.rejectionReason = managementResult.decision.reasoning.join('; ');\n      break;\n      \n    case 'revise':\n      nextAction = 'revise';\n      actionReason = 'AIå»ºè®®ä¿®æ”¹';\n      processedData.readyForPublish = false;\n      processedData.revisionSuggestions = managementResult.decision.modifications;\n      break;\n      \n    case 'hold':\n      nextAction = 'hold';\n      actionReason = 'AIå»ºè®®æš‚åœï¼Œéœ€äººå·¥å®¡æ ¸';\n      processedData.readyForPublish = false;\n      processedData.holdReason = managementResult.decision.reasoning.join('; ');\n      break;\n      \n    default:\n      nextAction = 'continue';\n      actionReason = 'é»˜è®¤ç»§ç»­å¤„ç†';\n      processedData.readyForPublish = true;\n  }\n  \n  processedData.nextAction = nextAction;\n  processedData.actionReason = actionReason;\n  \n  // å‡†å¤‡ç«é¸Ÿé—¨æˆ·å‘å¸ƒæ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰\n  if (processedData.readyForPublish) {\n    processedData.publishData = {\n      service: 'article',\n      action: 'put',\n      title: (processedData.title || '').substring(0, 60),\n      typeid: processedData.categoryId || processedData.åˆ†ç±»ID || 1,\n      body: processedData.content || processedData.å†…å®¹ || '',\n      writer: processedData.author || processedData.ä½œè€… || 'AIé‡‡é›†',\n      source: processedData.source || processedData.æ¥æº || 'AIé‡‡é›†',\n      sourceurl: processedData.source_url || processedData.åŸå§‹URL || '',\n      keywords: processedData.keywords || '',\n      description: (processedData.summary || processedData.æ‘˜è¦ || '').substring(0, 255),\n      litpic: processedData.image_url || processedData.ç¼©ç•¥å›¾URL || ''\n    };\n  }\n  \n  // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n  workflowStatus.aiManagement = {\n    completed: true,\n    decision: managementResult.decision.action,\n    confidence: managementResult.decision.confidence,\n    processingTime: managementResult.processingTime\n  };\n  \n  console.log('âœ… AIæ™ºèƒ½ç®¡ç†å®Œæˆ:', {\n    title: processedData.title?.substring(0, 50) + '...',\n    decision: managementResult.decision.action,\n    confidence: managementResult.decision.confidence,\n    nextAction: nextAction,\n    processingTime: managementResult.processingTime + 'ms'\n  });\n  \n  return {\n    json: processedData\n  };\n  \n} catch (error) {\n  console.error('âŒ AIæ™ºèƒ½ç®¡ç†å¤±è´¥:', {\n    title: managementData.title,\n    error: error.message\n  });\n  \n  // é”™è¯¯æƒ…å†µä¸‹çš„é™çº§å¤„ç†\n  const fallbackData = {\n    ...inputData,\n    \n    aiManagement: {\n      success: false,\n      error: error.message,\n      timestamp: new Date().toISOString(),\n      fallbackApplied: true\n    },\n    \n    processing_status: 'ai_management_failed',\n    nextAction: 'continue_with_warning',\n    actionReason: `AIç®¡ç†å¤±è´¥ï¼Œä½¿ç”¨é™çº§ç­–ç•¥: ${error.message}`,\n    workflowStatus: workflowStatus,\n    \n    // é™çº§æƒ…å†µä¸‹ä»ç„¶å‡†å¤‡å‘å¸ƒæ•°æ®\n    readyForPublish: true,\n    publishData: {\n      service: 'article',\n      action: 'put',\n      title: (inputData.title || '').substring(0, 60),\n      typeid: inputData.categoryId || inputData.åˆ†ç±»ID || 1,\n      body: inputData.content || inputData.å†…å®¹ || '',\n      writer: inputData.author || inputData.ä½œè€… || 'AIé‡‡é›†',\n      source: inputData.source || inputData.æ¥æº || 'AIé‡‡é›†'\n    }\n  };\n  \n  return {\n    json: fallbackData\n  };\n}"
      },
      "id": "ai-intelligent-management",
      "name": "AIæ™ºèƒ½ç®¡ç†èŠ‚ç‚¹",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2400, 200],
      "retryOnFail": true,
      "maxTries": 2,\n      "waitBetweenTries": 3000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "ai-decision-router",
      "name": "AIå†³ç­–è·¯ç”±",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [2620, 200],
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.nextAction}}",
        "rules": {
          "rules": [
            {
              "operation": "equal",
              "value2": "publish",
              "output": 0
            },
            {
              "operation": "equal", 
              "value2": "reject",
              "output": 1
            },
            {
              "operation": "equal",
              "value2": "revise",
              "output": 2
            },
            {
              "operation": "equal",
              "value2": "hold",
              "output": 3
            }
          ]
        },
        "fallbackOutput": 0
      }
    },
    {
      "id": "firebird-publish-preparation",
      "name": "ç«é¸Ÿé—¨æˆ·å‘å¸ƒæ•°æ®å‡†å¤‡",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 100],
      "parameters": {
        "functionCode": "// ç«é¸Ÿé—¨æˆ·å‘å¸ƒæ•°æ®å‡†å¤‡å’Œè‡ªåŠ¨è®¤è¯ - å¢å¼ºç‰ˆ\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'firebird_publish_prep';\nworkflowStatus.currentStep = 7;\n\n// å¼•å…¥è®¤è¯ç®¡ç†å™¨ï¼ˆç®€åŒ–ç‰ˆï¼Œé¿å…å¤–éƒ¨ä¾èµ–ï¼‰\nclass SimpleFirebirdAuth {\n  constructor() {\n    this.sessionId = process.env.HUONIAO_SESSION_ID;\n  }\n  \n  async getValidCookie() {\n    if (!this.sessionId) {\n      throw new Error('æœªé…ç½®HUONIAO_SESSION_IDç¯å¢ƒå˜é‡');\n    }\n    return `PHPSESSID=${this.sessionId}`;\n  }\n}\n\n// æ•°æ®éªŒè¯\nfunction validateData(data) {\n  const errors = [];\n  \n  if (!data.publishData) {\n    errors.push('ç¼ºå°‘å‘å¸ƒæ•°æ®');\n    return errors;\n  }\n  \n  const publishData = data.publishData;\n  \n  if (!publishData.title || publishData.title.trim().length === 0) {\n    errors.push('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');\n  }\n  if (!publishData.body || publishData.body.trim().length === 0) {\n    errors.push('å†…å®¹ä¸èƒ½ä¸ºç©º');\n  }\n  if (!publishData.typeid || isNaN(parseInt(publishData.typeid))) {\n    errors.push('åˆ†ç±»IDå¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—');\n  }\n  \n  return errors;\n}\n\n// æ•°æ®æ¸…ç†å’Œä¼˜åŒ–\nfunction sanitizeData(data) {\n  const publishData = data.publishData || {};\n  \n  return {\n    service: 'article',\n    action: 'put',\n    title: (publishData.title || '').trim().substring(0, 60),\n    typeid: parseInt(publishData.typeid || 1),\n    body: (publishData.body || '').trim(),\n    writer: (publishData.writer || 'AIé‡‡é›†').trim().substring(0, 20),\n    source: (publishData.source || 'AIé‡‡é›†').trim().substring(0, 30),\n    keywords: (publishData.keywords || '').substring(0, 50),\n    description: (publishData.description || '').trim().substring(0, 255),\n    sourceurl: (publishData.sourceurl || '').trim().substring(0, 200),\n    litpic: publishData.litpic || '',\n    \n    // æ·»åŠ ç³»ç»Ÿå­—æ®µ\n    cityid: 1, // å¤å¨å¤·åŸå¸‚ID\n    arcrank: 1, // å·²å®¡æ ¸çŠ¶æ€\n    weight: 1, // æ’åºæƒé‡\n    notpost: 0, // å¼€å¯è¯„è®º\n    color: '', // æ ‡é¢˜é¢œè‰²\n    flag: 'r', // æ¨èæ ‡è®°\n    \n    originalData: data\n  };\n}\n\nasync function preparePublishData() {\n  try {\n    // æ•°æ®éªŒè¯\n    const errors = validateData(inputData);\n    if (errors.length > 0) {\n      throw new Error('æ•°æ®éªŒè¯å¤±è´¥: ' + errors.join(', '));\n    }\n    \n    // æ•°æ®æ¸…ç†\n    const publishData = sanitizeData(inputData);\n    \n    // åˆå§‹åŒ–è®¤è¯ç®¡ç†å™¨\n    const authManager = new SimpleFirebirdAuth();\n    \n    // è·å–æœ‰æ•ˆçš„è®¤è¯Cookie\n    console.log('ğŸ” è·å–è®¤è¯Cookie...');\n    const authCookie = await authManager.getValidCookie();\n    \n    if (!authCookie) {\n      throw new Error('æ— æ³•è·å–æœ‰æ•ˆçš„è®¤è¯Cookie');\n    }\n    \n    // æ·»åŠ è®¤è¯ä¿¡æ¯åˆ°å‘å¸ƒæ•°æ®\n    publishData.authCookie = authCookie;\n    publishData.sessionId = process.env.HUONIAO_SESSION_ID;\n    publishData.authStatus = 'authenticated';\n    \n    // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n    workflowStatus.firebirdPreparation = {\n      completed: true,\n      dataValidated: true,\n      authenticationSuccess: true,\n      publishDataReady: true\n    };\n    \n    console.log('âœ… å‘å¸ƒæ•°æ®å‡†å¤‡å®Œæˆ:', { \n      title: publishData.title?.substring(0, 50) + '...', \n      typeid: publishData.typeid,\n      hasAuth: !!authCookie,\n      bodyLength: publishData.body?.length || 0\n    });\n    \n    return { \n      json: {\n        ...publishData,\n        workflowStatus: workflowStatus,\n        preparationSuccess: true,\n        readyForFirebirdAPI: true\n      }\n    };\n    \n  } catch (error) {\n    console.error('âŒ å‘å¸ƒæ•°æ®å‡†å¤‡å¤±è´¥:', error.message);\n    \n    // æ›´æ–°å·¥ä½œæµçŠ¶æ€\n    workflowStatus.firebirdPreparation = {\n      completed: false,\n      error: error.message,\n      failedAt: new Date().toISOString()\n    };\n    \n    return { \n      json: { \n        ...inputData, \n        publishError: error.message, \n        publishStatus: 'preparation_failed',\n        authStatus: 'failed',\n        workflowStatus: workflowStatus,\n        preparationSuccess: false\n      } \n    };\n  }\n}\n\n// æ‰§è¡Œå¼‚æ­¥å‡½æ•°\nreturn preparePublishData();"
      }
    },
    {
      "id": "firebird-publish-node",
      "name": "ç«é¸Ÿé—¨æˆ·æ–°é—»å‘å¸ƒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [3060, 100],
      "parameters": {
        "url": "https://hawaiihub.net/include/ajax.php",
        "authentication": "none",
        "httpMethod": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/x-www-form-urlencoded" },
            { "name": "Cookie", "value": "={{$json.authCookie}}" },
            { "name": "User-Agent", "value": "Mozilla/5.0 (compatible; n8n-automation/1.0)" },
            { "name": "Accept", "value": "application/json, text/plain, */*" },
            { "name": "Accept-Language", "value": "zh-CN,zh;q=0.9,en;q=0.8" },
            { "name": "Referer", "value": "https://hawaiihub.net/" },
            { "name": "X-Requested-With", "value": "XMLHttpRequest" }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            { "name": "service", "value": "={{$json.service}}" },
            { "name": "action", "value": "={{$json.action}}" },
            { "name": "title", "value": "={{$json.title}}" },
            { "name": "typeid", "value": "={{$json.typeid}}" },
            { "name": "body", "value": "={{$json.body}}" },
            { "name": "writer", "value": "={{$json.writer}}" },
            { "name": "source", "value": "={{$json.source}}" },
            { "name": "keywords", "value": "={{$json.keywords || ''}}" },
            { "name": "description", "value": "={{$json.description || ''}}" },
            { "name": "sourceurl", "value": "={{$json.sourceurl || ''}}" },
            { "name": "litpic", "value": "={{$json.litpic || ''}}" },
            { "name": "cityid", "value": "={{$json.cityid || 1}}" },
            { "name": "arcrank", "value": "={{$json.arcrank || 1}}" },
            { "name": "weight", "value": "={{$json.weight || 1}}" },
            { "name": "notpost", "value": "={{$json.notpost || 0}}" },
            { "name": "color", "value": "={{$json.color || ''}}" },
            { "name": "flag", "value": "={{$json.flag || 'r'}}" }
          ]
        },
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxTries": 3,
            "waitBetweenTries": 5000
          },
          "response": {
            "responseFormat": "json",
            "outputPropertyName": "data"
          },
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 3
            }
          }
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000,
      "continueOnFail": false,
      "alwaysOutputData": false
    },
    {
      "id": "firebird-publish-status-handler",
      "name": "ç«é¸Ÿé—¨æˆ·å‘å¸ƒçŠ¶æ€å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [3280, 100],
      "parameters": {
        "functionCode": "// ç«é¸Ÿé—¨æˆ·å‘å¸ƒç»“æœå¤„ç† - å¢å¼ºç‰ˆ\nconst httpResponse = $input.first().json;\nconst originalData = httpResponse.originalData || {};\nlet workflowStatus = originalData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'firebird_publish_complete';\nworkflowStatus.currentStep = 8;\n\n// è§£æAPIå“åº”\nconst apiResponse = httpResponse.data || httpResponse;\nconst isSuccess = apiResponse && apiResponse.state === 100;\nconst articleId = isSuccess ? apiResponse.info : null;\nconst errorMessage = !isSuccess ? (apiResponse?.info || 'Unknown error') : null;\n\n// æ„å»ºè¯¦ç»†çš„çŠ¶æ€è®°å½•\nconst statusRecord = {\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  timestamp: new Date().toISOString(),\n  \n  publishStatus: isSuccess ? 'success' : 'failed',\n  \n  firebird: {\n    articleId: articleId,\n    state: apiResponse?.state || 'unknown',\n    message: apiResponse?.info || 'No response',\n    publishedAt: isSuccess ? new Date().toISOString() : null,\n    apiUrl: 'https://hawaiihub.net/include/ajax.php'\n  },\n  \n  contentInfo: {\n    title: originalData.title || httpResponse.title || 'Unknown',\n    source: originalData.source || httpResponse.source || 'Unknown',\n    category: originalData.category || 'Unknown',\n    qualityScore: originalData.quality_score || 0\n  },\n  \n  performance: {\n    totalWorkflowTime: Date.now() - (workflowStatus.startTime || Date.now()),\n    publishAttempts: (httpResponse.retryCount || 0) + 1,\n    authenticationUsed: !!originalData.authCookie\n  },\n  \n  aiDecision: {\n    action: originalData.aiManagement?.decision?.action || 'unknown',\n    confidence: originalData.aiManagement?.decision?.confidence || 0,\n    reasoning: originalData.aiManagement?.decision?.reasoning || []\n  },\n  \n  notion: {\n    pageId: originalData.notionPageId || null,\n    url: originalData.notionUrl || null,\n    storageSuccess: originalData.storageSuccess || false\n  },\n  \n  error: isSuccess ? null : {\n    message: errorMessage,\n    httpStatus: httpResponse.statusCode || 'unknown',\n    responseBody: apiResponse,\n    timestamp: new Date().toISOString()\n  }\n};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€ç»Ÿè®¡\nworkflowStatus.firebirdPublish = {\n  completed: true,\n  success: isSuccess,\n  articleId: articleId,\n  publishTime: statusRecord.timestamp,\n  totalTime: statusRecord.performance.totalWorkflowTime\n};\n\nif (isSuccess) {\n  console.log('ğŸ‰ ç«é¸Ÿé—¨æˆ·å‘å¸ƒæˆåŠŸ:', {\n    articleId: articleId,\n    title: statusRecord.contentInfo.title?.substring(0, 50) + '...',\n    source: statusRecord.contentInfo.source,\n    totalTime: Math.round(statusRecord.performance.totalWorkflowTime / 1000) + 'ç§’',\n    qualityScore: statusRecord.contentInfo.qualityScore\n  });\n  \n  // æ›´æ–°æˆåŠŸç»Ÿè®¡\n  workflowStatus.successCount = (workflowStatus.successCount || 0) + 1;\n  \n} else {\n  console.error('âŒ ç«é¸Ÿé—¨æˆ·å‘å¸ƒå¤±è´¥:', {\n    title: statusRecord.contentInfo.title?.substring(0, 50) + '...',\n    error: errorMessage,\n    state: apiResponse?.state,\n    attempts: statusRecord.performance.publishAttempts\n  });\n  \n  // æ›´æ–°å¤±è´¥ç»Ÿè®¡\n  workflowStatus.failureCount = (workflowStatus.failureCount || 0) + 1;\n}\n\n// æ„å»ºå®Œæ•´çš„è¾“å‡ºæ•°æ®\nconst outputData = {\n  // å‘å¸ƒç»“æœ\n  publishSuccess: isSuccess,\n  firebird: statusRecord.firebird,\n  \n  // çŠ¶æ€è®°å½•\n  statusRecord: statusRecord,\n  \n  // å·¥ä½œæµçŠ¶æ€\n  workflowStatus: workflowStatus,\n  \n  // å¤„ç†çŠ¶æ€\n  processing_status: isSuccess ? 'published' : 'publish_failed',\n  workflow_completed: true,\n  completedAt: statusRecord.timestamp,\n  \n  // ä¿ç•™åŸå§‹æ•°æ®\n  ...originalData,\n  \n  // æœ€ç»ˆç»Ÿè®¡\n  finalStats: {\n    totalProcessingTime: statusRecord.performance.totalWorkflowTime,\n    stepsCompleted: workflowStatus.currentStep,\n    totalSteps: 8,\n    successRate: isSuccess ? 100 : 0,\n    qualityScore: statusRecord.contentInfo.qualityScore,\n    aiDecisionAccuracy: statusRecord.aiDecision.confidence * 100\n  }\n};\n\nreturn { json: outputData };"
      }
    },
    {
      "id": "content-rejection-handler",
      "name": "å†…å®¹æ‹’ç»å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 200],
      "parameters": {
        "functionCode": "// å†…å®¹æ‹’ç»å¤„ç† - åŸºäºAIå†³ç­–\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'content_rejected';\nworkflowStatus.currentStep = 8; // æœ€ç»ˆæ­¥éª¤\n\nconst rejectionRecord = {\n  timestamp: new Date().toISOString(),\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  \n  contentInfo: {\n    title: inputData.title?.substring(0, 50) + '...',\n    source: inputData.source || inputData.æ¥æº,\n    category: inputData.category || inputData.åˆ†ç±»åç§°,\n    qualityScore: inputData.quality_score || inputData.è´¨é‡åˆ†æ•° || 0\n  },\n  \n  rejectionDetails: {\n    reason: inputData.rejectionReason || 'AIå»ºè®®æ‹’ç»',\n    aiDecision: inputData.aiManagement?.decision || {},\n    contentReview: inputData.aiManagement?.contentReview || {},\n    confidence: inputData.aiManagement?.decision?.confidence || 0\n  },\n  \n  notionInfo: {\n    pageId: inputData.notionPageId,\n    url: inputData.notionUrl,\n    needsStatusUpdate: true\n  },\n  \n  performance: {\n    totalWorkflowTime: Date.now() - (workflowStatus.startTime || Date.now()),\n    stepsCompleted: workflowStatus.currentStep || 0\n  }\n};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.contentRejection = {\n  completed: true,\n  reason: rejectionRecord.rejectionDetails.reason,\n  confidence: rejectionRecord.rejectionDetails.confidence\n};\n\nworkflowStatus.rejectionCount = (workflowStatus.rejectionCount || 0) + 1;\n\nconsole.log('ğŸš« å†…å®¹è¢«AIæ‹’ç»:', {\n  title: rejectionRecord.contentInfo.title,\n  reason: rejectionRecord.rejectionDetails.reason,\n  qualityScore: rejectionRecord.contentInfo.qualityScore,\n  aiConfidence: rejectionRecord.rejectionDetails.confidence,\n  totalTime: Math.round(rejectionRecord.performance.totalWorkflowTime / 1000) + 'ç§’'\n});\n\n// å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ‹’ç»å†…å®¹çš„åç»­å¤„ç†\n// ä¾‹å¦‚ï¼šæ›´æ–°NotionçŠ¶æ€ã€å‘é€é€šçŸ¥ã€è®°å½•åˆ°æ—¥å¿—ç³»ç»Ÿç­‰\n\nconst outputData = {\n  rejectionRecord: rejectionRecord,\n  workflowStatus: workflowStatus,\n  processing_status: 'rejected_by_ai',\n  finalStatus: 'rejected',\n  \n  // æ ‡è®°ä¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†\n  skipFirebirdPublish: true,\n  workflow_completed: true,\n  completedAt: rejectionRecord.timestamp,\n  \n  // ä¿ç•™åŸå§‹æ•°æ®\n  ...inputData,\n  \n  // æœ€ç»ˆç»Ÿè®¡\n  finalStats: {\n    totalProcessingTime: rejectionRecord.performance.totalWorkflowTime,\n    stepsCompleted: rejectionRecord.performance.stepsCompleted,\n    totalSteps: 8,\n    outcome: 'rejected',\n    rejectionReason: rejectionRecord.rejectionDetails.reason\n  }\n};\n\nreturn { json: outputData };"
      }
    },
    {
      "id": "content-revision-handler",
      "name": "å†…å®¹ä¿®æ”¹å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 300],
      "parameters": {
        "functionCode": "// å†…å®¹ä¿®æ”¹å¤„ç† - åŸºäºAIå»ºè®®\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'content_needs_revision';\nworkflowStatus.currentStep = 8; // æœ€ç»ˆæ­¥éª¤\n\nconst revisionRecord = {\n  timestamp: new Date().toISOString(),\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  \n  contentInfo: {\n    title: inputData.title?.substring(0, 50) + '...',\n    source: inputData.source || inputData.æ¥æº,\n    category: inputData.category || inputData.åˆ†ç±»åç§°,\n    qualityScore: inputData.quality_score || inputData.è´¨é‡åˆ†æ•° || 0\n  },\n  \n  revisionDetails: {\n    suggestions: inputData.revisionSuggestions || {},\n    aiDecision: inputData.aiManagement?.decision || {},\n    optimizationSuggestions: inputData.aiManagement?.contentReview?.optimizationSuggestions || {},\n    confidence: inputData.aiManagement?.decision?.confidence || 0\n  },\n  \n  nextSteps: [\n    'åº”ç”¨AIä¼˜åŒ–å»ºè®®',\n    'é‡æ–°è¿›è¡Œè´¨é‡è¯„ä¼°',\n    'æ›´æ–°Notionè®°å½•',\n    'é‡æ–°æäº¤å®¡æ ¸'\n  ],\n  \n  performance: {\n    totalWorkflowTime: Date.now() - (workflowStatus.startTime || Date.now()),\n    stepsCompleted: workflowStatus.currentStep || 0\n  }\n};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.contentRevision = {\n  completed: true,\n  suggestionsCount: Object.keys(revisionRecord.revisionDetails.suggestions).length,\n  confidence: revisionRecord.revisionDetails.confidence\n};\n\nworkflowStatus.revisionCount = (workflowStatus.revisionCount || 0) + 1;\n\nconsole.log('âœï¸ å†…å®¹éœ€è¦ä¿®æ”¹:', {\n  title: revisionRecord.contentInfo.title,\n  suggestions: Object.keys(revisionRecord.revisionDetails.suggestions),\n  nextSteps: revisionRecord.nextSteps.length,\n  qualityScore: revisionRecord.contentInfo.qualityScore,\n  totalTime: Math.round(revisionRecord.performance.totalWorkflowTime / 1000) + 'ç§’'\n});\n\n// åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œå¯ä»¥ï¼š\n// 1. è‡ªåŠ¨åº”ç”¨ä¸€äº›ç®€å•çš„ä¿®æ”¹å»ºè®®\n// 2. å°†å†…å®¹å‘é€åˆ°äººå·¥å®¡æ ¸é˜Ÿåˆ—\n// 3. æ›´æ–°Notionä¸­çš„çŠ¶æ€å’Œå»ºè®®\n// 4. è§¦å‘é‡æ–°å¤„ç†æµç¨‹\n\nconst outputData = {\n  revisionRecord: revisionRecord,\n  workflowStatus: workflowStatus,\n  processing_status: 'needs_revision',\n  finalStatus: 'pending_revision',\n  \n  // æ ‡è®°éœ€è¦äººå·¥å¹²é¢„\n  requiresManualReview: true,\n  skipFirebirdPublish: true,\n  workflow_completed: false, // éœ€è¦åç»­å¤„ç†\n  completedAt: revisionRecord.timestamp,\n  \n  // ä¿ç•™åŸå§‹æ•°æ®\n  ...inputData,\n  \n  // æœ€ç»ˆç»Ÿè®¡\n  finalStats: {\n    totalProcessingTime: revisionRecord.performance.totalWorkflowTime,\n    stepsCompleted: revisionRecord.performance.stepsCompleted,\n    totalSteps: 8,\n    outcome: 'needs_revision',\n    suggestionsProvided: Object.keys(revisionRecord.revisionDetails.suggestions).length\n  }\n};\n\nreturn { json: outputData };"
      }
    },
    {
      "id": "content-hold-handler",
      "name": "å†…å®¹æš‚åœå¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2840, 400],
      "parameters": {
        "functionCode": "// å†…å®¹æš‚åœå¤„ç† - åŸºäºAIç½®ä¿¡åº¦\nconst inputData = $input.first().json;\nlet workflowStatus = inputData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'content_on_hold';\nworkflowStatus.currentStep = 8; // æœ€ç»ˆæ­¥éª¤\n\nconst holdRecord = {\n  timestamp: new Date().toISOString(),\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  \n  contentInfo: {\n    title: inputData.title?.substring(0, 50) + '...',\n    source: inputData.source || inputData.æ¥æº,\n    category: inputData.category || inputData.åˆ†ç±»åç§°,\n    qualityScore: inputData.quality_score || inputData.è´¨é‡åˆ†æ•° || 0\n  },\n  \n  holdDetails: {\n    reason: inputData.holdReason || 'AIç½®ä¿¡åº¦è¿‡ä½',\n    aiDecision: inputData.aiManagement?.decision || {},\n    confidence: inputData.aiManagement?.decision?.confidence || 0,\n    threshold: 0.7 // ç½®ä¿¡åº¦é˜ˆå€¼\n  },\n  \n  recommendedActions: [\n    'äººå·¥å®¡æ ¸å†…å®¹è´¨é‡',\n    'éªŒè¯å†…å®¹æ¥æºå¯é æ€§',\n    'ç¡®è®¤åˆ†ç±»å‡†ç¡®æ€§',\n    'è¯„ä¼°å‘å¸ƒæ—¶æœº'\n  ],\n  \n  performance: {\n    totalWorkflowTime: Date.now() - (workflowStatus.startTime || Date.now()),\n    stepsCompleted: workflowStatus.currentStep || 0\n  }\n};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.contentHold = {\n  completed: true,\n  reason: holdRecord.holdDetails.reason,\n  confidence: holdRecord.holdDetails.confidence,\n  threshold: holdRecord.holdDetails.threshold\n};\n\nworkflowStatus.holdCount = (workflowStatus.holdCount || 0) + 1;\n\nconsole.log('â¸ï¸ å†…å®¹è¢«æš‚åœ:', {\n  title: holdRecord.contentInfo.title,\n  reason: holdRecord.holdDetails.reason,\n  confidence: holdRecord.holdDetails.confidence,\n  qualityScore: holdRecord.contentInfo.qualityScore,\n  totalTime: Math.round(holdRecord.performance.totalWorkflowTime / 1000) + 'ç§’'\n});\n\n// åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œå¯ä»¥ï¼š\n// 1. å‘é€é€šçŸ¥ç»™å†…å®¹ç®¡ç†å‘˜\n// 2. å°†å†…å®¹æ·»åŠ åˆ°äººå·¥å®¡æ ¸é˜Ÿåˆ—\n// 3. æ›´æ–°Notionä¸­çš„çŠ¶æ€\n// 4. è®¾ç½®å®šæ—¶é‡æ–°è¯„ä¼°\n\nconst outputData = {\n  holdRecord: holdRecord,\n  workflowStatus: workflowStatus,\n  processing_status: 'on_hold',\n  finalStatus: 'pending_manual_review',\n  \n  // æ ‡è®°éœ€è¦äººå·¥å¹²é¢„\n  requiresManualReview: true,\n  skipFirebirdPublish: true,\n  workflow_completed: false, // éœ€è¦åç»­å¤„ç†\n  completedAt: holdRecord.timestamp,\n  \n  // ä¿ç•™åŸå§‹æ•°æ®\n  ...inputData,\n  \n  // æ·»åŠ å®¡æ ¸é˜Ÿåˆ—ä¿¡æ¯\n  reviewQueue: {\n    priority: holdRecord.holdDetails.confidence < 0.3 ? 'high' : 'medium',\n    estimatedReviewTime: '24å°æ—¶å†…',\n    assignedReviewer: null\n  },\n  \n  // æœ€ç»ˆç»Ÿè®¡\n  finalStats: {\n    totalProcessingTime: holdRecord.performance.totalWorkflowTime,\n    stepsCompleted: holdRecord.performance.stepsCompleted,\n    totalSteps: 8,\n    outcome: 'on_hold',\n    confidenceScore: holdRecord.holdDetails.confidence\n  }\n};\n\nreturn { json: outputData };"
      }
    },
    {
      "id": "workflow-completion-logger",
      "name": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [3500, 200],
      "parameters": {
        "functionCode": "// å·¥ä½œæµå®Œæˆç»Ÿè®¡å’Œæ—¥å¿—è®°å½• - å¢å¼ºç‰ˆ\nconst finalData = $input.first().json;\nconst workflowStatus = finalData.workflowStatus || {};\n\n// è®¡ç®—æ€»æ‰§è¡Œæ—¶é—´\nconst totalExecutionTime = Date.now() - (workflowStatus.startTime || Date.now());\nconst executionTimeSeconds = Math.round(totalExecutionTime / 1000);\n\n// æ„å»ºå®Œæ•´çš„å®ŒæˆæŠ¥å‘Š\nconst completionReport = {\n  // åŸºç¡€ä¿¡æ¯\n  executionId: $execution.id,\n  workflowName: 'enhanced-news-collection-with-notion',\n  version: '2.0.0',\n  completedAt: new Date().toISOString(),\n  totalExecutionTime: totalExecutionTime,\n  executionTimeFormatted: `${Math.floor(executionTimeSeconds / 60)}åˆ†${executionTimeSeconds % 60}ç§’`,\n  \n  // å¤„ç†ç»“æœ\n  results: {\n    contentProcessed: !!finalData.title,\n    notionStored: !!finalData.notionPageId,\n    aiManaged: !!finalData.aiManagement?.success,\n    firebirdPublished: finalData.publishSuccess === true,\n    workflowCompleted: finalData.workflow_completed === true\n  },\n  \n  // å†…å®¹ä¿¡æ¯\n  content: {\n    title: finalData.title?.substring(0, 100) + (finalData.title?.length > 100 ? '...' : '') || 'Unknown',\n    source: finalData.source || 'Unknown',\n    category: finalData.category || 'Unknown',\n    qualityScore: finalData.quality_score || finalData.qualityScore || 0,\n    processingStatus: finalData.processing_status || 'unknown'\n  },\n  \n  // ç³»ç»Ÿæ ‡è¯†ç¬¦\n  identifiers: {\n    notionPageId: finalData.notionPageId || null,\n    notionUrl: finalData.notionUrl || null,\n    firebirdArticleId: finalData.firebird?.articleId || null,\n    batchId: workflowStatus.executionId || $execution.id\n  },\n  \n  // æ€§èƒ½æŒ‡æ ‡\n  performance: {\n    totalSteps: 8,\n    completedSteps: workflowStatus.currentStep || 0,\n    completionRate: Math.round(((workflowStatus.currentStep || 0) / 8) * 100),\n    \n    // å„é˜¶æ®µè€—æ—¶\n    phaseTimings: {\n      dataCollection: workflowStatus.rssCollection?.totalProcessingTime || 0,\n      contentProcessing: workflowStatus.contentProcessing?.processingTime || 0,\n      notionStorage: finalData.notion?.attempts || 1,\n      aiManagement: workflowStatus.aiManagement?.processingTime || 0,\n      firebirdPublish: workflowStatus.firebirdPublish?.totalTime || 0\n    },\n    \n    // è´¨é‡æŒ‡æ ‡\n    qualityMetrics: {\n      averageQualityScore: finalData.quality_score || 0,\n      aiDecisionConfidence: finalData.aiManagement?.decision?.confidence || 0,\n      contentOptimized: finalData.processingStats?.aiEnhanced || false\n    }\n  },\n  \n  // é”™è¯¯å’Œé—®é¢˜\n  issues: {\n    hasErrors: !!finalData.error || finalData.publishSuccess === false,\n    errorCount: (workflowStatus.contentProcessing?.errors || 0) + \n                (workflowStatus.notionStorage?.failureCount || 0) + \n                (finalData.publishSuccess === false ? 1 : 0),\n    warnings: [],\n    criticalIssues: []\n  },\n  \n  // AIå†³ç­–ä¿¡æ¯\n  aiDecision: {\n    action: finalData.aiManagement?.decision?.action || 'unknown',\n    confidence: finalData.aiManagement?.decision?.confidence || 0,\n    reasoning: finalData.aiManagement?.decision?.reasoning || [],\n    fallbackUsed: finalData.aiManagement?.fallbackApplied || false\n  },\n  \n  // å·¥ä½œæµç»Ÿè®¡\n  workflowStats: {\n    successCount: workflowStatus.successCount || 0,\n    failureCount: workflowStatus.failureCount || 0,\n    rejectionCount: workflowStatus.rejectionCount || 0,\n    revisionCount: workflowStatus.revisionCount || 0,\n    holdCount: workflowStatus.holdCount || 0\n  },\n  \n  // æœ€ç»ˆçŠ¶æ€\n  finalStatus: finalData.finalStatus || (finalData.publishSuccess ? 'published' : 'failed'),\n  outcome: finalData.publishSuccess ? 'success' : \n           (finalData.processing_status === 'rejected_by_ai' ? 'rejected' :\n            (finalData.processing_status === 'needs_revision' ? 'needs_revision' :\n             (finalData.processing_status === 'on_hold' ? 'on_hold' : 'failed')))\n};\n\n// æ·»åŠ è­¦å‘Šä¿¡æ¯\nif (completionReport.performance.completionRate < 100) {\n  completionReport.issues.warnings.push(`å·¥ä½œæµæœªå®Œå…¨å®Œæˆ (${completionReport.performance.completionRate}%)`);\n}\n\nif (completionReport.performance.qualityMetrics.averageQualityScore < 70) {\n  completionReport.issues.warnings.push(`å†…å®¹è´¨é‡åˆ†æ•°è¾ƒä½ (${completionReport.performance.qualityMetrics.averageQualityScore})`);\n}\n\nif (executionTimeSeconds > 300) { // è¶…è¿‡5åˆ†é’Ÿ\n  completionReport.issues.warnings.push(`æ‰§è¡Œæ—¶é—´è¿‡é•¿ (${completionReport.executionTimeFormatted})`);\n}\n\n// æ·»åŠ å…³é”®é—®é¢˜\nif (finalData.error) {\n  completionReport.issues.criticalIssues.push(`æ‰§è¡Œé”™è¯¯: ${finalData.error}`);\n}\n\nif (!finalData.notionPageId && finalData.processing_status !== 'rejected_by_ai') {\n  completionReport.issues.criticalIssues.push('Notionå­˜å‚¨å¤±è´¥');\n}\n\n// è®°å½•æ—¥å¿—\nif (completionReport.results.firebirdPublished) {\n  console.log('ğŸ‰ å·¥ä½œæµæ‰§è¡ŒæˆåŠŸå®Œæˆ:', {\n    executionId: completionReport.executionId,\n    title: completionReport.content.title,\n    source: completionReport.content.source,\n    articleId: completionReport.identifiers.firebirdArticleId,\n    totalTime: completionReport.executionTimeFormatted,\n    qualityScore: completionReport.content.qualityScore,\n    aiDecision: completionReport.aiDecision.action,\n    completionRate: completionReport.performance.completionRate + '%'\n  });\n} else {\n  const logLevel = completionReport.issues.criticalIssues.length > 0 ? 'error' : 'warn';\n  console[logLevel]('âš ï¸ å·¥ä½œæµæ‰§è¡Œå®Œæˆä½†æœ‰é—®é¢˜:', {\n    executionId: completionReport.executionId,\n    title: completionReport.content.title,\n    outcome: completionReport.outcome,\n    issues: completionReport.issues.criticalIssues.length,\n    warnings: completionReport.issues.warnings.length,\n    totalTime: completionReport.executionTimeFormatted,\n    completionRate: completionReport.performance.completionRate + '%'\n  });\n}\n\n// æ€§èƒ½åˆ†ææ—¥å¿—\nconsole.log('ğŸ“Š å·¥ä½œæµæ€§èƒ½åˆ†æ:', {\n  æ€»è€—æ—¶: completionReport.executionTimeFormatted,\n  å®Œæˆç‡: completionReport.performance.completionRate + '%',\n  è´¨é‡åˆ†æ•°: completionReport.performance.qualityMetrics.averageQualityScore,\n  AIç½®ä¿¡åº¦: Math.round(completionReport.performance.qualityMetrics.aiDecisionConfidence * 100) + '%',\n  æˆåŠŸå‘å¸ƒ: completionReport.results.firebirdPublished ? 'æ˜¯' : 'å¦',\n  é”™è¯¯æ•°é‡: completionReport.issues.errorCount,\n  è­¦å‘Šæ•°é‡: completionReport.issues.warnings.length\n});\n\nreturn { json: completionReport };"
      }
    },
    {
      "id": "error-handling-node",
      "name": "å…¨å±€é”™è¯¯å¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 400],
      "parameters": {
        "functionCode": "// å…¨å±€é”™è¯¯å¤„ç†èŠ‚ç‚¹\nconst errorData = $input.first().json;\nconst error = errorData.error || 'Unknown error';\nlet workflowStatus = errorData.workflowStatus || {};\n\n// æ›´æ–°å·¥ä½œæµçŠ¶æ€\nworkflowStatus.phase = 'error_handling';\nworkflowStatus.hasErrors = true;\n\n// é”™è¯¯åˆ†ç±»\nfunction categorizeError(errorMessage, context) {\n  const errorMsg = errorMessage.toLowerCase();\n  \n  // ç½‘ç»œç›¸å…³é”™è¯¯\n  if (errorMsg.includes('timeout') || errorMsg.includes('network') || errorMsg.includes('connection')) {\n    return {\n      type: 'network_error',\n      severity: 'medium',\n      recoverable: true,\n      action: 'retry_with_delay',\n      category: 'infrastructure'\n    };\n  }\n  \n  // è®¤è¯ç›¸å…³é”™è¯¯\n  if (errorMsg.includes('unauthorized') || errorMsg.includes('invalid token') || errorMsg.includes('authentication')) {\n    return {\n      type: 'authentication_error',\n      severity: 'high',\n      recoverable: false,\n      action: 'check_credentials',\n      category: 'security'\n    };\n  }\n  \n  // APIé™åˆ¶é”™è¯¯\n  if (errorMsg.includes('rate limit') || errorMsg.includes('too many requests') || errorMsg.includes('quota')) {\n    return {\n      type: 'rate_limit_error',\n      severity: 'medium',\n      recoverable: true,\n      action: 'retry_with_exponential_backoff',\n      category: 'api_limits'\n    };\n  }\n  \n  // æ•°æ®éªŒè¯é”™è¯¯\n  if (errorMsg.includes('validation') || errorMsg.includes('invalid data') || errorMsg.includes('required field')) {\n    return {\n      type: 'validation_error',\n      severity: 'medium',\n      recoverable: true,\n      action: 'fix_data_and_retry',\n      category: 'data_quality'\n    };\n  }\n  \n  // å¤–éƒ¨æœåŠ¡é”™è¯¯\n  if (errorMsg.includes('notion') || errorMsg.includes('openai') || errorMsg.includes('github')) {\n    return {\n      type: 'external_service_error',\n      severity: 'high',\n      recoverable: true,\n      action: 'check_service_status',\n      category: 'external_dependency'\n    };\n  }\n  \n  // å†…å®¹å¤„ç†é”™è¯¯\n  if (errorMsg.includes('content') || errorMsg.includes('processing') || errorMsg.includes('parsing')) {\n    return {\n      type: 'content_processing_error',\n      severity: 'medium',\n      recoverable: true,\n      action: 'skip_item_and_continue',\n      category: 'content_processing'\n    };\n  }\n  \n  return {\n    type: 'unknown_error',\n    severity: 'medium',\n    recoverable: true,\n    action: 'log_and_continue',\n    category: 'unknown'\n  };\n}\n\nconst errorCategory = categorizeError(error, errorData);\nconst errorReport = {\n  timestamp: new Date().toISOString(),\n  executionId: $execution.id,\n  runIndex: $runIndex,\n  \n  error: {\n    message: error,\n    category: errorCategory,\n    phase: workflowStatus.phase || 'unknown',\n    step: workflowStatus.currentStep || 0,\n    context: {\n      title: errorData.title || errorData.originalData?.title || 'Unknown',\n      source: errorData.source || errorData.originalData?.source || 'Unknown',\n      processingStatus: errorData.processing_status || 'unknown'\n    }\n  },\n  \n  impact: {\n    severity: errorCategory.severity,\n    affectedComponent: errorCategory.category,\n    workflowInterrupted: errorCategory.severity === 'high',\n    dataLoss: false // å‡è®¾æ²¡æœ‰æ•°æ®ä¸¢å¤±\n  },\n  \n  recovery: {\n    recommended: errorCategory.action,\n    canRetry: errorCategory.recoverable,\n    automaticRecovery: errorCategory.recoverable && errorCategory.severity !== 'high',\n    manualIntervention: errorCategory.severity === 'high'\n  },\n  \n  performance: {\n    totalWorkflowTime: Date.now() - (workflowStatus.startTime || Date.now()),\n    failedAtStep: workflowStatus.currentStep || 0,\n    completionRate: Math.round(((workflowStatus.currentStep || 0) / 8) * 100)\n  }\n};\n\n// æ›´æ–°å·¥ä½œæµé”™è¯¯ç»Ÿè®¡\nworkflowStatus.errorHandling = {\n  errorCount: (workflowStatus.errorHandling?.errorCount || 0) + 1,\n  lastError: errorReport,\n  errorCategories: {\n    ...workflowStatus.errorHandling?.errorCategories,\n    [errorCategory.category]: (workflowStatus.errorHandling?.errorCategories?.[errorCategory.category] || 0) + 1\n  }\n};\n\n// è®°å½•é”™è¯¯æ—¥å¿—\nconsole.error('ğŸš¨ å·¥ä½œæµé”™è¯¯:', {\n  executionId: errorReport.executionId,\n  error: error,\n  category: errorCategory.type,\n  severity: errorCategory.severity,\n  phase: errorReport.error.phase,\n  step: errorReport.error.step,\n  title: errorReport.error.context.title?.substring(0, 50) + '...',\n  recoverable: errorCategory.recoverable,\n  recommendedAction: errorCategory.action\n});\n\n// ç¡®å®šåç»­è¡ŒåŠ¨\nlet shouldContinueWorkflow = false;\nlet alternativeAction = null;\nlet skipToEnd = false;\n\nswitch (errorCategory.type) {\n  case 'content_processing_error':\n  case 'validation_error':\n    shouldContinueWorkflow = true;\n    alternativeAction = 'skip_item';\n    skipToEnd = true;\n    break;\n    \n  case 'rate_limit_error':\n  case 'network_error':\n    shouldContinueWorkflow = true;\n    alternativeAction = 'retry_later';\n    break;\n    \n  case 'authentication_error':\n  case 'external_service_error':\n    shouldContinueWorkflow = false;\n    alternativeAction = 'manual_intervention';\n    skipToEnd = true;\n    break;\n    \n  default:\n    shouldContinueWorkflow = true;\n    alternativeAction = 'continue_with_warning';\n    skipToEnd = true;\n}\n\n// æ„å»ºè¾“å‡ºæ•°æ®\nconst outputData = {\n  errorHandled: true,\n  shouldContinue: shouldContinueWorkflow,\n  alternativeAction: alternativeAction,\n  skipToEnd: skipToEnd,\n  \n  errorReport: errorReport,\n  workflowStatus: workflowStatus,\n  \n  // ä¿ç•™åŸå§‹æ•°æ®\n  originalData: errorData.originalData || errorData,\n  \n  // å¤„ç†çŠ¶æ€\n  processing_status: 'error_handled',\n  workflow_completed: skipToEnd,\n  \n  // é”™è¯¯æ¢å¤ä¿¡æ¯\n  recovery: {\n    strategy: errorCategory.action,\n    canAutoRecover: errorCategory.recoverable,\n    requiresManualIntervention: errorCategory.severity === 'high',\n    estimatedRecoveryTime: errorCategory.recoverable ? '1-5åˆ†é’Ÿ' : 'éœ€è¦äººå·¥å¹²é¢„'\n  },\n  \n  // æœ€ç»ˆç»Ÿè®¡ï¼ˆå¦‚æœè·³åˆ°ç»“æŸï¼‰\n  finalStats: skipToEnd ? {\n    totalProcessingTime: errorReport.performance.totalWorkflowTime,\n    stepsCompleted: errorReport.performance.failedAtStep,\n    totalSteps: 8,\n    outcome: 'error',\n    errorCategory: errorCategory.type,\n    completionRate: errorReport.performance.completionRate\n  } : null\n};\n\n// å‘é€å‘Šè­¦ï¼ˆå¦‚æœæ˜¯ä¸¥é‡é”™è¯¯ï¼‰\nif (errorCategory.severity === 'high') {\n  console.error('ğŸš¨ ä¸¥é‡é”™è¯¯éœ€è¦ç«‹å³å…³æ³¨:', {\n    executionId: errorReport.executionId,\n    error: error,\n    category: errorCategory.type,\n    phase: errorReport.error.phase,\n    impact: errorReport.impact,\n    recommendedAction: errorCategory.action\n  });\n}\n\nreturn {\n  json: outputData\n};"
      }
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "æ•°æ®æºé…ç½®ä¸çŠ¶æ€åˆå§‹åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ•°æ®æºé…ç½®ä¸çŠ¶æ€åˆå§‹åŒ–": {
      "main": [
        [
          {
            "node": "RSSæ–°é—»é‡‡é›†",
            "type": "main",
            "index": 0
          },
          {
            "node": "GitHubé¡¹ç›®é‡‡é›†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSSæ–°é—»é‡‡é›†": {
      "main": [
        [
          {
            "node": "æ•°æ®åˆå¹¶ä¸è´¨é‡æ§åˆ¶",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GitHubé¡¹ç›®é‡‡é›†": {
      "main": [
        [
          {
            "node": "æ•°æ®åˆå¹¶ä¸è´¨é‡æ§åˆ¶",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ•°æ®åˆå¹¶ä¸è´¨é‡æ§åˆ¶": {
      "main": [
        [
          {
            "node": "å¢å¼ºæ™ºèƒ½å†…å®¹å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¢å¼ºæ™ºèƒ½å†…å®¹å¤„ç†": {
      "main": [
        [
          {
            "node": "å†…å®¹å¤„ç†çŠ¶æ€æ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†…å®¹å¤„ç†çŠ¶æ€æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "Notionå­˜å‚¨é‡è¯•å¤„ç†",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notionå­˜å‚¨é‡è¯•å¤„ç†": {
      "main": [
        [
          {
            "node": "Notionæ–°é—»å­˜å‚¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notionæ–°é—»å­˜å‚¨": {
      "main": [
        [
          {
            "node": "Notionå­˜å‚¨çŠ¶æ€è·Ÿè¸ª",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notionå­˜å‚¨çŠ¶æ€è·Ÿè¸ª": {
      "main": [
        [
          {
            "node": "å­˜å‚¨æ¡ä»¶æ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å­˜å‚¨æ¡ä»¶æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "AIæ™ºèƒ½ç®¡ç†èŠ‚ç‚¹",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIæ™ºèƒ½ç®¡ç†èŠ‚ç‚¹": {
      "main": [
        [
          {
            "node": "AIå†³ç­–è·¯ç”±",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIå†³ç­–è·¯ç”±": {
      "main": [
        [
          {
            "node": "ç«é¸Ÿé—¨æˆ·å‘å¸ƒæ•°æ®å‡†å¤‡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å†…å®¹æ‹’ç»å¤„ç†",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å†…å®¹ä¿®æ”¹å¤„ç†",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å†…å®¹æš‚åœå¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç«é¸Ÿé—¨æˆ·å‘å¸ƒæ•°æ®å‡†å¤‡": {
      "main": [
        [
          {
            "node": "ç«é¸Ÿé—¨æˆ·æ–°é—»å‘å¸ƒ",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç«é¸Ÿé—¨æˆ·æ–°é—»å‘å¸ƒ": {
      "main": [
        [
          {
            "node": "ç«é¸Ÿé—¨æˆ·å‘å¸ƒçŠ¶æ€å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "å…¨å±€é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç«é¸Ÿé—¨æˆ·å‘å¸ƒçŠ¶æ€å¤„ç†": {
      "main": [
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†…å®¹æ‹’ç»å¤„ç†": {
      "main": [
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†…å®¹ä¿®æ”¹å¤„ç†": {
      "main": [
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†…å®¹æš‚åœå¤„ç†": {
      "main": [
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å…¨å±€é”™è¯¯å¤„ç†": {
      "main": [
        [
          {
            "node": "å·¥ä½œæµå®Œæˆæ—¥å¿—ä¸ç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "Asia/Shanghai",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "enhanced-news-collection-v2.0.0",
    "lastUpdated": "2025-01-22T13:35:00.000Z",
    "version": "2.0.0",
    "updateDescription": "æ›´æ–°ç«é¸Ÿé—¨æˆ·å‘å¸ƒèŠ‚ç‚¹ï¼Œå¢å¼ºæ•°æ®æ˜ å°„ã€é‡è¯•æœºåˆ¶å’ŒçŠ¶æ€æ£€æŸ¥åŠŸèƒ½"
  },
  "tags": [
    {
      "id": "huoniao",
      "name": "ç«é¸Ÿé—¨æˆ·"
    },
    {
      "id": "news",
      "name": "æ–°é—»é‡‡é›†"
    },
    {
      "id": "firebird-publish",
      "name": "ç«é¸Ÿå‘å¸ƒ"
    },
    {
      "id": "enhanced-v2",
      "name": "å¢å¼ºç‰ˆv2.0"
    }
  ]
}