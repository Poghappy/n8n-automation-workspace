# 自动化新闻工作流部署指南

## 概述

本指南详细说明了如何在不同环境中部署自动化新闻工作流系统，包括开发环境、测试环境和生产环境的配置和部署步骤。

## 目录

1. [环境要求](#环境要求)
2. [预部署准备](#预部署准备)
3. [开发环境部署](#开发环境部署)
4. [测试环境部署](#测试环境部署)
5. [生产环境部署](#生产环境部署)
6. [部署验证](#部署验证)
7. [维护和更新](#维护和更新)
8. [故障排除](#故障排除)

## 环境要求

### 硬件要求

#### 最低配置
- **CPU**: 2核心
- **内存**: 4GB RAM
- **存储**: 20GB 可用空间
- **网络**: 稳定的互联网连接

#### 推荐配置
- **CPU**: 4核心或更多
- **内存**: 8GB RAM或更多
- **存储**: 50GB SSD
- **网络**: 高速稳定连接

#### 生产环境配置
- **CPU**: 8核心或更多
- **内存**: 16GB RAM或更多
- **存储**: 100GB SSD + 备份存储
- **网络**: 冗余网络连接

### 软件要求

#### 必需软件
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / macOS 10.15+
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **Node.js**: 18.0+
- **npm**: 8.0+

#### 可选软件
- **Git**: 版本控制
- **nginx**: 反向代理（生产环境）
- **certbot**: SSL证书管理
- **fail2ban**: 安全防护

### 网络要求

#### 出站连接
- **Notion API**: https://api.notion.com (端口443)
- **OpenAI API**: https://api.openai.com (端口443)
- **火鸟门户**: https://hawaiihub.net (端口443)
- **RSS源**: 各种HTTP/HTTPS端点
- **Docker Hub**: https://registry-1.docker.io (端口443)

#### 入站连接（生产环境）
- **HTTP**: 端口80（重定向到HTTPS）
- **HTTPS**: 端口443
- **SSH**: 端口22（建议修改默认端口）

## 预部署准备

### 1. 获取API凭据

#### Notion API
1. 访问 https://www.notion.so/my-integrations
2. 创建新的集成
3. 获取API令牌
4. 创建数据库并共享给集成

#### OpenAI API
1. 访问 https://platform.openai.com/api-keys
2. 创建新的API密钥
3. 设置使用限制和预算

#### 火鸟门户
1. 登录火鸟门户管理后台
2. 获取有效的PHPSESSID
3. 确认API访问权限

### 2. 环境变量配置

创建 `.env` 文件：

```bash
# 复制模板文件
cp .env.template .env

# 编辑环境变量
nano .env
```

```bash
# .env 文件内容
# ===================

# 基础配置
NODE_ENV=production
LOG_LEVEL=info

# n8n配置
N8N_URL=http://localhost:5678
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your_secure_password_here
N8N_ENCRYPTION_KEY=your_encryption_key_here

# Notion集成
NOTION_API_TOKEN=secret_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NOTION_DATABASE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# OpenAI集成
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_MODEL=gpt-4
OPENAI_MAX_TOKENS=2000

# 火鸟门户集成
HUONIAO_SESSION_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
HUONIAO_API_ENDPOINT=https://hawaiihub.net/include/ajax.php
HUONIAO_AUTO_REFRESH=true

# 监控和告警
WEBHOOK_ALERT_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
ALERT_EMAIL=admin@example.com
SMTP_SERVER=smtp.example.com
SMTP_USERNAME=alerts@example.com
SMTP_PASSWORD=your_smtp_password

# 性能配置
MAX_CONCURRENT_EXECUTIONS=5
EXECUTION_TIMEOUT=300000
RSS_TIMEOUT=30000
API_RETRY_ATTEMPTS=3

# 安全配置
ALLOWED_ORIGINS=https://yourdomain.com
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=100
```

### 3. SSL证书准备（生产环境）

```bash
# 使用Let's Encrypt获取免费SSL证书
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 开发环境部署

### 1. 克隆项目

```bash
# 克隆仓库
git clone <repository-url>
cd automated-news-workflow

# 检查分支
git branch -a
git checkout develop  # 或其他开发分支
```

### 2. 安装依赖

```bash
# 安装Node.js依赖
npm install

# 验证安装
npm audit
npm run test
```

### 3. 配置环境

```bash
# 复制开发环境配置
cp .env.development .env

# 编辑配置文件
nano .env

# 验证配置
node scripts/validate-config.js
```

### 4. 启动服务

```bash
# 启动Docker服务
docker-compose -f docker-compose-n8n.yml up -d

# 检查服务状态
docker-compose -f docker-compose-n8n.yml ps

# 查看日志
docker-compose -f docker-compose-n8n.yml logs -f
```

### 5. 部署工作流

```bash
# 部署到开发环境
node scripts/deploy-automated-news-workflow.js --env=development

# 验证部署
node scripts/run-e2e-integration-tests.js
```

### 6. 访问界面

- **n8n界面**: http://localhost:5678
- **监控仪表板**: http://localhost:8080
- **API文档**: http://localhost:3001/docs

## 测试环境部署

### 1. 环境准备

```bash
# 创建测试环境目录
mkdir -p /opt/newsworkflow-staging
cd /opt/newsworkflow-staging

# 克隆代码
git clone <repository-url> .
git checkout staging
```

### 2. 配置文件

```bash
# 使用测试环境配置
cp .env.staging .env

# 配置测试数据库
cp docker-compose.staging.yml docker-compose.yml

# 编辑配置
nano .env
```

### 3. 部署脚本

```bash
#!/bin/bash
# deploy-staging.sh

set -e

echo "开始部署到测试环境..."

# 停止现有服务
docker-compose down

# 拉取最新代码
git pull origin staging

# 构建和启动服务
docker-compose build --no-cache
docker-compose up -d

# 等待服务启动
sleep 30

# 部署工作流
node scripts/deploy-automated-news-workflow.js --env=staging

# 运行测试
node scripts/run-e2e-integration-tests.js --env=staging

echo "测试环境部署完成"
```

### 4. 执行部署

```bash
# 使脚本可执行
chmod +x deploy-staging.sh

# 执行部署
./deploy-staging.sh

# 检查部署状态
node scripts/check-deployment-status.js --env=staging
```

## 生产环境部署

### 1. 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y docker.io docker-compose nginx certbot python3-certbot-nginx fail2ban

# 启动Docker服务
sudo systemctl enable docker
sudo systemctl start docker

# 添加用户到docker组
sudo usermod -aG docker $USER
```

### 2. 安全配置

```bash
# 配置防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 配置fail2ban
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 修改SSH端口（可选）
sudo nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口
sudo systemctl restart ssh
```

### 3. 应用部署

```bash
# 创建应用目录
sudo mkdir -p /opt/newsworkflow
sudo chown $USER:$USER /opt/newsworkflow
cd /opt/newsworkflow

# 克隆生产代码
git clone <repository-url> .
git checkout main

# 设置权限
chmod +x scripts/*.sh
```

### 4. 生产配置

```bash
# 生产环境配置
cp .env.production .env

# 生成加密密钥
export N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "N8N_ENCRYPTION_KEY=$N8N_ENCRYPTION_KEY" >> .env

# 配置nginx
sudo cp nginx/newsworkflow.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/newsworkflow.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. SSL配置

```bash
# 获取SSL证书
sudo certbot --nginx -d yourdomain.com

# 验证证书
sudo certbot certificates

# 测试自动续期
sudo certbot renew --dry-run
```

### 6. 生产部署脚本

```bash
#!/bin/bash
# deploy-production.sh

set -e

echo "开始生产环境部署..."

# 备份当前版本
if [ -d "backup" ]; then
    rm -rf backup.old
    mv backup backup.old
fi
mkdir backup
cp -r n8n-config backup/
cp .env backup/

# 拉取最新代码
git fetch origin
git checkout main
git pull origin main

# 构建服务
docker-compose -f docker-compose.production.yml build --no-cache

# 停止旧服务
docker-compose -f docker-compose.production.yml down

# 启动新服务
docker-compose -f docker-compose.production.yml up -d

# 等待服务启动
echo "等待服务启动..."
sleep 60

# 健康检查
if ! curl -f http://localhost:5678/rest/active; then
    echo "服务启动失败，开始回滚..."
    docker-compose -f docker-compose.production.yml down
    cp -r backup/* .
    docker-compose -f docker-compose.production.yml up -d
    exit 1
fi

# 部署工作流
node scripts/deploy-automated-news-workflow.js --env=production

# 运行生产验证测试
node scripts/run-production-tests.js

# 清理旧镜像
docker image prune -f

echo "生产环境部署完成"
```

### 7. 系统服务配置

```bash
# 创建systemd服务文件
sudo nano /etc/systemd/system/newsworkflow.service
```

```ini
[Unit]
Description=Automated News Workflow
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/newsworkflow
ExecStart=/usr/local/bin/docker-compose -f docker-compose.production.yml up -d
ExecStop=/usr/local/bin/docker-compose -f docker-compose.production.yml down
TimeoutStartSec=0
User=newsworkflow

[Install]
WantedBy=multi-user.target
```

```bash
# 启用服务
sudo systemctl enable newsworkflow.service
sudo systemctl start newsworkflow.service

# 检查状态
sudo systemctl status newsworkflow.service
```

## 部署验证

### 1. 基础验证

```bash
# 检查服务状态
docker-compose ps

# 检查端口监听
netstat -tlnp | grep -E ':(5678|3001|8080)'

# 检查日志
docker-compose logs --tail=50
```

### 2. 功能验证

```bash
# 运行集成测试
node scripts/run-e2e-integration-tests.js

# 测试API连接
node scripts/test-credentials.js

# 验证工作流执行
node scripts/test-workflow-execution.js
```

### 3. 性能验证

```bash
# 性能基准测试
node scripts/performance-benchmark.js

# 负载测试
node scripts/load-test.js --concurrent=10 --duration=300

# 内存泄漏检测
node scripts/memory-leak-test.js
```

### 4. 安全验证

```bash
# 安全扫描
npm audit
docker scan n8n:latest

# 端口扫描
nmap -sT localhost

# SSL证书验证
openssl s_client -connect yourdomain.com:443 -servername yourdomain.com
```

## 维护和更新

### 1. 定期维护任务

```bash
# 创建维护脚本
cat > maintenance.sh << 'EOF'
#!/bin/bash

echo "开始定期维护..."

# 清理Docker资源
docker system prune -f
docker volume prune -f

# 清理日志文件
find logs/ -name "*.log" -mtime +7 -delete

# 备份配置
tar -czf backups/config-$(date +%Y%m%d).tar.gz n8n-config/

# 更新依赖
npm audit fix

# 重启服务
docker-compose restart

echo "维护完成"
EOF

chmod +x maintenance.sh
```

### 2. 更新流程

```bash
# 创建更新脚本
cat > update.sh << 'EOF'
#!/bin/bash

set -e

echo "开始系统更新..."

# 备份当前版本
./backup.sh

# 拉取更新
git fetch origin
git checkout main
git pull origin main

# 更新依赖
npm install

# 重新部署
./deploy-production.sh

# 验证更新
node scripts/post-update-validation.js

echo "更新完成"
EOF

chmod +x update.sh
```

### 3. 监控和告警

```bash
# 设置监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash

# 检查服务状态
if ! docker-compose ps | grep -q "Up"; then
    echo "服务异常" | mail -s "NewsWorkflow Alert" admin@example.com
fi

# 检查磁盘空间
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    echo "磁盘空间不足: ${DISK_USAGE}%" | mail -s "Disk Space Alert" admin@example.com
fi

# 检查内存使用
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100.0)}')
if [ $MEMORY_USAGE -gt 90 ]; then
    echo "内存使用过高: ${MEMORY_USAGE}%" | mail -s "Memory Alert" admin@example.com
fi
EOF

chmod +x monitor.sh

# 添加到crontab
crontab -e
# 添加：*/5 * * * * /opt/newsworkflow/monitor.sh
```

## 故障排除

### 常见部署问题

#### 1. Docker服务启动失败

```bash
# 检查Docker状态
sudo systemctl status docker

# 重启Docker服务
sudo systemctl restart docker

# 检查Docker日志
sudo journalctl -u docker.service
```

#### 2. 端口冲突

```bash
# 检查端口占用
sudo netstat -tlnp | grep :5678

# 杀死占用进程
sudo kill -9 <PID>

# 修改端口配置
nano docker-compose.yml
```

#### 3. 权限问题

```bash
# 修复文件权限
sudo chown -R $USER:$USER /opt/newsworkflow
chmod +x scripts/*.sh

# 修复Docker权限
sudo usermod -aG docker $USER
newgrp docker
```

#### 4. 内存不足

```bash
# 检查内存使用
free -h
docker stats

# 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 回滚程序

```bash
#!/bin/bash
# rollback.sh

set -e

echo "开始回滚..."

# 停止当前服务
docker-compose down

# 恢复备份
if [ -d "backup" ]; then
    cp -r backup/* .
    echo "配置已恢复"
else
    echo "未找到备份文件"
    exit 1
fi

# 启动服务
docker-compose up -d

# 验证回滚
sleep 30
if curl -f http://localhost:5678/rest/active; then
    echo "回滚成功"
else
    echo "回滚失败"
    exit 1
fi
```

## 最佳实践

### 1. 安全最佳实践

- 定期更新系统和依赖包
- 使用强密码和密钥
- 启用防火墙和入侵检测
- 定期备份重要数据
- 监控异常活动

### 2. 性能最佳实践

- 合理配置资源限制
- 定期清理日志和缓存
- 监控系统资源使用
- 优化工作流配置
- 使用CDN加速静态资源

### 3. 运维最佳实践

- 建立完整的监控体系
- 制定详细的应急预案
- 定期进行灾难恢复演练
- 保持文档更新
- 建立变更管理流程

---

## 支持和联系

如果在部署过程中遇到问题，请：

1. 查看相关日志文件
2. 运行诊断脚本
3. 参考故障排除指南
4. 联系技术支持团队

**技术支持邮箱**: support@newsworkflow.com
**紧急联系电话**: +1-xxx-xxx-xxxx
**文档更新**: https://docs.newsworkflow.com

---

*最后更新: 2025年1月*