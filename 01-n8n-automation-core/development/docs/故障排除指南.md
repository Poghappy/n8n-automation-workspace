# 自动化新闻工作流故障排除指南

## 目录

1. [快速诊断](#快速诊断)
2. [常见问题](#常见问题)
3. [错误代码参考](#错误代码参考)
4. [系统诊断工具](#系统诊断工具)
5. [紧急恢复程序](#紧急恢复程序)
6. [性能问题](#性能问题)
7. [预防措施](#预防措施)

## 快速诊断

### 系统健康检查

运行以下命令进行快速系统诊断：

```bash
# 检查所有服务状态
docker-compose -f docker-compose-n8n.yml ps

# 检查工作流状态
curl -u admin:password http://localhost:5678/rest/workflows

# 运行集成测试
node scripts/run-e2e-integration-tests.js --quick

# 检查关键指标
node scripts/test-performance-optimization.js --health-check
```

### 快速修复清单

- [ ] 检查Docker服务是否运行
- [ ] 验证环境变量是否正确设置
- [ ] 确认API凭据是否有效
- [ ] 检查网络连接是否正常
- [ ] 查看最近的错误日志

## 常见问题

### 1. 工作流无法启动

#### 症状
- n8n界面显示工作流为"inactive"状态
- 手动触发工作流无响应
- 定时触发器不工作

#### 可能原因
1. n8n服务未正常启动
2. 工作流配置错误
3. 凭据验证失败
4. 资源不足

#### 解决步骤

**步骤1: 检查n8n服务状态**
```bash
# 检查容器状态
docker-compose -f docker-compose-n8n.yml ps

# 查看n8n日志
docker-compose -f docker-compose-n8n.yml logs n8n

# 重启n8n服务
docker-compose -f docker-compose-n8n.yml restart n8n
```

**步骤2: 验证工作流配置**
```bash
# 检查工作流语法
node scripts/validate-workflow.js

# 重新部署工作流
node scripts/deploy-automated-news-workflow.js --env=development --force
```

**步骤3: 检查凭据**
```bash
# 测试所有API连接
node scripts/test-credentials.js

# 更新过期凭据
node scripts/setup-credentials.js
```

### 2. RSS源采集失败

#### 症状
- 工作流执行但无新内容
- RSS节点报错"连接超时"
- 部分RSS源无法访问

#### 诊断命令
```bash
# 测试RSS源连接
curl -I "https://www.theneuron.ai/feed"
curl -I "https://www.futurepedia.io/rss"

# 检查DNS解析
nslookup www.theneuron.ai
nslookup www.futurepedia.io

# 测试网络连接
ping -c 4 www.theneuron.ai
```

#### 解决方案

**方案1: 更新RSS源配置**
```bash
# 检查RSS源状态
node scripts/validate-rss-sources.js

# 更新RSS源列表
node scripts/update-rss-sources.js --check-all
```

**方案2: 调整网络设置**
```bash
# 增加超时时间
export RSS_TIMEOUT=60000

# 使用代理（如果需要）
export HTTP_PROXY=http://proxy.example.com:8080
```

**方案3: 添加备用源**
```javascript
// 在工作流配置中添加备用RSS源
const backupSources = [
  "https://feeds.feedburner.com/oreilly/radar",
  "https://techcrunch.com/feed/"
];
```

### 3. AI内容处理错误

#### 症状
- OpenAI API调用失败
- 内容质量评估返回错误
- AI处理节点超时

#### 诊断步骤
```bash
# 测试OpenAI API连接
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models

# 检查API配额
node scripts/check-openai-quota.js

# 测试AI处理功能
node scripts/test-ai-processing.js --sample
```

#### 解决方案

**API密钥问题**
```bash
# 验证API密钥格式
echo $OPENAI_API_KEY | grep -E '^sk-[a-zA-Z0-9]{48}$'

# 更新API密钥
export OPENAI_API_KEY=sk-your-new-api-key
node scripts/setup-credentials.js
```

**配额限制问题**
```bash
# 检查当前使用情况
node scripts/check-api-usage.js

# 实施速率限制
export OPENAI_RATE_LIMIT=10  # 每分钟10次请求
```

**超时问题**
```bash
# 增加超时时间
export AI_PROCESSING_TIMEOUT=120000  # 2分钟

# 启用批处理模式
export AI_BATCH_SIZE=5
```

### 4. Notion存储失败

#### 症状
- 内容无法写入Notion数据库
- Notion API返回403错误
- 数据格式验证失败

#### 诊断命令
```bash
# 测试Notion API连接
curl -H "Authorization: Bearer $NOTION_API_TOKEN" \
     -H "Notion-Version: 2022-06-28" \
     https://api.notion.com/v1/databases/$NOTION_DATABASE_ID

# 验证数据库权限
node scripts/test-notion-permissions.js

# 检查数据库结构
node scripts/verify-notion-database.js
```

#### 解决方案

**权限问题**
```bash
# 重新授权Notion集成
node scripts/setup-notion.js --reauth

# 检查数据库共享设置
node scripts/check-notion-permissions.js
```

**数据格式问题**
```bash
# 验证数据映射
node scripts/validate-notion-mapping.js

# 重新创建数据库结构
node scripts/create-notion-database.js --recreate
```

**API限制问题**
```bash
# 实施请求限制
export NOTION_RATE_LIMIT=3  # 每秒3次请求

# 启用重试机制
export NOTION_RETRY_ATTEMPTS=5
export NOTION_RETRY_DELAY=2000
```

### 5. 火鸟门户发布失败

#### 症状
- API返回state=200（失败）
- 会话过期错误
- 数据映射错误

#### 诊断步骤
```bash
# 测试火鸟API连接
node scripts/validate-huoniao-api.js

# 检查会话状态
curl -H "Cookie: PHPSESSID=$HUONIAO_SESSION_ID" \
     -X POST \
     -d "service=article&action=test" \
     https://hawaiihub.net/include/ajax.php

# 验证数据映射
node scripts/test-firebird-mapping.js
```

#### 解决方案

**会话过期**
```bash
# 更新会话ID
node scripts/setup-huoniao-cookies.js

# 自动会话刷新
export HUONIAO_AUTO_REFRESH=true
export HUONIAO_SESSION_CHECK_INTERVAL=3600000  # 1小时
```

**API参数错误**
```bash
# 验证API参数格式
node scripts/validate-api-parameters.js

# 更新API映射配置
node scripts/update-firebird-mapping.js
```

**权限问题**
```bash
# 检查用户权限
node scripts/check-huoniao-permissions.js

# 使用管理员账户
export HUONIAO_ADMIN_MODE=true
```

## 错误代码参考

### 系统错误代码

| 代码 | 类型 | 描述 | 解决方案 |
|------|------|------|----------|
| E001 | 网络 | RSS源连接超时 | 检查网络连接，增加超时时间 |
| E002 | API | OpenAI API调用失败 | 验证API密钥，检查配额 |
| E003 | 存储 | Notion写入失败 | 检查权限，验证数据格式 |
| E004 | 发布 | 火鸟API调用失败 | 更新会话，检查参数 |
| E005 | 系统 | 内存不足 | 重启服务，增加内存 |
| E006 | 认证 | 凭据验证失败 | 更新API凭据 |
| E007 | 配置 | 工作流配置错误 | 检查配置文件语法 |
| E008 | 数据 | 数据格式验证失败 | 检查数据映射规则 |

### HTTP状态码

| 状态码 | 含义 | 常见原因 | 解决方案 |
|--------|------|----------|----------|
| 401 | 未授权 | API密钥无效 | 更新凭据 |
| 403 | 禁止访问 | 权限不足 | 检查权限设置 |
| 404 | 未找到 | 资源不存在 | 验证URL和ID |
| 429 | 请求过多 | 超出速率限制 | 实施速率控制 |
| 500 | 服务器错误 | 服务器内部错误 | 检查服务状态 |
| 502 | 网关错误 | 上游服务不可用 | 检查依赖服务 |
| 503 | 服务不可用 | 服务维护中 | 等待服务恢复 |
| 504 | 网关超时 | 请求超时 | 增加超时时间 |

## 系统诊断工具

### 内置诊断脚本

```bash
# 全面系统诊断
node scripts/system-diagnostics.js

# 网络连接测试
node scripts/test-network-connectivity.js

# 性能基准测试
node scripts/performance-benchmark.js

# 数据一致性检查
node scripts/data-consistency-check.js
```

### 日志分析工具

```bash
# 分析错误模式
node scripts/analyze-error-patterns.js --days=7

# 生成性能报告
node scripts/generate-performance-report.js --period=24h

# 检查异常活动
node scripts/detect-anomalies.js --threshold=2
```

### 监控命令

```bash
# 实时监控工作流执行
watch -n 5 'curl -s -u admin:password http://localhost:5678/rest/executions?limit=5'

# 监控系统资源
watch -n 2 'docker stats --no-stream'

# 监控API响应时间
watch -n 10 'node scripts/test-api-response-times.js'
```

## 紧急恢复程序

### 服务完全停止

```bash
# 1. 紧急重启所有服务
docker-compose -f docker-compose-n8n.yml down
docker system prune -f
docker-compose -f docker-compose-n8n.yml up -d

# 2. 验证服务状态
docker-compose -f docker-compose-n8n.yml ps
curl -u admin:password http://localhost:5678/rest/active

# 3. 重新部署工作流
node scripts/deploy-automated-news-workflow.js --env=production --force
```

### 数据损坏恢复

```bash
# 1. 停止所有工作流
curl -X POST -u admin:password http://localhost:5678/rest/workflows/deactivate-all

# 2. 从备份恢复数据
node scripts/restore-from-backup.js --backup=latest

# 3. 验证数据完整性
node scripts/validate-data-integrity.js

# 4. 重新激活工作流
curl -X POST -u admin:password http://localhost:5678/rest/workflows/activate-all
```

### 配置回滚

```bash
# 1. 回滚到上一个稳定版本
node scripts/rollback-configuration.js --version=stable

# 2. 重新加载配置
docker-compose -f docker-compose-n8n.yml restart

# 3. 验证回滚结果
node scripts/validate-rollback.js
```

## 性能问题

### 内存使用过高

#### 症状
- Docker容器内存使用率>90%
- 工作流执行缓慢
- 系统响应延迟

#### 解决方案
```bash
# 1. 检查内存使用情况
docker stats --no-stream

# 2. 清理缓存
docker system prune -f
docker volume prune -f

# 3. 调整内存限制
# 在docker-compose.yml中设置
services:
  n8n:
    mem_limit: 2g
    memswap_limit: 2g

# 4. 优化工作流
node scripts/optimize-workflow-memory.js
```

### CPU使用率过高

#### 症状
- CPU使用率持续>80%
- 工作流执行队列堆积
- 响应时间增加

#### 解决方案
```bash
# 1. 识别CPU密集型进程
docker exec n8n top -p 1

# 2. 调整并发设置
export N8N_EXECUTIONS_PROCESS=own
export N8N_EXECUTIONS_MODE=queue

# 3. 限制并发执行数
export MAX_CONCURRENT_EXECUTIONS=3

# 4. 优化AI处理
export AI_BATCH_PROCESSING=true
export AI_PROCESSING_DELAY=1000
```

### 磁盘空间不足

#### 症状
- 磁盘使用率>90%
- 日志写入失败
- 数据库操作错误

#### 解决方案
```bash
# 1. 检查磁盘使用情况
df -h
du -sh logs/
du -sh backups/

# 2. 清理旧日志
find logs/ -name "*.log" -mtime +7 -delete
find backups/ -name "*.tar.gz" -mtime +30 -delete

# 3. 压缩归档
tar -czf logs/archive-$(date +%Y%m%d).tar.gz logs/*.log
rm logs/*.log

# 4. 配置日志轮转
node scripts/setup-log-rotation.js
```

## 预防措施

### 定期维护任务

#### 每日检查
```bash
#!/bin/bash
# daily-maintenance.sh

# 检查服务状态
docker-compose -f docker-compose-n8n.yml ps

# 检查磁盘空间
df -h | grep -E '9[0-9]%'

# 检查错误日志
grep -i error logs/workflow-execution-$(date +%Y-%m-%d).log

# 测试关键功能
node scripts/health-check.js
```

#### 每周维护
```bash
#!/bin/bash
# weekly-maintenance.sh

# 清理旧日志
find logs/ -name "*.log" -mtime +7 -delete

# 备份配置
tar -czf backups/config-backup-$(date +%Y%m%d).tar.gz n8n-config/

# 更新依赖
npm audit fix

# 性能分析
node scripts/weekly-performance-report.js
```

#### 每月维护
```bash
#!/bin/bash
# monthly-maintenance.sh

# 系统更新
docker-compose -f docker-compose-n8n.yml pull
docker-compose -f docker-compose-n8n.yml up -d

# 安全扫描
npm audit
docker scan n8n:latest

# 容量规划
node scripts/capacity-planning-report.js

# 备份验证
node scripts/verify-backups.js
```

### 监控告警设置

#### 关键指标阈值
```json
{
  "alerts": {
    "memory_usage": "> 85%",
    "cpu_usage": "> 80%",
    "disk_usage": "> 90%",
    "error_rate": "> 2%",
    "response_time": "> 5000ms",
    "workflow_failure_rate": "> 5%"
  }
}
```

#### 告警通知配置
```bash
# 设置Webhook告警
export ALERT_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

# 设置邮件告警
export ALERT_EMAIL="admin@example.com"
export SMTP_SERVER="smtp.example.com"

# 启用告警
node scripts/setup-alerting.js
```

### 备份策略

#### 自动备份配置
```bash
# 设置定时备份
crontab -e

# 每日备份配置文件
0 2 * * * /path/to/backup-config.sh

# 每周备份数据
0 3 * * 0 /path/to/backup-data.sh

# 每月完整备份
0 4 1 * * /path/to/full-backup.sh
```

#### 备份验证
```bash
# 验证备份完整性
node scripts/verify-backup-integrity.js --backup=latest

# 测试恢复过程
node scripts/test-restore-process.js --dry-run
```

---

## 获取帮助

如果本指南无法解决您的问题，请：

1. **查看详细日志**: 检查 `logs/` 目录下的相关日志文件
2. **运行诊断脚本**: 使用内置的诊断工具收集系统信息
3. **检查系统状态**: 确认所有依赖服务正常运行
4. **联系技术支持**: 提供详细的错误信息和系统环境

### 问题报告模板

```
**问题描述**:
[简要描述遇到的问题]

**环境信息**:
- 操作系统: 
- Docker版本: 
- n8n版本: 
- Node.js版本: 

**重现步骤**:
1. 
2. 
3. 

**错误日志**:
[粘贴相关的错误日志]

**已尝试的解决方案**:
[列出已经尝试过的解决方法]
```

---

*最后更新: 2025年1月*