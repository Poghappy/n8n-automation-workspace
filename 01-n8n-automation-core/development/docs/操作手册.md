# 自动化新闻工作流操作手册

## 目录

1. [系统概述](#系统概述)
2. [部署指南](#部署指南)
3. [日常操作](#日常操作)
4. [监控和维护](#监控和维护)
5. [故障排除](#故障排除)
6. [API参考](#api参考)
7. [最佳实践](#最佳实践)

## 系统概述

### 架构组件

自动化新闻工作流系统由以下核心组件组成：

- **n8n工作流引擎**: 核心自动化平台
- **内容采集模块**: 从多个RSS源和API采集新闻
- **AI智能处理**: 内容质量评估和去重
- **Notion存储**: 中间数据存储和管理
- **火鸟门户发布**: 自动发布到门户网站
- **监控系统**: 日志记录和性能监控

### 数据流程

```
RSS源/API → 内容采集 → AI处理 → Notion存储 → 火鸟发布 → 监控日志
```

## 部署指南

### 环境要求

#### 系统要求
- Node.js 18+ 
- Docker 20+
- 内存: 最少4GB，推荐8GB
- 存储: 最少20GB可用空间

#### 必要的环境变量

```bash
# Notion集成
NOTION_API_TOKEN=secret_xxxxxxxxxxxx
NOTION_DATABASE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# 火鸟门户
HUONIAO_SESSION_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
HUONIAO_API_ENDPOINT=https://hawaiihub.net/include/ajax.php

# AI服务
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# n8n配置
N8N_URL=http://localhost:5678
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your_secure_password

# 监控配置
WEBHOOK_ALERT_URL=https://your-webhook-url.com/alerts
```

### 部署步骤

#### 1. 环境准备

```bash
# 克隆项目
git clone <repository-url>
cd automated-news-workflow

# 安装依赖
npm install

# 复制环境变量模板
cp .env.template .env
# 编辑 .env 文件，填入实际的API密钥和配置
```

#### 2. 启动n8n服务

```bash
# 使用Docker Compose启动
docker-compose -f docker-compose-n8n.yml up -d

# 验证服务状态
docker-compose -f docker-compose-n8n.yml ps
```

#### 3. 执行部署脚本

```bash
# 开发环境部署
node scripts/deploy-automated-news-workflow.js --env=development

# 生产环境部署
node scripts/deploy-automated-news-workflow.js --env=production
```

#### 4. 验证部署

```bash
# 运行集成测试
node scripts/run-e2e-integration-tests.js

# 检查工作流状态
curl -u admin:password http://localhost:5678/rest/workflows
```

## 日常操作

### 启动和停止服务

#### 启动服务
```bash
# 启动所有服务
docker-compose -f docker-compose-n8n.yml up -d

# 检查服务状态
docker-compose -f docker-compose-n8n.yml ps
```

#### 停止服务
```bash
# 停止所有服务
docker-compose -f docker-compose-n8n.yml down

# 停止并清理数据（谨慎使用）
docker-compose -f docker-compose-n8n.yml down -v
```

### 工作流管理

#### 查看工作流状态
```bash
# 通过API查看所有工作流
curl -u admin:password http://localhost:5678/rest/workflows

# 查看特定工作流执行历史
curl -u admin:password http://localhost:5678/rest/executions?workflowId=<workflow-id>
```

#### 手动触发工作流
```bash
# 手动执行新闻采集工作流
curl -X POST -u admin:password \
  http://localhost:5678/rest/workflows/<workflow-id>/execute
```

#### 暂停和恢复工作流
```bash
# 暂停工作流
curl -X POST -u admin:password \
  http://localhost:5678/rest/workflows/<workflow-id>/deactivate

# 恢复工作流
curl -X POST -u admin:password \
  http://localhost:5678/rest/workflows/<workflow-id>/activate
```

### 凭据管理

#### 更新API凭据
```bash
# 更新Notion API令牌
curl -X PATCH -u admin:password \
  -H "Content-Type: application/json" \
  -d '{"data":{"apiKey":"new_token"}}' \
  http://localhost:5678/rest/credentials/<credential-id>
```

#### 验证凭据连接
```bash
# 测试Notion连接
node scripts/test-notion-integration.js

# 测试火鸟门户连接
node scripts/validate-huoniao-api.js

# 测试OpenAI连接
node scripts/test-credentials.js
```

## 监控和维护

### 日志管理

#### 查看实时日志
```bash
# n8n服务日志
docker-compose -f docker-compose-n8n.yml logs -f n8n

# 工作流执行日志
tail -f logs/workflow-execution-*.log
```

#### 日志文件位置
- 工作流执行日志: `logs/workflow-execution-YYYY-MM-DD.log`
- 错误日志: `logs/error-YYYY-MM-DD.log`
- 性能日志: `logs/performance-YYYY-MM-DD.log`
- 部署日志: `logs/deployment-report-*.json`

### 性能监控

#### 关键指标监控

```bash
# 检查系统性能指标
node scripts/test-performance-optimization.js

# 生成性能报告
node scripts/workflow-monitoring.js --report
```

#### 监控仪表板

访问监控仪表板: `http://localhost:5678/workflows`

关键监控指标：
- **采集成功率**: ≥95%
- **处理时间**: ≤5分钟
- **发布成功率**: ≥98%
- **系统正常运行时间**: ≥99.5%

### 数据库维护

#### Notion数据库清理
```bash
# 清理过期数据（保留30天）
node scripts/cleanup-notion-data.js --days=30

# 备份Notion数据
node scripts/backup-notion-database.js
```

#### 日志清理
```bash
# 清理旧日志文件（保留7天）
find logs/ -name "*.log" -mtime +7 -delete

# 压缩归档日志
tar -czf logs/archive-$(date +%Y%m%d).tar.gz logs/*.log
```

## 故障排除

### 常见问题和解决方案

#### 1. 工作流执行失败

**症状**: 工作流状态显示为"error"或"failed"

**诊断步骤**:
```bash
# 查看最近的执行日志
curl -u admin:password http://localhost:5678/rest/executions?limit=10

# 检查特定执行的详细错误
curl -u admin:password http://localhost:5678/rest/executions/<execution-id>
```

**常见原因和解决方案**:

- **API凭据过期**
  ```bash
  # 更新凭据
  node scripts/setup-credentials.js
  # 重新测试连接
  node scripts/test-credentials.js
  ```

- **网络连接问题**
  ```bash
  # 测试外部API连接
  curl -I https://api.notion.com/v1/databases
  curl -I https://hawaiihub.net/include/ajax.php
  ```

- **内存不足**
  ```bash
  # 检查系统资源
  docker stats
  # 重启服务释放内存
  docker-compose -f docker-compose-n8n.yml restart
  ```

#### 2. 内容采集问题

**症状**: RSS源无法获取内容或内容格式错误

**诊断步骤**:
```bash
# 测试RSS源连接
curl -I "https://www.theneuron.ai/feed"

# 检查内容处理日志
grep "content processing" logs/workflow-execution-*.log
```

**解决方案**:
```bash
# 更新RSS源配置
node scripts/update-rss-sources.js

# 重新生成测试数据
node scripts/generate-test-data.js
```

#### 3. Notion存储失败

**症状**: 内容无法写入Notion数据库

**诊断步骤**:
```bash
# 测试Notion API连接
node scripts/test-notion-integration.js

# 检查数据库权限
curl -H "Authorization: Bearer $NOTION_API_TOKEN" \
     -H "Notion-Version: 2022-06-28" \
     https://api.notion.com/v1/databases/$NOTION_DATABASE_ID
```

**解决方案**:
```bash
# 重新配置Notion集成
node scripts/setup-notion.js

# 验证数据库结构
node scripts/verify-notion-database.js
```

#### 4. 火鸟门户发布失败

**症状**: 内容无法发布到火鸟门户

**诊断步骤**:
```bash
# 测试火鸟API连接
node scripts/validate-huoniao-api.js

# 检查会话状态
curl -H "Cookie: PHPSESSID=$HUONIAO_SESSION_ID" \
     https://hawaiihub.net/include/ajax.php
```

**解决方案**:
```bash
# 更新会话ID
node scripts/setup-huoniao-cookies.js

# 重新测试API
node scripts/test-firebird-api-real.js
```

### 错误代码参考

| 错误代码 | 描述 | 解决方案 |
|---------|------|----------|
| E001 | RSS源连接超时 | 检查网络连接，增加超时时间 |
| E002 | AI API调用失败 | 验证OpenAI API密钥 |
| E003 | Notion写入失败 | 检查API权限和数据库配置 |
| E004 | 火鸟发布失败 | 更新会话ID，检查API参数 |
| E005 | 内存不足 | 重启服务，增加内存分配 |
| E006 | 凭据验证失败 | 更新过期的API凭据 |

### 紧急恢复程序

#### 1. 服务完全停止
```bash
# 紧急重启所有服务
docker-compose -f docker-compose-n8n.yml down
docker-compose -f docker-compose-n8n.yml up -d

# 验证服务状态
docker-compose -f docker-compose-n8n.yml ps
```

#### 2. 数据恢复
```bash
# 从备份恢复Notion数据
node scripts/restore-notion-backup.js --backup=<backup-file>

# 恢复工作流配置
node scripts/restore-workflow-config.js --backup=<backup-dir>
```

#### 3. 回滚部署
```bash
# 回滚到上一个稳定版本
node scripts/rollback-deployment.js --version=<previous-version>
```

## API参考

### n8n REST API

#### 工作流管理
```bash
# 获取所有工作流
GET /rest/workflows

# 获取特定工作流
GET /rest/workflows/{id}

# 执行工作流
POST /rest/workflows/{id}/execute

# 激活/停用工作流
POST /rest/workflows/{id}/activate
POST /rest/workflows/{id}/deactivate
```

#### 执行历史
```bash
# 获取执行历史
GET /rest/executions?workflowId={id}&limit={limit}

# 获取执行详情
GET /rest/executions/{executionId}
```

### 火鸟门户API

#### 新闻发布
```bash
POST https://hawaiihub.net/include/ajax.php
Content-Type: application/x-www-form-urlencoded
Cookie: PHPSESSID={session_id}

service=article&action=put&title={title}&typeid={type}&body={content}
```

#### 响应格式
```json
{
  "state": 100,  // 100=成功, 101=错误, 200=失败
  "info": "文章ID或错误信息"
}
```

### Notion API

#### 数据库查询
```bash
POST https://api.notion.com/v1/databases/{database_id}/query
Authorization: Bearer {token}
Notion-Version: 2022-06-28
```

#### 页面创建
```bash
POST https://api.notion.com/v1/pages
Authorization: Bearer {token}
Notion-Version: 2022-06-28
```

## 最佳实践

### 安全最佳实践

1. **凭据管理**
   - 定期轮换API密钥
   - 使用环境变量存储敏感信息
   - 启用n8n基础认证

2. **网络安全**
   - 使用HTTPS进行所有API调用
   - 实施IP白名单（生产环境）
   - 定期更新依赖包

3. **访问控制**
   - 限制n8n管理界面访问
   - 使用最小权限原则
   - 定期审核用户权限

### 性能优化

1. **资源管理**
   - 监控内存使用情况
   - 设置合理的超时时间
   - 实施请求限流

2. **数据处理**
   - 批量处理内容
   - 使用缓存减少API调用
   - 定期清理历史数据

3. **监控告警**
   - 设置关键指标阈值
   - 配置自动告警通知
   - 定期检查系统健康状态

### 维护计划

#### 日常维护（每日）
- [ ] 检查工作流执行状态
- [ ] 查看错误日志
- [ ] 验证关键指标

#### 周度维护（每周）
- [ ] 清理旧日志文件
- [ ] 检查系统资源使用
- [ ] 更新RSS源配置
- [ ] 备份重要数据

#### 月度维护（每月）
- [ ] 更新系统依赖
- [ ] 审核API凭据
- [ ] 性能优化分析
- [ ] 安全漏洞扫描

#### 季度维护（每季度）
- [ ] 系统架构评估
- [ ] 容量规划
- [ ] 灾难恢复测试
- [ ] 文档更新

---

## 联系支持

如果遇到无法解决的问题，请联系技术支持：

- **技术文档**: 查看项目README和设计文档
- **日志分析**: 提供相关的错误日志
- **系统信息**: 包含环境配置和版本信息

---

*最后更新: 2025年1月*